<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finances - Homestead Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@300;400;600&family=Karla:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --sage-50: #f6f7f3;
            --sage-100: #e8ebe0;
            --sage-200: #d4dac5;
            --sage-300: #b8c5a3;
            --sage-400: #98ab7e;
            --sage-500: #7a9061;
            --sage-600: #5f734c;
            --sage-700: #4a5a3b;
            --sage-800: #3d4a32;
            --cream: #ece8dd;
            --taupe: #c4b5a4;
            --dusty-sage: #a4ac95;
            --mauve: #a88479;
            --charcoal: #4a4d47;
            --dusty-rose: #9b7269;
            --red-soft: #c0392b;
            --green-soft: #27ae60;
        }

        body {
            font-family: 'Karla', sans-serif;
            background: var(--charcoal);
            min-height: 100vh;
            color: var(--cream);
        }

        .top-bar {
            background: rgba(61, 74, 50, 0.9);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--sage-700);
        }
        .top-bar a { color: var(--sage-200); text-decoration: none; font-size: 0.9rem; }
        .top-bar a:hover { color: var(--cream); }
        .top-bar h1 { font-family: 'Crimson Pro', serif; font-size: 1.4rem; font-weight: 400; color: var(--cream); }

        .tab-bar { display: flex; gap: 0; background: rgba(74, 90, 59, 0.5); overflow-x: auto; }
        .tab-btn {
            padding: 14px 24px; background: none; border: none; color: var(--sage-200);
            font-family: 'Karla', sans-serif; font-size: 0.95rem; font-weight: 500;
            cursor: pointer; border-bottom: 3px solid transparent; white-space: nowrap; transition: all 0.2s;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.05); color: var(--cream); }
        .tab-btn.active { color: var(--cream); border-bottom-color: var(--sage-400); background: rgba(255,255,255,0.08); }

        .main-content { max-width: 1200px; margin: 0 auto; padding: 24px 20px; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        .card {
            background: rgba(236, 232, 221, 0.95); border-radius: 12px; padding: 24px;
            margin-bottom: 20px; color: var(--charcoal); box-shadow: 0 4px 16px rgba(0,0,0,0.25);
        }
        .card h2 { font-family: 'Crimson Pro', serif; font-size: 1.5rem; font-weight: 600; color: var(--sage-700); margin-bottom: 16px; }

        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 12px; }
        .form-group { display: flex; flex-direction: column; gap: 4px; }
        .form-group label { font-size: 0.8rem; font-weight: 600; color: var(--sage-600); text-transform: uppercase; letter-spacing: 0.5px; }
        .form-group input, .form-group select {
            padding: 10px 12px; border: 1px solid var(--sage-200); border-radius: 8px;
            font-family: 'Karla', sans-serif; font-size: 0.95rem; background: white; color: var(--charcoal);
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--sage-500); box-shadow: 0 0 0 3px rgba(122, 144, 97, 0.15); }

        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-family: 'Karla', sans-serif; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--sage-500); color: white; }
        .btn-primary:hover { background: var(--sage-600); }
        .btn-secondary { background: var(--taupe); color: white; }
        .btn-secondary:hover { background: var(--mauve); }
        .btn-danger { background: var(--dusty-rose); color: white; }
        .btn-danger:hover { background: var(--red-soft); }
        .btn-small { padding: 6px 12px; font-size: 0.8rem; }
        .btn-row { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }

        .data-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .data-table th { background: var(--sage-600); color: white; padding: 10px 12px; text-align: left; font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; }
        .data-table td { padding: 10px 12px; border-bottom: 1px solid var(--sage-100); }
        .data-table tr:hover { background: rgba(122, 144, 97, 0.08); }
        .data-table .amount { text-align: right; font-variant-numeric: tabular-nums; }
        .data-table .negative { color: var(--red-soft); }
        .data-table .positive { color: var(--green-soft); }

        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .summary-box { background: var(--sage-700); border-radius: 10px; padding: 16px; text-align: center; color: var(--cream); }
        .summary-box .label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--sage-200); margin-bottom: 6px; }
        .summary-box .value { font-family: 'Crimson Pro', serif; font-size: 1.6rem; font-weight: 600; }
        .summary-box .value.positive { color: #6dd59a; }
        .summary-box .value.negative { color: #e88; }
        .summary-box.highlight { background: var(--sage-500); border: 2px solid var(--sage-300); }

        .check-paid { width: 20px; height: 20px; cursor: pointer; accent-color: var(--sage-500); }
        .badge { display: inline-block; padding: 3px 10px; border-radius: 10px; font-size: 0.75rem; font-weight: 600; }
        .badge-paid { background: rgba(39, 174, 96, 0.15); color: var(--green-soft); }
        .badge-auto { background: rgba(122, 144, 97, 0.15); color: var(--sage-600); }
        .badge-variable { background: rgba(168, 132, 121, 0.15); color: var(--mauve); }

        .entry-row { display: grid; grid-template-columns: 1.5fr 120px 120px 120px; gap: 8px; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--sage-100); }
        .entry-row.header { font-size: 0.8rem; font-weight: 600; color: var(--sage-600); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid var(--sage-300); padding-bottom: 10px; }
        .entry-row label { font-weight: 500; color: var(--charcoal); }
        .entry-row .rate { font-size: 0.8rem; color: var(--sage-400); }
        .entry-row input {
            padding: 8px 10px; border: 1px solid var(--sage-200); border-radius: 8px;
            font-family: 'Karla', sans-serif; font-size: 0.95rem; text-align: right; background: white; color: var(--charcoal); width: 100%;
        }
        .entry-row input:focus { outline: none; border-color: var(--sage-500); box-shadow: 0 0 0 3px rgba(122, 144, 97, 0.15); }
        .entry-row .calc { text-align: right; font-variant-numeric: tabular-nums; font-weight: 500; padding-right: 12px; }
        .section-divider { font-family: 'Crimson Pro', serif; font-size: 1.1rem; color: var(--sage-600); padding: 16px 0 6px; border-bottom: 2px solid var(--sage-300); margin-top: 8px; }

        .month-selector { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
        .month-selector button { background: var(--sage-600); color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 1.1rem; }
        .month-selector button:hover { background: var(--sage-700); }
        .month-selector .current-month { font-family: 'Crimson Pro', serif; font-size: 1.3rem; color: var(--charcoal); min-width: 160px; text-align: center; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--cream); border-radius: 12px; padding: 28px; max-width: 500px; width: 90%; color: var(--charcoal); box-shadow: 0 8px 40px rgba(0,0,0,0.4); }
        .modal h2 { font-family: 'Crimson Pro', serif; color: var(--sage-700); margin-bottom: 16px; }

        .table-scroll { overflow-x: auto; }
        .empty-state { text-align: center; padding: 40px; color: var(--sage-600); }
        .empty-state .icon { font-size: 3rem; margin-bottom: 12px; }

        #column-picker label:hover { background: var(--sage-100); border-radius: 4px; padding: 2px 4px; margin: -2px -4px; }

        @media (max-width: 768px) {
            .tab-btn { padding: 12px 16px; font-size: 0.85rem; }
            .form-row { grid-template-columns: 1fr; }
            .summary-grid { grid-template-columns: 1fr 1fr; }
            .card { padding: 16px; }
            .entry-row { grid-template-columns: 1fr 90px 90px 90px; gap: 4px; }
            .entry-row input { padding: 6px 8px; font-size: 0.85rem; }
            .data-table { font-size: 0.8rem; }
            .data-table th, .data-table td { padding: 8px 6px; }
        }
    </style>
</head>
<body>

<div class="top-bar">
    <a href="index.html">‚Üê Back to Hub</a>
    <h1>üìä Finances</h1>
    <div></div>
</div>

<div class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('accounts')">Accounts</button>
    <button class="tab-btn" onclick="switchTab('bills')">Bills</button>
    <button class="tab-btn" onclick="switchTab('weekly')">Weekly Entry</button>
    <button class="tab-btn" onclick="switchTab('history')">History</button>
</div>

<div class="main-content">

    <!-- ==================== ACCOUNTS ==================== -->
    <div id="tab-accounts" class="tab-panel active">
        <div class="card">
            <h2>‚ûï Add Account</h2>
            <div class="form-row">
                <div class="form-group"><label>Account Name</label><input type="text" id="acc-name" placeholder="e.g. Family CC"></div>
                <div class="form-group"><label>Type</label>
                    <select id="acc-type">
                        <option value="credit_card">Credit Card</option>
                        <option value="loan">Loan</option>
                        <option value="bank">Bank Account</option>
                        <option value="tax_debt">Tax Debt</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group"><label>Interest Rate %</label><input type="number" id="acc-rate" step="0.01" placeholder="24.24"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Starting Balance</label><input type="number" id="acc-starting" step="0.01" placeholder="5000.00"></div>
                <div class="form-group"><label>Min Payment</label><input type="number" id="acc-minpay" step="0.01" placeholder="150.00"></div>
                <div class="form-group"><label>Is Debt?</label>
                    <select id="acc-isdebt"><option value="true">Yes (CC, Loan)</option><option value="false">No (Bank account)</option></select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Pays From</label><input type="text" id="acc-paysfrom" placeholder="e.g. PNC Checking"></div>
                <div class="form-group"><label>Notes</label><input type="text" id="acc-notes" placeholder="Optional"></div>
            </div>
            <div class="btn-row">
                <button class="btn btn-primary" onclick="saveAccount()">Save Account</button>
                <button class="btn btn-secondary" id="btn-cancel-edit" style="display:none" onclick="cancelEditAccount()">Cancel</button>
            </div>
        </div>

        <div class="card">
            <h2>Active Accounts</h2>
            <div class="table-scroll">
                <table class="data-table"><thead><tr>
                    <th>Name</th><th>Type</th><th>Rate</th><th>Starting Bal</th><th>Min Pay</th><th>Pays From</th><th>Actions</th>
                </tr></thead><tbody id="accounts-body"></tbody></table>
            </div>
            <div id="accounts-empty" class="empty-state" style="display:none;"><div class="icon">üè¶</div><p>No accounts yet.</p></div>
        </div>

        <div class="card" id="closed-card" style="display:none;">
            <h2>Closed / Paid Off</h2>
            <div class="table-scroll">
                <table class="data-table"><thead><tr>
                    <th>Name</th><th>Type</th><th>Rate</th><th>Closed</th><th>Reason</th><th>Actions</th>
                </tr></thead><tbody id="closed-body"></tbody></table>
            </div>
        </div>
    </div>

    <!-- ==================== BILLS ==================== -->
    <div id="tab-bills" class="tab-panel">
        <div class="card">
            <h2>‚ûï Add Recurring Bill</h2>
            <div class="form-row">
                <div class="form-group"><label>Bill Name</label><input type="text" id="bill-name" placeholder="e.g. Electric - House 1"></div>
                <div class="form-group"><label>Expected Amount</label><input type="number" id="bill-amount" step="0.01" placeholder="150.00"></div>
                <div class="form-group"><label>Amount Varies?</label>
                    <select id="bill-variable-amt"><option value="false">No - Fixed</option><option value="true">Yes - Enter each month</option></select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Due Day</label><input type="number" id="bill-due-day" min="1" max="31" placeholder="15"></div>
                <div class="form-group"><label>Date Varies?</label>
                    <select id="bill-variable-date"><option value="false">No</option><option value="true">Yes</option></select>
                </div>
                <div class="form-group"><label>Auto-Pay?</label>
                    <select id="bill-autopay"><option value="false">No</option><option value="true">Yes</option></select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Pays From</label><input type="text" id="bill-pays-from" placeholder="PNC Checking"></div>
                <div class="form-group"><label>Category</label>
                    <select id="bill-category"><option value="electric">Electric</option><option value="mortgage">Mortgage</option><option value="insurance">Insurance</option><option value="phone">Phone</option><option value="internet">Internet</option><option value="subscription">Subscription</option><option value="vehicle">Vehicle</option><option value="other">Other</option></select>
                </div>
                <div class="form-group"><label>Notes</label><input type="text" id="bill-notes" placeholder="Optional"></div>
            </div>
            <div class="btn-row">
                <button class="btn btn-primary" onclick="saveBill()">Save Bill</button>
                <button class="btn btn-secondary" id="btn-cancel-bill" style="display:none" onclick="cancelEditBill()">Cancel</button>
            </div>
        </div>

        <div class="card">
            <h2>Monthly Bill Tracker</h2>
            <div class="month-selector">
                <button onclick="changeMonth(-1)">‚óÄ</button>
                <span class="current-month" id="bill-month-display"></span>
                <button onclick="changeMonth(1)">‚ñ∂</button>
            </div>
            <div class="table-scroll">
                <table class="data-table"><thead><tr>
                    <th>Paid</th><th>Bill</th><th>Due</th><th>Expected</th><th>Actual</th><th>Auto</th><th>Actions</th>
                </tr></thead><tbody id="bills-body"></tbody></table>
            </div>
            <div id="bills-empty" class="empty-state" style="display:none;"><div class="icon">üìã</div><p>No bills yet.</p></div>
        </div>
    </div>

    <!-- ==================== WEEKLY ENTRY ==================== -->
    <div id="tab-weekly" class="tab-panel">
        <div class="card">
            <h2>üì∏ Weekly Entry</h2>
            <div class="form-row" style="margin-bottom:12px;">
                <div class="form-group">
                    <label>Week Of (Wednesday)</label>
                    <select id="entry-date" onchange="onWeekChange()" style="padding:10px 12px;border:1px solid var(--sage-200);border-radius:8px;font-family:'Karla',sans-serif;font-size:0.95rem;background:white;color:var(--charcoal);"></select>
                </div>
                <div class="form-group" style="justify-content:flex-end;">
                    <button class="btn btn-secondary btn-small" onclick="loadPreviousWeek()">üìã Copy Prior Week's Ending</button>
                </div>
            </div>

            <!-- Summary at top -->
            <div class="summary-grid">
                <div class="summary-box"><div class="label">Total Debt</div><div class="value negative" id="we-total-debt">$0</div></div>
                <div class="summary-box"><div class="label">Total Payments</div><div class="value positive" id="we-total-payments">$0</div></div>
                <div class="summary-box"><div class="label">PNC - $500 - Bills - Payments</div><div class="value" id="we-after-reserve">$0</div></div>
                <div class="summary-box highlight"><div class="label">Available for Debt</div><div class="value positive" id="we-available">$0</div></div>
            </div>

            <div id="weekly-entries"></div>

            <div class="btn-row" style="margin-top:16px;">
                <button class="btn btn-primary" onclick="saveWeeklyEntries()">üíæ Save Week</button>
            </div>
        </div>

        <!-- Bills due this period - editable -->
        <div class="card" id="weekly-bills-section" style="display:none;">
            <h2>üìã Bills Due This Week</h2>
            <div id="weekly-bills-list"></div>
        </div>
    </div>

    <!-- ==================== HISTORY ==================== -->
    <div id="tab-history" class="tab-panel">
        <div class="card">
            <h2>üìà Weekly History</h2>
            
            <!-- Filters -->
            <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end;margin-bottom:16px;">
                <div class="form-group">
                    <label>From</label>
                    <input type="date" id="hist-from" onchange="renderHistory()">
                </div>
                <div class="form-group">
                    <label>To</label>
                    <input type="date" id="hist-to" onchange="renderHistory()">
                </div>
                <button class="btn btn-small btn-secondary" onclick="resetHistoryFilters()">Reset Dates</button>
                <button class="btn btn-small btn-primary" onclick="toggleColumnPicker()" id="btn-col-toggle">‚öô Columns</button>
            </div>

            <!-- Column picker -->
            <div id="column-picker" style="display:none;background:var(--sage-50);border-radius:8px;padding:12px 16px;margin-bottom:16px;border:1px solid var(--sage-200);">
                <div style="font-size:0.8rem;font-weight:600;color:var(--sage-600);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Show / Hide Columns</div>
                <div id="column-checks" style="display:flex;flex-wrap:wrap;gap:8px 16px;"></div>
                <div style="margin-top:10px;display:flex;gap:8px;">
                    <button class="btn btn-small btn-secondary" onclick="checkAllCols(true)">All</button>
                    <button class="btn btn-small btn-secondary" onclick="checkAllCols(false)">None</button>
                    <button class="btn btn-small btn-secondary" onclick="showDebtOnly()">Debts Only</button>
                    <button class="btn btn-small btn-secondary" onclick="showBanksOnly()">Banks Only</button>
                </div>
            </div>

            <div class="table-scroll" style="max-height:600px;overflow-y:auto;">
                <table class="data-table"><thead id="history-head"></thead><tbody id="history-body"></tbody></table>
            </div>
            <div id="history-empty" class="empty-state" style="display:none;"><div class="icon">üìä</div><p>No entries yet.</p></div>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="modal-overlay" id="modal-bill-amount">
    <div class="modal">
        <h2>Enter Actual Amount</h2>
        <div class="form-group" style="margin-bottom:16px;"><label>Amount</label><input type="number" id="modal-actual-amount" step="0.01" placeholder="0.00"></div>
        <div class="btn-row">
            <button class="btn btn-primary" onclick="saveActualAmount()">Save</button>
            <button class="btn btn-secondary" onclick="closeModal('modal-bill-amount')">Cancel</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="modal-close-account">
    <div class="modal">
        <h2>Close Out Account</h2>
        <p style="margin-bottom:16px;color:var(--sage-600);">Keeps in history, removes from weekly entry.</p>
        <div class="form-group" style="margin-bottom:12px;"><label>Close Date</label><input type="date" id="modal-close-date"></div>
        <div class="form-group" style="margin-bottom:16px;"><label>Reason</label>
            <select id="modal-close-reason"><option value="paid_off">Paid Off üéâ</option><option value="closed">Closed</option><option value="refinanced">Refinanced</option><option value="other">Other</option></select>
        </div>
        <div class="btn-row">
            <button class="btn btn-primary" onclick="confirmCloseAccount()">Close Account</button>
            <button class="btn btn-secondary" onclick="closeModal('modal-close-account')">Cancel</button>
        </div>
    </div>
</div>

<script>
const SUPABASE_URL = 'https://jzpipxvxrtdhmsdkveog.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp6cGlweHZ4cnRkaG1zZGt2ZW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NTE1MjUsImV4cCI6MjA4NTMyNzUyNX0.7mm0ts91y0leGKLFCgRk6KJitah3V5WJZdiD_gHL57o';

async function supaFetch(table, method='GET', body=null, query='') {
    const opts = { method, headers: {
        'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': method==='POST' ? 'return=representation' : method==='PATCH' ? 'return=representation' : ''
    }};
    if (body) opts.body = JSON.stringify(body);
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}${query}`, opts);
    if (!res.ok) throw new Error(await res.text());
    const text = await res.text();
    return text ? JSON.parse(text) : null;
}

// State
let accounts=[], closedAccounts=[], bills=[], billPayments=[];
let editingAccountId=null, editingBillId=null, editingBillPaymentId=null, closingAccountId=null;
let currentBillMonth = new Date(); currentBillMonth.setDate(1);

// Tabs
function switchTab(tab) {
    document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
    event.target.classList.add('active');
    if (tab==='weekly') { populateWeekDropdown(); onWeekChange(); }
    if (tab==='bills') loadBillPayments();
    if (tab==='history') loadHistory();
}

// Helpers
function fmt(n) {
    if (n==null||isNaN(n)) return '-';
    const v=Number(n), s='$'+Math.abs(v).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
    return v<0?`(${s})`:s;
}
function fmtDate(d){return d?new Date(d+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'-';}
function fmtShort(d){return d?new Date(d+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'}):'-';}
function monthKey(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-01`;}
function monthDisplay(d){return d.toLocaleDateString('en-US',{month:'long',year:'numeric'});}
function typeLabel(t){return{credit_card:'Credit Card',loan:'Loan',bank:'Bank',tax_debt:'Tax Debt',other:'Other'}[t]||t;}
function closeReasonLabel(r){return{paid_off:'üéâ Paid Off',closed:'Closed',refinanced:'Refinanced',other:'Other'}[r]||'-';}
function closeModal(id){document.getElementById(id).classList.remove('active');}

// ==================== ACCOUNTS ====================
async function loadAccounts() {
    try {
        accounts = await supaFetch('finance_accounts','GET',null,'?is_active=eq.true&order=display_order.asc,name.asc');
        closedAccounts = await supaFetch('finance_accounts','GET',null,'?is_active=eq.false&order=closed_date.desc');
        renderAccounts();
    } catch(e){console.error('Load accounts:',e);}
}

function renderAccounts() {
    const tbody=document.getElementById('accounts-body'), empty=document.getElementById('accounts-empty');
    if (!accounts.length){tbody.innerHTML='';empty.style.display='block';}
    else {
        empty.style.display='none';
        tbody.innerHTML=accounts.map(a=>`<tr>
            <td><strong>${a.name}</strong></td><td>${typeLabel(a.account_type)}</td>
            <td class="amount">${a.interest_rate}%</td><td class="amount">${fmt(a.starting_balance)}</td>
            <td class="amount">${fmt(a.min_payment)}</td><td>${a.pays_from||'-'}</td>
            <td><button class="btn btn-small btn-secondary" onclick="editAccount('${a.id}')">Edit</button>
            <button class="btn btn-small btn-primary" onclick="openCloseAccount('${a.id}')">Close Out</button></td>
        </tr>`).join('');
    }
    const cc=document.getElementById('closed-card'), cb=document.getElementById('closed-body');
    if (closedAccounts.length){
        cc.style.display='block';
        cb.innerHTML=closedAccounts.map(a=>`<tr style="opacity:0.8">
            <td><strong>${a.name}</strong></td><td>${typeLabel(a.account_type)}</td>
            <td class="amount">${a.interest_rate}%</td><td>${fmtDate(a.closed_date)}</td>
            <td><span class="badge ${a.closed_reason==='paid_off'?'badge-paid':'badge-auto'}">${closeReasonLabel(a.closed_reason)}</span></td>
            <td><button class="btn btn-small btn-secondary" onclick="reopenAccount('${a.id}')">Reopen</button></td>
        </tr>`).join('');
    } else cc.style.display='none';
}

async function saveAccount() {
    const data={
        name:document.getElementById('acc-name').value.trim(),
        account_type:document.getElementById('acc-type').value,
        interest_rate:parseFloat(document.getElementById('acc-rate').value)||0,
        starting_balance:parseFloat(document.getElementById('acc-starting').value)||0,
        min_payment:parseFloat(document.getElementById('acc-minpay').value)||0,
        is_debt:document.getElementById('acc-isdebt').value==='true',
        pays_from:document.getElementById('acc-paysfrom').value.trim()||null,
        notes:document.getElementById('acc-notes').value.trim()||null
    };
    if(!data.name)return alert('Enter a name.');
    try{
        if(editingAccountId){await supaFetch('finance_accounts','PATCH',data,`?id=eq.${editingAccountId}`);editingAccountId=null;document.getElementById('btn-cancel-edit').style.display='none';}
        else await supaFetch('finance_accounts','POST',data);
        clearAccForm(); await loadAccounts();
    }catch(e){alert('Error: '+e.message);}
}
function editAccount(id){
    const a=accounts.find(x=>x.id===id);if(!a)return;
    editingAccountId=id;
    document.getElementById('acc-name').value=a.name;
    document.getElementById('acc-type').value=a.account_type;
    document.getElementById('acc-rate').value=a.interest_rate;
    document.getElementById('acc-starting').value=a.starting_balance;
    document.getElementById('acc-minpay').value=a.min_payment;
    document.getElementById('acc-isdebt').value=String(a.is_debt);
    document.getElementById('acc-paysfrom').value=a.pays_from||'';
    document.getElementById('acc-notes').value=a.notes||'';
    document.getElementById('btn-cancel-edit').style.display='inline-block';
    window.scrollTo({top:0,behavior:'smooth'});
}
function cancelEditAccount(){editingAccountId=null;document.getElementById('btn-cancel-edit').style.display='none';clearAccForm();}
function clearAccForm(){['acc-name','acc-rate','acc-starting','acc-minpay','acc-paysfrom','acc-notes'].forEach(id=>document.getElementById(id).value='');document.getElementById('acc-type').value='credit_card';document.getElementById('acc-isdebt').value='true';}
function openCloseAccount(id){closingAccountId=id;document.getElementById('modal-close-date').value=new Date().toISOString().split('T')[0];document.getElementById('modal-close-account').classList.add('active');}
async function confirmCloseAccount(){
    const d=document.getElementById('modal-close-date').value,r=document.getElementById('modal-close-reason').value;
    if(!d)return alert('Pick a date.');
    try{await supaFetch('finance_accounts','PATCH',{is_active:false,closed_date:d,closed_reason:r},`?id=eq.${closingAccountId}`);closeModal('modal-close-account');await loadAccounts();}catch(e){alert('Error: '+e.message);}
}
async function reopenAccount(id){
    if(!confirm('Reopen this account?'))return;
    try{await supaFetch('finance_accounts','PATCH',{is_active:true,closed_date:null,closed_reason:null},`?id=eq.${id}`);await loadAccounts();}catch(e){alert('Error: '+e.message);}
}

// ==================== BILLS ====================
async function loadBills(){try{bills=await supaFetch('finance_bills','GET',null,'?is_active=eq.true&order=due_day.asc.nullsfirst,name.asc');}catch(e){console.error(e);}}
async function loadBillPayments(){
    try{billPayments=await supaFetch('finance_bill_payments','GET',null,`?bill_month=eq.${monthKey(currentBillMonth)}`);}catch(e){billPayments=[];}
    renderBills();
}
function renderBills(){
    const tbody=document.getElementById('bills-body'),empty=document.getElementById('bills-empty');
    document.getElementById('bill-month-display').textContent=monthDisplay(currentBillMonth);
    if(!bills.length){tbody.innerHTML='';empty.style.display='block';return;}
    empty.style.display='none';
    tbody.innerHTML=bills.map(b=>{
        const p=billPayments.find(x=>x.bill_id===b.id);
        return`<tr>
            <td><input type="checkbox" class="check-paid" ${p?.is_paid?'checked':''} ${b.is_auto_pay?'disabled title="Auto"':''} onchange="toggleBillPaid('${b.id}',this.checked)"></td>
            <td><strong>${b.name}</strong>${b.is_variable_amount?'<br><span class="badge badge-variable">Variable</span>':''}</td>
            <td>${b.is_variable_date?'Varies':(b.due_day||'-')}</td>
            <td class="amount">${b.is_variable_amount?'~':''}${fmt(b.expected_amount)}</td>
            <td class="amount">${p?.actual_amount!=null?fmt(p.actual_amount):'-'}${b.is_variable_amount?`<br><button class="btn btn-small btn-secondary" onclick="openAmountModal('${b.id}')">Enter</button>`:''}</td>
            <td>${b.is_auto_pay?'<span class="badge badge-auto">Auto</span>':''}</td>
            <td><button class="btn btn-small btn-secondary" onclick="editBill('${b.id}')">Edit</button><button class="btn btn-small btn-danger" onclick="deleteBill('${b.id}')">Del</button></td>
        </tr>`;
    }).join('');
}
function changeMonth(d){currentBillMonth.setMonth(currentBillMonth.getMonth()+d);loadBillPayments();}
async function toggleBillPaid(billId,isPaid){
    const mk=monthKey(currentBillMonth),ex=billPayments.find(p=>p.bill_id===billId),bill=bills.find(b=>b.id===billId);
    try{
        if(ex)await supaFetch('finance_bill_payments','PATCH',{is_paid:isPaid,paid_date:isPaid?new Date().toISOString().split('T')[0]:null},`?id=eq.${ex.id}`);
        else await supaFetch('finance_bill_payments','POST',{bill_id:billId,bill_month:mk,actual_amount:bill?.expected_amount||0,is_paid:isPaid,paid_date:isPaid?new Date().toISOString().split('T')[0]:null});
        await loadBillPayments();
    }catch(e){alert('Error: '+e.message);}
}
function openAmountModal(billId){editingBillPaymentId=billId;const p=billPayments.find(x=>x.bill_id===billId);document.getElementById('modal-actual-amount').value=p?.actual_amount||'';document.getElementById('modal-bill-amount').classList.add('active');}
async function saveActualAmount(){
    const amount=parseFloat(document.getElementById('modal-actual-amount').value)||0,mk=monthKey(currentBillMonth),ex=billPayments.find(p=>p.bill_id===editingBillPaymentId);
    try{
        if(ex)await supaFetch('finance_bill_payments','PATCH',{actual_amount:amount},`?id=eq.${ex.id}`);
        else await supaFetch('finance_bill_payments','POST',{bill_id:editingBillPaymentId,bill_month:mk,actual_amount:amount,is_paid:false});
        closeModal('modal-bill-amount');await loadBillPayments();
    }catch(e){alert('Error: '+e.message);}
}
async function saveBill(){
    const data={name:document.getElementById('bill-name').value.trim(),expected_amount:parseFloat(document.getElementById('bill-amount').value)||0,
        is_variable_amount:document.getElementById('bill-variable-amt').value==='true',due_day:parseInt(document.getElementById('bill-due-day').value)||null,
        is_variable_date:document.getElementById('bill-variable-date').value==='true',is_auto_pay:document.getElementById('bill-autopay').value==='true',
        pays_from:document.getElementById('bill-pays-from').value.trim(),category:document.getElementById('bill-category').value,notes:document.getElementById('bill-notes').value.trim()};
    if(!data.name)return alert('Enter a name.');
    try{
        if(editingBillId){await supaFetch('finance_bills','PATCH',data,`?id=eq.${editingBillId}`);editingBillId=null;document.getElementById('btn-cancel-bill').style.display='none';}
        else await supaFetch('finance_bills','POST',data);
        clearBillForm();await loadBills();await loadBillPayments();
    }catch(e){alert('Error: '+e.message);}
}
function editBill(id){
    const b=bills.find(x=>x.id===id);if(!b)return;editingBillId=id;
    document.getElementById('bill-name').value=b.name;document.getElementById('bill-amount').value=b.expected_amount;
    document.getElementById('bill-variable-amt').value=String(b.is_variable_amount);document.getElementById('bill-due-day').value=b.due_day||'';
    document.getElementById('bill-variable-date').value=String(b.is_variable_date);document.getElementById('bill-autopay').value=String(b.is_auto_pay);
    document.getElementById('bill-pays-from').value=b.pays_from||'';document.getElementById('bill-category').value=b.category||'other';
    document.getElementById('bill-notes').value=b.notes||'';document.getElementById('btn-cancel-bill').style.display='inline-block';
    window.scrollTo({top:0,behavior:'smooth'});
}
function cancelEditBill(){editingBillId=null;document.getElementById('btn-cancel-bill').style.display='none';clearBillForm();}
function clearBillForm(){['bill-name','bill-amount','bill-due-day','bill-pays-from','bill-notes'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('bill-variable-amt').value='false';document.getElementById('bill-variable-date').value='false';
    document.getElementById('bill-autopay').value='false';document.getElementById('bill-category').value='other';}
async function deleteBill(id){if(!confirm('Delete?'))return;try{await supaFetch('finance_bills','PATCH',{is_active:false},`?id=eq.${id}`);await loadBills();await loadBillPayments();}catch(e){alert(e.message);}}

// ==================== WEEKLY ENTRY ====================

function getWednesdays(){
    const weds=[];
    const start=new Date('2024-06-05T12:00:00');
    const end=new Date();
    end.setDate(end.getDate()+28);
    let d=new Date(start);
    while(d.getDay()!==3) d.setDate(d.getDate()+1);
    while(d<=end){
        const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
        weds.push(`${y}-${m}-${dd}`);
        d.setDate(d.getDate()+7);
    }
    return weds;
}

function populateWeekDropdown(){
    const sel=document.getElementById('entry-date');
    const weds=getWednesdays();
    const today=new Date();
    const dayOfWeek=today.getDay();
    const diff=dayOfWeek<=3?3-dayOfWeek:10-dayOfWeek;
    const thisWed=new Date(today);
    thisWed.setDate(today.getDate()+diff);
    const y=thisWed.getFullYear(), m=String(thisWed.getMonth()+1).padStart(2,'0'), dd=String(thisWed.getDate()).padStart(2,'0');
    const thisWedStr=`${y}-${m}-${dd}`;

    sel.innerHTML=weds.reverse().map(w=>{
        const dt=new Date(w+'T12:00:00');
        const label=dt.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'});
        const selected=w===thisWedStr?'selected':'';
        return`<option value="${w}" ${selected}>${label}</option>`;
    }).join('');
}

async function onWeekChange(){
    buildWeeklyForm();
    await loadWeekData();
    await loadWeeklyBills();
}

async function loadWeekData(){
    const dt=document.getElementById('entry-date').value;
    if(!dt)return;
    try{
        const entries=await supaFetch('finance_weekly_entries','GET',null,`?entry_date=eq.${dt}`);
        if(!entries?.length)return;
        entries.forEach(e=>{
            const bI=document.querySelector(`input[data-id="${e.account_id}"][data-f="bal"]`);
            const pI=document.querySelector(`input[data-id="${e.account_id}"][data-f="pay"]`);
            if(bI) bI.value=e.starting_balance||0;
            if(pI) pI.value=Math.abs(e.payment)||0;
        });
        calcWeekly();
    }catch(e){console.error('Load week:',e);}
}

async function loadWeeklyBills(){
    const dt=document.getElementById('entry-date').value;
    if(!dt||!bills.length){document.getElementById('weekly-bills-section').style.display='none';return;}

    const weekDate=new Date(dt+'T12:00:00');
    const nextWed=new Date(weekDate);
    nextWed.setDate(nextWed.getDate()+7);

    const mk1=`${weekDate.getFullYear()}-${String(weekDate.getMonth()+1).padStart(2,'0')}-01`;
    const mk2=`${nextWed.getFullYear()}-${String(nextWed.getMonth()+1).padStart(2,'0')}-01`;

    let payments=[];
    try{
        payments=await supaFetch('finance_bill_payments','GET',null,`?bill_month=eq.${mk1}`);
        if(mk2!==mk1){
            const p2=await supaFetch('finance_bill_payments','GET',null,`?bill_month=eq.${mk2}`);
            if(p2) payments=payments.concat(p2);
        }
    }catch(e){payments=[];}

    // Find bills due between this Wed and next Wed
    const dueBills=[];
    bills.forEach(b=>{
        if(!b.due_day)return;
        for(let m=0;m<2;m++){
            const checkDate=new Date(weekDate);
            checkDate.setMonth(checkDate.getMonth()+m);
            checkDate.setDate(b.due_day);
            if(checkDate.getDate()!==b.due_day) continue;
            if(checkDate>=weekDate && checkDate<nextWed){
                const billMonth=`${checkDate.getFullYear()}-${String(checkDate.getMonth()+1).padStart(2,'0')}-01`;
                const p=payments.find(x=>x.bill_id===b.id && x.bill_month===billMonth);
                dueBills.push({bill:b, dueDate:new Date(checkDate), payment:p, billMonth});
                break;
            }
        }
    });

    dueBills.sort((a,b)=>a.dueDate-b.dueDate);

    const section=document.getElementById('weekly-bills-section');
    const list=document.getElementById('weekly-bills-list');
    section.style.display='block';

    let totalDue=0;
    let html='';

    if(dueBills.length){
        html+=`<div style="display:grid;grid-template-columns:auto 1fr 100px 120px 80px;gap:8px;align-items:center;padding:8px 0;font-size:0.8rem;font-weight:600;color:var(--sage-600);text-transform:uppercase;letter-spacing:0.5px;border-bottom:2px solid var(--sage-300);">
            <div>Paid</div><div>Bill</div><div style="text-align:center">Due Date</div><div style="text-align:right">Amount</div><div></div>
        </div>`;

        dueBills.forEach(({bill:b, dueDate, payment:p, billMonth})=>{
            const amt=p?.actual_amount||b.expected_amount||0;
            const paid=p?.is_paid||false;
            const paidDateVal=p?.paid_date||dueDate.toISOString().split('T')[0];
            if(!paid) totalDue+=amt;

            html+=`<div style="display:grid;grid-template-columns:auto 1fr 100px 120px 80px;gap:8px;align-items:center;padding:8px 0;border-bottom:1px solid var(--sage-100);${paid?'opacity:0.5':''}">
                <div><input type="checkbox" class="check-paid" ${paid?'checked':''} onchange="toggleWeeklyBillPaid('${b.id}','${billMonth}',this.checked,this)" style="accent-color:var(--sage-500);width:18px;height:18px;cursor:pointer;"></div>
                <div>
                    <strong>${b.name}</strong>
                    ${b.is_variable_amount?'<span class="badge badge-variable" style="margin-left:4px;">Variable</span>':''}
                    ${b.is_auto_pay?'<span class="badge badge-auto" style="margin-left:4px;">Auto</span>':''}
                </div>
                <div><input type="date" value="${paidDateVal}" data-bill-id="${b.id}" data-bill-month="${billMonth}" data-field="date" style="padding:4px 6px;border:1px solid var(--sage-200);border-radius:6px;font-family:'Karla',sans-serif;font-size:0.85rem;width:100%;"></div>
                <div><input type="number" step="0.01" value="${amt.toFixed(2)}" data-bill-id="${b.id}" data-bill-month="${billMonth}" data-field="amount" style="padding:4px 8px;border:1px solid var(--sage-200);border-radius:6px;font-family:'Karla',sans-serif;font-size:0.9rem;text-align:right;width:100%;"></div>
                <div><button class="btn btn-small btn-secondary" onclick="saveWeeklyBill('${b.id}','${billMonth}')">Save</button></div>
            </div>`;
        });

        html+=`<div style="display:flex;justify-content:space-between;padding:12px 0;margin-top:4px;border-top:2px solid var(--sage-300);font-weight:700;">
            <span style="color:var(--dusty-rose);">‚ö†Ô∏è Unpaid due before next Wed:</span>
            <span style="color:var(--dusty-rose);">${fmt(totalDue)}</span>
        </div>`;
    } else {
        html+='<p style="color:var(--sage-400);padding:12px 0;">No bills due before next Wednesday</p>';
    }

    // Monthly summary
    let monthTotal=0, paidTotal=0;
    const mkCurrent=`${weekDate.getFullYear()}-${String(weekDate.getMonth()+1).padStart(2,'0')}-01`;
    bills.forEach(b=>{
        const p=payments.find(x=>x.bill_id===b.id && x.bill_month===mkCurrent);
        const amt=p?.actual_amount||b.expected_amount||0;
        monthTotal+=amt;
        if(p?.is_paid) paidTotal+=amt;
    });

    html+=`<div style="display:flex;justify-content:space-between;padding:8px 0;font-size:0.85rem;border-top:1px solid var(--sage-200);margin-top:4px;">
        <span>Month total: ${fmt(monthTotal)}</span>
        <span style="color:var(--green-soft);">Paid: ${fmt(paidTotal)}</span>
        <span style="color:var(--dusty-rose);">Remaining: ${fmt(monthTotal-paidTotal)}</span>
    </div>`;
    list.innerHTML=html;
}

async function toggleWeeklyBillPaid(billId,billMonth,isPaid,checkbox){
    const row=checkbox.closest('div[style*="grid"]');
    const amtInput=row.querySelector('input[data-field="amount"]');
    const dateInput=row.querySelector('input[data-field="date"]');
    const amt=parseFloat(amtInput?.value)||0;
    const paidDate=dateInput?.value||null;

    try{
        const existing=await supaFetch('finance_bill_payments','GET',null,`?bill_id=eq.${billId}&bill_month=eq.${billMonth}`);
        if(existing?.length){
            await supaFetch('finance_bill_payments','PATCH',{is_paid:isPaid,actual_amount:amt,paid_date:isPaid?paidDate:null},`?id=eq.${existing[0].id}`);
        }else{
            await supaFetch('finance_bill_payments','POST',{bill_id:billId,bill_month:billMonth,actual_amount:amt,is_paid:isPaid,paid_date:isPaid?paidDate:null});
        }
        await loadWeeklyBills();
    }catch(e){alert('Error: '+e.message);}
}

async function saveWeeklyBill(billId,billMonth){
    const amtInput=document.querySelector(`input[data-bill-id="${billId}"][data-bill-month="${billMonth}"][data-field="amount"]`);
    const dateInput=document.querySelector(`input[data-bill-id="${billId}"][data-bill-month="${billMonth}"][data-field="date"]`);
    const amt=parseFloat(amtInput?.value)||0;
    const paidDate=dateInput?.value||null;

    try{
        const existing=await supaFetch('finance_bill_payments','GET',null,`?bill_id=eq.${billId}&bill_month=eq.${billMonth}`);
        if(existing?.length){
            await supaFetch('finance_bill_payments','PATCH',{actual_amount:amt,paid_date:paidDate},`?id=eq.${existing[0].id}`);
        }else{
            await supaFetch('finance_bill_payments','POST',{bill_id:billId,bill_month:billMonth,actual_amount:amt,is_paid:false,paid_date:paidDate});
        }
        await loadWeeklyBills();
    }catch(e){alert('Error: '+e.message);}
}

function buildWeeklyForm(){
    const c=document.getElementById('weekly-entries');
    if(!accounts.length){c.innerHTML='<p style="color:var(--sage-600);padding:12px 0;">Add accounts first.</p>';return;}

    // Categorize accounts
    const pnc=accounts.find(a=>a.name.toLowerCase().includes('pnc'));
    const rental=accounts.find(a=>a.name.toLowerCase().includes('rental'));
    const recurringAcc=accounts.find(a=>a.name.toLowerCase().includes('recurring'));
    const ccs=accounts.filter(a=>a.account_type==='credit_card');
    const taxes=accounts.filter(a=>a.account_type==='tax_debt');
    const loans=accounts.filter(a=>a.is_debt && a.account_type==='loan');
    // Anything else that doesn't fit above
    const skipIds=new Set([pnc?.id,rental?.id,recurringAcc?.id,...ccs.map(a=>a.id),...taxes.map(a=>a.id),...loans.map(a=>a.id)].filter(Boolean));
    const other=accounts.filter(a=>!skipIds.has(a.id));

    let h=`<div class="entry-row header"><div>Account</div><div style="text-align:right">Balance</div><div style="text-align:right">Payment</div><div style="text-align:right">Ending</div></div>`;

    // PNC at top
    if(pnc){
        h+=`<div class="section-divider">üí∞ PNC Checking</div>`;
        h+=entryRow(pnc,false);
    }

    // Credit Cards
    if(ccs.length){
        h+=`<div class="section-divider">üí≥ Credit Cards</div>`;
        ccs.forEach(a=>{h+=entryRow(a,true);});
        h+=`<div class="entry-row" style="font-weight:700;color:var(--sage-700);border-top:2px solid var(--sage-300);padding-top:10px;">
            <label>CC Total</label><div class="calc" id="sum-cc-bal" style="text-align:right;padding-right:12px;">-</div><div class="calc" id="sum-cc-pay" style="text-align:right;padding-right:12px;">-</div><div class="calc" id="sum-cc-end" style="text-align:right;padding-right:12px;">-</div>
        </div>`;
    }

    // Tax Debts
    if(taxes.length){
        h+=`<div class="section-divider">üèõÔ∏è Tax Debts</div>`;
        taxes.forEach(a=>{h+=entryRow(a,true);});
        h+=`<div class="entry-row" style="font-weight:700;color:var(--sage-700);border-top:2px solid var(--sage-300);padding-top:10px;">
            <label>Tax Total</label><div class="calc" id="sum-tax-bal" style="text-align:right;padding-right:12px;">-</div><div class="calc" id="sum-tax-pay" style="text-align:right;padding-right:12px;">-</div><div class="calc" id="sum-tax-end" style="text-align:right;padding-right:12px;">-</div>
        </div>`;
    }

    // Other Loans
    if(loans.length){
        h+=`<div class="section-divider">üè¶ Loans</div>`;
        loans.forEach(a=>{h+=entryRow(a,true);});
        h+=`<div class="entry-row" style="font-weight:700;color:var(--sage-700);border-top:2px solid var(--sage-300);padding-top:10px;">
            <label>Loan Total</label><div class="calc" id="sum-loan-bal" style="text-align:right;padding-right:12px;">-</div><div class="calc" id="sum-loan-pay" style="text-align:right;padding-right:12px;">-</div><div class="calc" id="sum-loan-end" style="text-align:right;padding-right:12px;">-</div>
        </div>`;
    }

    // Rental
    if(rental){
        h+=`<div class="section-divider">üè† Rental</div>`;
        h+=entryRow(rental,false);
    }

    // Recurring Bills set-aside
    if(recurringAcc){
        h+=`<div class="section-divider">üìã Set Aside for Bills</div>`;
        h+=entryRow(recurringAcc,false);
    }

    // Other
    if(other.length){
        h+=`<div class="section-divider">Other</div>`;
        other.forEach(a=>{h+=entryRow(a,false);});
    }

    c.innerHTML=h;
}

function entryRow(a,showRate){
    return`<div class="entry-row">
        <label>${a.name}${showRate?' <span class="rate">'+a.interest_rate+'%</span>':''}</label>
        <input type="number" step="0.01" placeholder="0.00" data-id="${a.id}" data-f="bal" data-type="${a.account_type}" data-debt="${a.is_debt}" class="we-in" oninput="calcWeekly()">
        <input type="number" step="0.01" placeholder="0.00" data-id="${a.id}" data-f="pay" class="we-in" oninput="calcWeekly()">
        <div class="calc" data-id="${a.id}" data-f="end">-</div>
    </div>`;
}

function calcWeekly(){
    let totalDebt=0, totalDebtPay=0, pncEnding=0, recurringBills=0;
    let ccBal=0,ccPay=0,ccEnd=0, taxBal=0,taxPay=0,taxEnd=0, loanBal=0,loanPay=0,loanEnd=0;

    // Track which account IDs are tax debts (Fed Tax, PA Tax) so we don't double-count
    const taxAccountNames=['fed tax','pa tax'];

    accounts.forEach(a=>{
        const bI=document.querySelector(`input[data-id="${a.id}"][data-f="bal"]`);
        const pI=document.querySelector(`input[data-id="${a.id}"][data-f="pay"]`);
        const eD=document.querySelector(`div[data-id="${a.id}"][data-f="end"]`);
        if(!bI)return;
        const bal=parseFloat(bI.value)||0, pay=parseFloat(pI.value)||0, end=bal-pay;
        eD.textContent=fmt(end); eD.className=`calc ${end<0?'negative':''}`;

        if(a.is_debt){
            totalDebt+=bal;
            totalDebtPay+=pay;
        }
        if(a.name.toLowerCase().includes('pnc')){pncEnding=end;}
        if(a.name.toLowerCase().includes('recurring')){recurringBills=bal;}

        // Group sums
        if(a.account_type==='credit_card'){ccBal+=bal;ccPay+=pay;ccEnd+=end;}
        if(a.account_type==='tax_debt'){taxBal+=bal;taxPay+=pay;taxEnd+=end;}
        if(a.is_debt&&a.account_type==='loan'){loanBal+=bal;loanPay+=pay;loanEnd+=end;}
    });

    // Update group sums
    const setSum=(id,val)=>{const el=document.getElementById(id);if(el)el.textContent=fmt(val);};
    setSum('sum-cc-bal',ccBal);setSum('sum-cc-pay',ccPay);setSum('sum-cc-end',ccEnd);
    setSum('sum-tax-bal',taxBal);setSum('sum-tax-pay',taxPay);setSum('sum-tax-end',taxEnd);
    setSum('sum-loan-bal',loanBal);setSum('sum-loan-pay',loanPay);setSum('sum-loan-end',loanEnd);

    // Available = PNC ending - $500 reserve - all debt payments - recurring bills
    // But tax payments (IRS, PA Tax) are already in recurring bills, so subtract them to avoid double-counting
    let taxPayments=0;
    accounts.filter(a=>a.account_type==='tax_debt').forEach(a=>{
        const pI=document.querySelector(`input[data-id="${a.id}"][data-f="pay"]`);
        if(pI) taxPayments+=parseFloat(pI.value)||0;
    });

    const debtPayExclTax=totalDebtPay-taxPayments;
    const afterAll=pncEnding-500-recurringBills-debtPayExclTax;
    const avail=Math.max(0,afterAll);

    document.getElementById('we-total-debt').textContent=fmt(totalDebt);
    document.getElementById('we-total-payments').textContent=fmt(totalDebtPay);
    document.getElementById('we-after-reserve').textContent=fmt(afterAll);
    document.getElementById('we-after-reserve').className=`value ${afterAll>=0?'positive':'negative'}`;
    document.getElementById('we-available').textContent=fmt(avail);
    document.getElementById('we-available').className=`value ${avail>0?'positive':'negative'}`;
}

async function loadPreviousWeek(){
    const currentDate=document.getElementById('entry-date').value;
    if(!currentDate)return;
    // Find the Wednesday before this one
    const d=new Date(currentDate+'T00:00:00');
    d.setDate(d.getDate()-7);
    const prevWed=d.toISOString().split('T')[0];
    try{
        const prevEntries=await supaFetch('finance_weekly_entries','GET',null,`?entry_date=eq.${prevWed}`);
        if(!prevEntries?.length)return alert('No data for previous week.');
        prevEntries.forEach(e=>{
            const bI=document.querySelector(`input[data-id="${e.account_id}"][data-f="bal"]`);
            if(bI) bI.value=e.ending_balance||e.starting_balance||0;
        });
        calcWeekly();
    }catch(e){alert('Error: '+e.message);}
}

async function saveWeeklyEntries(){
    const dt=document.getElementById('entry-date').value;
    if(!dt)return alert('Pick a week.');
    const entries=[];
    accounts.forEach(a=>{
        const bI=document.querySelector(`input[data-id="${a.id}"][data-f="bal"]`);
        const pI=document.querySelector(`input[data-id="${a.id}"][data-f="pay"]`);
        if(!bI)return;
        const bal=parseFloat(bI.value)||0, pay=parseFloat(pI.value)||0;
        if(bal!==0||pay!==0) entries.push({entry_date:dt,account_id:a.id,starting_balance:bal,payment:-pay,ending_balance:bal-pay});
    });
    if(!entries.length)return alert('Enter at least one balance.');
    try{
        await supaFetch('finance_weekly_entries','DELETE',null,`?entry_date=eq.${dt}`);
        await supaFetch('finance_weekly_entries','POST',entries);
        alert('Week saved!');
    }catch(e){alert('Error: '+e.message);}
}

// ==================== HISTORY ====================
let historyEntries=[], historyOrdered=[], historyDates=[], historyAccMap={};
let visibleCols=new Set(); // account IDs that are visible

async function loadHistory(){
    try{
        historyEntries=await supaFetch('finance_weekly_entries','GET',null,'?order=entry_date.desc');
        if(!historyEntries?.length){document.getElementById('history-empty').style.display='block';document.getElementById('history-head').innerHTML='';document.getElementById('history-body').innerHTML='';return;}
        document.getElementById('history-empty').style.display='none';

        const allAcc=[...accounts,...closedAccounts];
        historyAccMap={};
        allAcc.forEach(a=>historyAccMap[a.id]=a);

        historyDates=[...new Set(historyEntries.map(e=>e.entry_date))];
        const accIds=[...new Set(historyEntries.map(e=>e.account_id))];
        historyOrdered=accIds.map(id=>historyAccMap[id]).filter(Boolean).sort((a,b)=>{
            if(a.is_debt!==b.is_debt)return a.is_debt?-1:1;
            return(a.display_order||0)-(b.display_order||0);
        });

        // Init visible columns (all on first load)
        if(visibleCols.size===0) historyOrdered.forEach(a=>visibleCols.add(a.id));

        buildColumnPicker();
        renderHistory();
    }catch(e){console.error('History:',e);}
}

function buildColumnPicker(){
    const container=document.getElementById('column-checks');
    container.innerHTML=historyOrdered.map(a=>`
        <label style="display:flex;align-items:center;gap:4px;font-size:0.85rem;cursor:pointer;color:var(--charcoal);">
            <input type="checkbox" ${visibleCols.has(a.id)?'checked':''} onchange="toggleCol('${a.id}',this.checked)" style="accent-color:var(--sage-500);">
            ${a.name}
        </label>
    `).join('');
}

function toggleCol(id,checked){
    if(checked)visibleCols.add(id); else visibleCols.delete(id);
    renderHistory();
}
function checkAllCols(on){
    historyOrdered.forEach(a=>{if(on)visibleCols.add(a.id);else visibleCols.delete(a.id);});
    buildColumnPicker();renderHistory();
}
function showDebtOnly(){
    visibleCols.clear();
    historyOrdered.filter(a=>a.is_debt).forEach(a=>visibleCols.add(a.id));
    buildColumnPicker();renderHistory();
}
function showBanksOnly(){
    visibleCols.clear();
    historyOrdered.filter(a=>!a.is_debt).forEach(a=>visibleCols.add(a.id));
    buildColumnPicker();renderHistory();
}
function toggleColumnPicker(){
    const el=document.getElementById('column-picker');
    el.style.display=el.style.display==='none'?'block':'none';
}
function resetHistoryFilters(){
    document.getElementById('hist-from').value='';
    document.getElementById('hist-to').value='';
    renderHistory();
}

function renderHistory(){
    const fromDate=document.getElementById('hist-from').value;
    const toDate=document.getElementById('hist-to').value;

    // Filter dates
    let dates=historyDates;
    if(fromDate) dates=dates.filter(d=>d>=fromDate);
    if(toDate) dates=dates.filter(d=>d<=toDate);

    // Visible accounts
    const shown=historyOrdered.filter(a=>visibleCols.has(a.id));
    const hasDebt=shown.some(a=>a.is_debt);

    document.getElementById('history-head').innerHTML=`<tr><th>Date</th>${shown.map(a=>`<th class="amount">${a.name}</th>`).join('')}${hasDebt?'<th class="amount">Total Debt</th>':''}</tr>`;

    document.getElementById('history-body').innerHTML=dates.map((date,i)=>{
        const week=historyEntries.filter(e=>e.entry_date===date), eMap={};
        week.forEach(e=>eMap[e.account_id]=e);
        let debt=0;
        const cells=shown.map(a=>{
            const e=eMap[a.id];
            if(e){if(a.is_debt)debt+=e.ending_balance;return`<td class="amount">${fmt(e.ending_balance)}</td>`;}
            return`<td class="amount" style="color:var(--sage-300)">-</td>`;
        }).join('');

        let prevDebt=0, debtCell='';
        if(hasDebt){
            const nextIdx=historyDates.indexOf(dates[i])+1;
            if(nextIdx<historyDates.length){
                const prevDate=historyDates[nextIdx];
                historyEntries.filter(e=>e.entry_date===prevDate).forEach(e=>{const a=historyAccMap[e.account_id];if(a?.is_debt&&visibleCols.has(a.id))prevDebt+=e.ending_balance;});
            }
            const chg=nextIdx<historyDates.length?debt-prevDebt:0;
            debtCell=`<td class="amount">${fmt(debt)}${chg!==0?`<br><small class="${chg<0?'positive':'negative'}">${chg<0?'‚ñº':'‚ñ≤'} ${fmt(Math.abs(chg))}</small>`:''}</td>`;
        }

        return`<tr><td><strong>${fmtShort(date)}</strong></td>${cells}${debtCell}</tr>`;
    }).join('');
}

// ==================== INIT ====================
async function init(){
    await loadAccounts(); await loadBills(); await loadBillPayments();
}
init();
</script>
</body>
</html>
