<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finances - Homestead Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@300;400;600&family=Karla:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --sage-50: #f6f7f3;
            --sage-100: #e8ebe0;
            --sage-200: #d4dac5;
            --sage-300: #b8c5a3;
            --sage-400: #98ab7e;
            --sage-500: #7a9061;
            --sage-600: #5f734c;
            --sage-700: #4a5a3b;
            --sage-800: #3d4a32;
            --cream: #ece8dd;
            --taupe: #c4b5a4;
            --dusty-sage: #a4ac95;
            --mauve: #a88479;
            --charcoal: #4a4d47;
            --dusty-rose: #9b7269;
            --red-soft: #c0392b;
            --green-soft: #27ae60;
        }

        body {
            font-family: 'Karla', sans-serif;
            background: var(--charcoal);
            min-height: 100vh;
            color: var(--cream);
        }

        .top-bar {
            background: rgba(61, 74, 50, 0.9);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--sage-700);
        }
        .top-bar a { color: var(--sage-200); text-decoration: none; font-size: 0.9rem; }
        .top-bar a:hover { color: var(--cream); }
        .top-bar h1 { font-family: 'Crimson Pro', serif; font-size: 1.4rem; font-weight: 400; color: var(--cream); }

        .tab-bar { display: flex; gap: 0; background: rgba(74, 90, 59, 0.5); overflow-x: auto; }
        .tab-btn {
            padding: 14px 24px; background: none; border: none; color: var(--sage-200);
            font-family: 'Karla', sans-serif; font-size: 0.95rem; font-weight: 500;
            cursor: pointer; border-bottom: 3px solid transparent; white-space: nowrap; transition: all 0.2s;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.05); color: var(--cream); }
        .dash-card { transition: all 0.15s; -webkit-tap-highlight-color: transparent; }
        .dash-card:hover, .dash-card:active { border-color: var(--sage-400) !important; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08) !important; }
        @media (hover: none) { .dash-card:active { transform: scale(0.97); } .dash-card:hover { transform: none; } }
        .tab-btn.active { color: var(--cream); border-bottom-color: var(--sage-400); background: rgba(255,255,255,0.08); }

        .main-content { max-width: 1200px; margin: 0 auto; padding: 24px 20px; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        .card {
            background: rgba(236, 232, 221, 0.95); border-radius: 12px; padding: 24px;
            margin-bottom: 20px; color: var(--charcoal); box-shadow: 0 4px 16px rgba(0,0,0,0.25);
        }
        .card h2 { font-family: 'Crimson Pro', serif; font-size: 1.5rem; font-weight: 600; color: var(--sage-700); margin-bottom: 16px; }

        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 12px; }
        .form-group { display: flex; flex-direction: column; gap: 4px; }
        .form-group label { font-size: 0.8rem; font-weight: 600; color: var(--sage-600); text-transform: uppercase; letter-spacing: 0.5px; }
        .form-group input, .form-group select {
            padding: 10px 12px; border: 1px solid var(--sage-200); border-radius: 8px;
            font-family: 'Karla', sans-serif; font-size: 0.95rem; background: white; color: var(--charcoal);
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--sage-500); box-shadow: 0 0 0 3px rgba(122, 144, 97, 0.15); }

        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-family: 'Karla', sans-serif; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--sage-500); color: white; }
        .btn-primary:hover { background: var(--sage-600); }
        .btn-secondary { background: var(--taupe); color: white; }
        .btn-secondary:hover { background: var(--mauve); }
        .btn-danger { background: var(--dusty-rose); color: white; }
        .btn-danger:hover { background: var(--red-soft); }
        .btn-small { padding: 6px 12px; font-size: 0.8rem; }
        .btn-row { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }

        .data-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .data-table th { background: var(--sage-600); color: white; padding: 10px 12px; text-align: left; font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; }
        .data-table td { padding: 10px 12px; border-bottom: 1px solid var(--sage-100); }
        .data-table tr:hover { background: rgba(122, 144, 97, 0.08); }
        .data-table .amount { text-align: right; font-variant-numeric: tabular-nums; }
        .data-table .negative { color: var(--red-soft); }
        .data-table .positive { color: var(--green-soft); }
        .data-table th[onclick]:hover { background: var(--sage-700); }

        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .summary-box { background: var(--sage-700); border-radius: 10px; padding: 16px; text-align: center; color: var(--cream); }
        .summary-box .label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--sage-200); margin-bottom: 6px; }
        .summary-box .value { font-family: 'Crimson Pro', serif; font-size: 1.6rem; font-weight: 600; }
        .summary-box .value.positive { color: #6dd59a; }
        .summary-box .value.negative { color: #e88; }
        .summary-box.highlight { background: var(--sage-500); border: 2px solid var(--sage-300); }

        .check-paid { width: 20px; height: 20px; cursor: pointer; accent-color: var(--sage-500); }
        .badge { display: inline-block; padding: 3px 10px; border-radius: 10px; font-size: 0.75rem; font-weight: 600; }
        .drop-zone {
            border: 2px dashed var(--sage-300); border-radius: 12px; padding: 24px 16px;
            text-align: center; cursor: pointer; transition: all 0.2s;
            background: white; position: relative; min-height: 120px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .drop-zone:hover { border-color: var(--sage-400); background: var(--sage-50); }
        .drop-zone.drag-over { border-color: var(--sage-600); background: var(--sage-100); border-style: solid; transform: scale(1.02); }
        .drop-zone.success { border-color: #4a7c3f; background: #e8f5e9; }
        .drop-zone.error { border-color: #c44; background: #fee; }
        .drop-zone-name { font-weight: 700; color: var(--sage-700); font-size: 1rem; margin-bottom: 4px; }
        .drop-zone-type { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: var(--sage-400); margin-bottom: 8px; }
        .drop-zone-icon { font-size: 1.8rem; margin-bottom: 6px; opacity: 0.5; }
        .drop-zone-hint { font-size: 0.75rem; color: var(--sage-400); }
        .drop-zone-status { font-size: 0.8rem; margin-top: 8px; font-weight: 600; }
        .drop-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .badge-paid { background: rgba(39, 174, 96, 0.15); color: var(--green-soft); }
        .badge-auto { background: rgba(122, 144, 97, 0.15); color: var(--sage-600); }
        .badge-variable { background: rgba(168, 132, 121, 0.15); color: var(--mauve); }

        .entry-row { display: grid; grid-template-columns: 1.5fr 120px 120px 120px; gap: 8px; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--sage-100); }
        .entry-row.header { font-size: 0.8rem; font-weight: 600; color: var(--sage-600); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid var(--sage-300); padding-bottom: 10px; }
        .entry-row label { font-weight: 500; color: var(--charcoal); }
        .entry-row .rate { font-size: 0.8rem; color: var(--sage-400); }
        .entry-row input {
            padding: 8px 10px; border: 1px solid var(--sage-200); border-radius: 8px;
            font-family: 'Karla', sans-serif; font-size: 0.95rem; text-align: right; background: white; color: var(--charcoal); width: 100%;
        }
        .entry-row input:focus { outline: none; border-color: var(--sage-500); box-shadow: 0 0 0 3px rgba(122, 144, 97, 0.15); }
        .entry-row .calc { text-align: right; font-variant-numeric: tabular-nums; font-weight: 500; padding-right: 12px; }
        .section-divider { font-family: 'Crimson Pro', serif; font-size: 1.1rem; color: var(--sage-600); padding: 16px 0 6px; border-bottom: 2px solid var(--sage-300); margin-top: 8px; }

        .month-selector { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
        .month-selector button { background: var(--sage-600); color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 1.1rem; }
        .month-selector button:hover { background: var(--sage-700); }
        .month-selector .current-month { font-family: 'Crimson Pro', serif; font-size: 1.3rem; color: var(--charcoal); min-width: 160px; text-align: center; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--cream); border-radius: 12px; padding: 28px; max-width: 500px; width: 90%; color: var(--charcoal); box-shadow: 0 8px 40px rgba(0,0,0,0.4); }
        .modal h2 { font-family: 'Crimson Pro', serif; color: var(--sage-700); margin-bottom: 16px; }

        .table-scroll { overflow-x: auto; }
        .empty-state { text-align: center; padding: 40px; color: var(--sage-600); }
        .empty-state .icon { font-size: 3rem; margin-bottom: 12px; }

        #column-picker label:hover { background: var(--sage-100); border-radius: 4px; padding: 2px 4px; margin: -2px -4px; }

        @media (max-width: 768px) {
            /* Tabs - scrollable, dashboard first */
            .tab-bar { overflow-x: auto; -webkit-overflow-scrolling: touch; flex-wrap: nowrap; }
            .tab-btn { padding: 10px 12px; font-size: 0.78rem; white-space: nowrap; flex-shrink: 0; }

            .form-row { grid-template-columns: 1fr; }
            .summary-grid { grid-template-columns: 1fr 1fr; }
            .card { padding: 12px; margin: 8px; }
            .entry-row { grid-template-columns: 1fr 90px 90px 90px; gap: 4px; }
            .entry-row input { padding: 6px 8px; font-size: 0.85rem; }
            .data-table { font-size: 0.8rem; }
            .data-table th, .data-table td { padding: 8px 6px; }

            /* Dashboard cards */
            #dash-cards { grid-template-columns: 1fr 1fr 1fr !important; gap: 10px !important; }
            #dash-big-charges .data-table, #dash-boa-girls .data-table { font-size: 0.78rem; }
            #dash-big-charges td, #dash-boa-girls td { padding: 8px 6px; }

            /* Transactions & Import mobile */
            #tab-transactions .card > div[style*="grid-template-columns"] { grid-template-columns: 1fr 1fr !important; }
            #txn-table-wrap { font-size: 0.75rem; }
            #import-zones { grid-template-columns: 1fr !important; }
            .drop-zone { min-height: 90px !important; padding: 16px 12px !important; }
            #ai-review-list > div { grid-template-columns: 26px 60px 1fr 90px 20px 90px !important; font-size: 0.7rem !important; }
            #ai-review-list select { font-size: 0.7rem !important; padding: 3px 4px !important; }
        }

        @media (max-width: 420px) {
            /* Small phones - stack cards */
            #dash-cards { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
            .dash-card div:last-child { font-size: 1.15rem !important; }

            /* Top bar compact */
            .top-bar h1 { font-size: 1.2rem; }
            .top-bar a { font-size: 0.75rem; }
        }
    </style>
</head>
<body>

<div id="lock-screen" style="position:fixed;top:0;left:0;right:0;bottom:0;background:var(--charcoal);z-index:9999;display:flex;align-items:center;justify-content:center;">
    <div style="text-align:center;background:white;padding:40px 32px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.2);max-width:320px;width:90%;">
        <div style="font-size:2rem;margin-bottom:12px;">üîí</div>
        <h2 style="font-family:'Crimson Pro',serif;color:var(--sage-700);margin-bottom:20px;">Finances</h2>
        <div id="pin-dots" style="display:flex;justify-content:center;gap:12px;margin-bottom:24px;">
            <div class="pin-dot" style="width:16px;height:16px;border-radius:50%;border:2px solid var(--sage-300);"></div>
            <div class="pin-dot" style="width:16px;height:16px;border-radius:50%;border:2px solid var(--sage-300);"></div>
            <div class="pin-dot" style="width:16px;height:16px;border-radius:50%;border:2px solid var(--sage-300);"></div>
            <div class="pin-dot" style="width:16px;height:16px;border-radius:50%;border:2px solid var(--sage-300);"></div>
        </div>
        <div id="pin-pad" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;max-width:240px;margin:0 auto;">
            <button onclick="pinPress('1')" style="padding:16px;font-size:1.3rem;border:1px solid var(--sage-200);border-radius:10px;background:white;cursor:pointer;font-family:'Karla',sans-serif;">1</button>
            <button onclick="pinPress('2')" style="padding:16px;font-size:1.3rem;border:1px solid var(--sage-200);border-radius:10px;background:white;cursor:pointer;font-family:'Karla',sans-serif;">2</button>
            <button onclick="pinPress('3')" style="padding:16px;font-size:1.3rem;border:1px solid var(--sage-200);border-radius:10px;background:white;cursor:pointer;font-family:'Karla',sans-serif;">3</button>
            <button onclick="pinPress('4')" style="padding:16px;font-size:1.3rem;border:1px solid var(--sage-200);border-radius:10px;background:white;cursor:pointer;font-family:'Karla',sans-serif;">4</button>
            <button onclick="pinPress('5')" style="padding:16px;font-size:1.3rem;border:1px solid var(--sage-200);border-radius:10px;background:white;cursor:pointer;font-family:'Karla',sans-serif;">5</button>
            <button onclick="pinPress('6')" style="padding:16px;font-size:1.3rem;border:1px solid var(--sage-200);border-radius:10px;background:white;cursor:pointer;font-family:'Karla',sans-serif;">6</button>
            <button onclick="pinPress('7')" style="padding:16px;font-size:1.3rem;border:1px solid var(--sage-200);border-radius:10px;background:white;cursor:pointer;font-family:'Karla',sans-serif;">7</button>
            <button onclick="pinPress('8')" style="padding:16px;font-size:1.3rem;border:1px solid var(--sage-200);border-radius:10px;background:white;cursor:pointer;font-family:'Karla',sans-serif;">8</button>
            <button onclick="pinPress('9')" style="padding:16px;font-size:1.3rem;border:1px solid var(--sage-200);border-radius:10px;background:white;cursor:pointer;font-family:'Karla',sans-serif;">9</button>
            <div></div>
            <button onclick="pinPress('0')" style="padding:16px;font-size:1.3rem;border:1px solid var(--sage-200);border-radius:10px;background:white;cursor:pointer;font-family:'Karla',sans-serif;">0</button>
            <button onclick="pinClear()" style="padding:16px;font-size:0.9rem;border:1px solid var(--sage-200);border-radius:10px;background:white;cursor:pointer;font-family:'Karla',sans-serif;color:var(--sage-500);">‚å´</button>
        </div>
        <p id="pin-error" style="color:#c44;font-size:0.85rem;margin-top:12px;min-height:1.2em;"></p>
    </div>
</div>
<script>
let pinCode='';
function pinPress(n){
    if(pinCode.length>=4)return;
    pinCode+=n;
    const dots=document.querySelectorAll('.pin-dot');
    dots.forEach((d,i)=>d.style.background=i<pinCode.length?'var(--sage-500)':'transparent');
    if(pinCode.length===4){
        if(pinCode==='0323'){
            document.getElementById('lock-screen').style.display='none';
        } else {
            document.getElementById('pin-error').textContent='Wrong code';
            setTimeout(()=>{pinCode='';dots.forEach(d=>d.style.background='transparent');document.getElementById('pin-error').textContent='';},800);
        }
    }
}
function pinClear(){pinCode=pinCode.slice(0,-1);const dots=document.querySelectorAll('.pin-dot');dots.forEach((d,i)=>d.style.background=i<pinCode.length?'var(--sage-500)':'transparent');}
</script>

<div class="top-bar">
    <a href="index.html">‚Üê Back to Hub</a>
    <h1>üìä Finances</h1>
    <div></div>
</div>

<div class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</button>
    <button class="tab-btn" onclick="switchTab('weekly')">Weekly Entry</button>
    <button class="tab-btn" onclick="switchTab('transactions')">Transactions</button>
    <button class="tab-btn" onclick="switchTab('accounts')">Accounts</button>
    <button class="tab-btn" onclick="switchTab('bills')">Bills</button>
    <button class="tab-btn" onclick="switchTab('history')">History</button>
    <button class="tab-btn" onclick="switchTab('import')">Import</button>
</div>

<div class="main-content">

    <!-- ==================== DASHBOARD ==================== -->
    <div id="tab-dashboard" class="tab-panel active">
        <div class="card">
            <h2>üìä Weekly Snapshot</h2>
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                <button class="btn btn-secondary btn-small" onclick="shiftDashWeek(-1)" style="padding:8px 12px;font-size:1.1rem;">‚óÄ</button>
                <span id="dash-week-label" style="font-family:'Crimson Pro',serif;font-size:1.2rem;color:var(--sage-700);min-width:200px;text-align:center;"></span>
                <button class="btn btn-secondary btn-small" onclick="shiftDashWeek(1)" style="padding:8px 12px;font-size:1.1rem;">‚ñ∂</button>
            </div>
            <div id="dash-cards" style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin:0 0 16px;"></div>

            <!-- Overall totals -->
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px;">
                <div style="background:var(--sage-700);border-radius:12px;padding:16px;text-align:center;">
                    <div style="font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;color:var(--sage-200);margin-bottom:4px;">üìä Total Debt</div>
                    <div id="dash-total-debt" style="font-size:1.5rem;font-weight:700;font-family:'Crimson Pro',serif;color:#e88;">$0</div>
                </div>
                <div style="background:var(--sage-700);border-radius:12px;padding:16px;text-align:center;">
                    <div style="font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;color:var(--sage-200);margin-bottom:4px;">üí≥ CC Debt</div>
                    <div id="dash-cc-debt" style="font-size:1.5rem;font-weight:700;font-family:'Crimson Pro',serif;color:#e88;">$0</div>
                </div>
                <div style="background:var(--sage-700);border-radius:12px;padding:16px;text-align:center;">
                    <div style="font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;color:var(--sage-200);margin-bottom:4px;">üè¶ Loan Debt</div>
                    <div id="dash-loan-debt" style="font-size:1.5rem;font-weight:700;font-family:'Crimson Pro',serif;color:#e88;">$0</div>
                </div>
                <div style="background:var(--sage-700);border-radius:12px;padding:16px;text-align:center;">
                    <div style="font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;color:var(--sage-200);margin-bottom:4px;">üèõÔ∏è Total Tax</div>
                    <div id="dash-total-tax" style="font-size:1.5rem;font-weight:700;font-family:'Crimson Pro',serif;color:#e88;">$0</div>
                </div>
            </div>

            <!-- Charges over $200 table -->
            <div id="dash-big-charges" style="margin-bottom:24px;"></div>

            <!-- BOA Girls charges table -->
            <div id="dash-boa-girls" style="margin-bottom:24px;"></div>
        </div>
    </div>

    <!-- ==================== IMPORT ==================== -->
    <div id="tab-import" class="tab-panel">
        <div class="card">
            <h2>üì• Import Transactions</h2>
            <p style="color:var(--sage-500);font-size:0.85rem;margin-bottom:16px;">Drop any bank CSV below ‚Äî the app will detect which account it belongs to.</p>
            <div id="import-drop" class="drop-zone" style="min-height:160px;padding:32px 24px;text-align:center;"
                 ondragover="dzOver(event)" ondragleave="dzLeave(event)" ondrop="dzDropSingle(event)">
                <div style="font-size:2.5rem;margin-bottom:8px;">üìÑ</div>
                <div class="drop-zone-hint" style="font-size:1rem;">Drop CSV here or click to browse</div>
                <div style="color:var(--sage-400);font-size:0.8rem;margin-top:8px;">Supports: Chase, BOA, PNC</div>
                <input type="file" accept=".csv" multiple onchange="dzFileSelectSingle(event)">
            </div>
            <div id="import-log" style="margin-top:16px;"></div>
        </div>
    </div>

    <!-- ==================== TRANSACTIONS ==================== -->
    <div id="tab-transactions" class="tab-panel">
        <div class="card">
            <h2>üîç Transactions</h2>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;align-items:end;margin-bottom:12px;">
                <div class="form-group">
                    <label>Account</label>
                    <select id="txn-filter-account" onchange="loadTransactions()" style="padding:8px;border:1px solid var(--sage-200);border-radius:8px;font-family:'Karla',sans-serif;">
                        <option value="">All Accounts</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="txn-filter-category" onchange="loadTransactions()" style="padding:8px;border:1px solid var(--sage-200);border-radius:8px;font-family:'Karla',sans-serif;">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Vendor</label>
                    <select id="txn-filter-vendor" onchange="loadTransactions()" style="padding:8px;border:1px solid var(--sage-200);border-radius:8px;font-family:'Karla',sans-serif;">
                        <option value="">All Vendors</option>
                    </select>
                </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;align-items:end;margin-bottom:16px;">
                <div class="form-group">
                    <label>From</label>
                    <input type="date" id="txn-filter-from" onchange="loadTransactions()" style="padding:8px;border:1px solid var(--sage-200);border-radius:8px;font-family:'Karla',sans-serif;">
                </div>
                <div class="form-group">
                    <label>To</label>
                    <input type="date" id="txn-filter-to" onchange="loadTransactions()" style="padding:8px;border:1px solid var(--sage-200);border-radius:8px;font-family:'Karla',sans-serif;">
                </div>
                <div class="form-group">
                    <label>Search</label>
                    <input type="text" id="txn-search" placeholder="Search description..." oninput="loadTransactions()" style="padding:8px;border:1px solid var(--sage-200);border-radius:8px;font-family:'Karla',sans-serif;">
                </div>
            </div>
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                <div id="txn-summary" style="font-weight:700;color:var(--sage-700);font-size:0.9rem;"></div>
                <button class="btn btn-small btn-primary" onclick="aiCategorize()" id="btn-ai-cat" style="white-space:nowrap;">ü§ñ AI Categorize</button>
            </div>
            <div id="txn-bulk-bar" style="display:none;background:var(--sage-600);color:white;padding:10px 16px;border-radius:8px;margin-bottom:12px;display:none;align-items:center;gap:12px;flex-wrap:wrap;">
                <span id="txn-bulk-count" style="font-weight:600;font-size:0.9rem;"></span>
                <select id="txn-bulk-category" style="padding:6px 10px;border-radius:6px;border:1px solid var(--sage-300);font-family:'Karla',sans-serif;font-size:0.85rem;">
                    <option value="">Pick category...</option>
                </select>
                <button class="btn btn-small" style="background:white;color:var(--sage-700);" onclick="bulkApplyCategory()">Apply</button>
                <button class="btn btn-small" style="background:transparent;color:white;border:1px solid rgba(255,255,255,0.4);" onclick="txnSelected.clear();renderTransactions();">Cancel</button>
            </div>
            <div id="txn-table-wrap" style="max-height:500px;overflow-y:auto;"></div>
        </div>
    </div>

    <!-- ==================== ACCOUNTS ==================== -->
    <div id="tab-accounts" class="tab-panel">
        <div class="card">
            <h2>‚ûï Add Account</h2>
            <div class="form-row">
                <div class="form-group"><label>Account Name</label><input type="text" id="acc-name" placeholder="e.g. Family CC"></div>
                <div class="form-group"><label>Type</label>
                    <select id="acc-type" onchange="toggleLoanFields()">
                        <option value="credit_card">Credit Card</option>
                        <option value="loan">Loan</option>
                        <option value="bank">Bank Account</option>
                        <option value="tax_debt">Tax Debt</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group"><label>Interest Rate %</label><input type="number" id="acc-rate" step="0.01" placeholder="24.24"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Starting Balance</label><input type="number" id="acc-starting" step="0.01" placeholder="5000.00"></div>
                <div class="form-group"><label>Min Payment</label><input type="number" id="acc-minpay" step="0.01" placeholder="150.00"></div>
                <div class="form-group"><label>Is Debt?</label>
                    <select id="acc-isdebt"><option value="true">Yes (CC, Loan)</option><option value="false">No (Bank account)</option></select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Pays From</label><input type="text" id="acc-paysfrom" placeholder="e.g. PNC Checking"></div>
                <div class="form-group"><label>Last 4 Digits</label><input type="text" id="acc-last4" maxlength="4" placeholder="e.g. 8683"></div>
                <div class="form-group"><label>Notes</label><input type="text" id="acc-notes" placeholder="Optional"></div>
            </div>
            <div class="form-row" id="loan-fields" style="display:none;background:var(--sage-50);padding:12px;border-radius:8px;border:1px dashed var(--sage-300);">
                <div class="form-group"><label>Loan Term (months)</label><input type="number" id="acc-loan-term" placeholder="60"></div>
                <div class="form-group"><label>First Payment Date</label><input type="date" id="acc-loan-start"></div>
                <div class="form-group"><label>Auto-create bill?</label>
                    <select id="acc-loan-bill"><option value="true">Yes</option><option value="false">No</option></select>
                </div>
            </div>
            <div class="btn-row">
                <button class="btn btn-primary" onclick="saveAccount()">Save Account</button>
                <button class="btn btn-secondary" id="btn-cancel-edit" style="display:none" onclick="cancelEditAccount()">Cancel</button>
            </div>
        </div>

        <div class="card">
            <h2>Active Accounts</h2>
            <div id="accounts-grouped"></div>
            <div id="accounts-empty" class="empty-state" style="display:none;"><div class="icon">üè¶</div><p>No accounts yet.</p></div>
        </div>

        <div class="card" id="closed-card" style="display:none;">
            <h2>Closed / Paid Off</h2>
            <div class="table-scroll">
                <table class="data-table"><thead><tr>
                    <th>Name</th><th>Type</th><th>Rate</th><th>Closed</th><th>Reason</th><th>Actions</th>
                </tr></thead><tbody id="closed-body"></tbody></table>
            </div>
        </div>
    </div>

    <!-- ==================== BILLS ==================== -->
    <div id="tab-bills" class="tab-panel">
        <div class="card">
            <h2>‚ûï Add Recurring Bill</h2>
            <div class="form-row">
                <div class="form-group"><label>Bill Name</label><input type="text" id="bill-name" placeholder="e.g. Electric - House 1"></div>
                <div class="form-group"><label>Expected Amount</label><input type="number" id="bill-amount" step="0.01" placeholder="150.00"></div>
                <div class="form-group"><label>Amount Varies?</label>
                    <select id="bill-variable-amt"><option value="false">No - Fixed</option><option value="true">Yes - Enter each month</option></select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Due Day</label><input type="number" id="bill-due-day" min="1" max="31" placeholder="15"></div>
                <div class="form-group"><label>Date Varies?</label>
                    <select id="bill-variable-date"><option value="false">No</option><option value="true">Yes</option></select>
                </div>
                <div class="form-group"><label>Auto-Pay?</label>
                    <select id="bill-autopay"><option value="false">No</option><option value="true">Yes</option></select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Pays From</label><input type="text" id="bill-pays-from" placeholder="PNC Checking"></div>
                <div class="form-group"><label>Category</label>
                    <select id="bill-category"><option value="loan">Loan</option><option value="electric">Electric</option><option value="insurance">Insurance</option><option value="tax">Tax</option><option value="mortgage">Mortgage</option><option value="phone">Phone</option><option value="internet">Internet</option><option value="subscription">Subscription</option><option value="vehicle">Vehicle</option><option value="other">Other</option></select>
                </div>
                <div class="form-group"><label>Notes</label><input type="text" id="bill-notes" placeholder="Optional"></div>
            </div>
            <div class="btn-row">
                <button class="btn btn-primary" onclick="saveBill()">Save Bill</button>
                <button class="btn btn-secondary" id="btn-cancel-bill" style="display:none" onclick="cancelEditBill()">Cancel</button>
            </div>
        </div>

        <div class="card">
            <h2>Monthly Bill Tracker</h2>
            <div class="month-selector">
                <button onclick="changeMonth(-1)">‚óÄ</button>
                <span class="current-month" id="bill-month-display"></span>
                <button onclick="changeMonth(1)">‚ñ∂</button>
            </div>
            <div id="bills-grouped"></div>
            <div id="bills-empty" class="empty-state" style="display:none;"><div class="icon">üìã</div><p>No bills yet.</p></div>
        </div>
    </div>

    <!-- ==================== WEEKLY ENTRY ==================== -->
    <div id="tab-weekly" class="tab-panel">
        <div class="card">
            <h2>üì∏ Weekly Entry</h2>
            <div class="form-row" style="margin-bottom:12px;">
                <div class="form-group">
                    <label>Week Of (Wednesday)</label>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <button class="btn btn-secondary btn-small" onclick="shiftWeek(1)" title="Previous week" style="padding:8px 12px;font-size:1.1rem;">‚óÄ</button>
                        <select id="entry-date" onchange="onWeekChange()" style="padding:10px 12px;border:1px solid var(--sage-200);border-radius:8px;font-family:'Karla',sans-serif;font-size:0.95rem;background:white;color:var(--charcoal);flex:1;"></select>
                        <button class="btn btn-secondary btn-small" onclick="shiftWeek(-1)" title="Next week" style="padding:8px 12px;font-size:1.1rem;">‚ñ∂</button>
                    </div>
                </div>
            </div>

            <!-- Summary at top -->
            <div class="summary-grid">
                <div class="summary-box"><div class="label">Total Debt</div><div class="value negative" id="we-total-debt">$0</div></div>
                <div class="summary-box"><div class="label">Total Payments</div><div class="value positive" id="we-total-payments">$0</div></div>
                <div class="summary-box"><div class="label">CC Spent This Week</div><div class="value negative" id="we-cc-spent">$0</div></div>
                <div class="summary-box"><div class="label">PNC - $500 - Set Aside</div><div class="value" id="we-after-reserve">$0</div></div>
                <div class="summary-box highlight"><div class="label">Set Aside for Bills</div><div class="value" id="we-bills-total">$0</div></div>
            </div>

            <div id="weekly-entries"></div>

            <div class="btn-row" style="margin-top:16px;">
                <button class="btn btn-primary" onclick="saveWeeklyEntries()">üíæ Save Week</button>
            </div>
        </div>
    </div>

    <!-- ==================== HISTORY ==================== -->
    <div id="tab-history" class="tab-panel">
        <div class="card">
            <h2>üìà Weekly History</h2>
            
            <!-- Filters -->
            <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end;margin-bottom:16px;">
                <div class="form-group">
                    <label>From</label>
                    <input type="date" id="hist-from" onchange="renderHistory()">
                </div>
                <div class="form-group">
                    <label>To</label>
                    <input type="date" id="hist-to" onchange="renderHistory()">
                </div>
                <button class="btn btn-small btn-secondary" onclick="resetHistoryFilters()">Reset Dates</button>
                <button class="btn btn-small btn-primary" onclick="toggleColumnPicker()" id="btn-col-toggle">‚öô Columns</button>
            </div>

            <!-- Column picker -->
            <div id="column-picker" style="display:none;background:var(--sage-50);border-radius:8px;padding:12px 16px;margin-bottom:16px;border:1px solid var(--sage-200);">
                <div style="font-size:0.8rem;font-weight:600;color:var(--sage-600);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Show / Hide Columns</div>
                <div id="column-checks" style="display:flex;flex-wrap:wrap;gap:8px 16px;"></div>
                <div style="margin-top:10px;display:flex;gap:8px;">
                    <button class="btn btn-small btn-secondary" onclick="checkAllCols(true)">All</button>
                    <button class="btn btn-small btn-secondary" onclick="checkAllCols(false)">None</button>
                    <button class="btn btn-small btn-secondary" onclick="showDebtOnly()">Debts Only</button>
                    <button class="btn btn-small btn-secondary" onclick="showBanksOnly()">Banks Only</button>
                </div>
            </div>

            <div class="table-scroll" style="max-height:600px;overflow-y:auto;">
                <table class="data-table"><thead id="history-head"></thead><tbody id="history-body"></tbody></table>
            </div>
            <div id="history-empty" class="empty-state" style="display:none;"><div class="icon">üìä</div><p>No entries yet.</p></div>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="modal-overlay" id="modal-bill-amount">
    <div class="modal">
        <h2>Enter Actual Amount</h2>
        <div class="form-group" style="margin-bottom:16px;"><label>Amount</label><input type="number" id="modal-actual-amount" step="0.01" placeholder="0.00"></div>
        <div class="btn-row">
            <button class="btn btn-primary" onclick="saveActualAmount()">Save</button>
            <button class="btn btn-secondary" onclick="closeModal('modal-bill-amount')">Cancel</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="modal-close-account">
    <div class="modal">
        <h2>Close Out Account</h2>
        <p style="margin-bottom:16px;color:var(--sage-600);">Keeps in history, removes from weekly entry.</p>
        <div class="form-group" style="margin-bottom:12px;"><label>Close Date</label><input type="date" id="modal-close-date"></div>
        <div class="form-group" style="margin-bottom:16px;"><label>Reason</label>
            <select id="modal-close-reason"><option value="paid_off">Paid Off üéâ</option><option value="closed">Closed</option><option value="refinanced">Refinanced</option><option value="other">Other</option></select>
        </div>
        <div class="btn-row">
            <button class="btn btn-primary" onclick="confirmCloseAccount()">Close Account</button>
            <button class="btn btn-secondary" onclick="closeModal('modal-close-account')">Cancel</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="modal-ai-review">
    <div class="modal" style="max-width:700px;max-height:85vh;display:flex;flex-direction:column;">
        <h2>ü§ñ AI Category Suggestions</h2>
        <p id="ai-review-status" style="font-size:0.85rem;color:var(--sage-500);margin-bottom:12px;"></p>
        <div id="ai-review-list" style="flex:1;overflow-y:auto;margin-bottom:12px;"></div>
        <div class="btn-row" style="justify-content:space-between;">
            <button class="btn btn-secondary" onclick="closeModal('modal-ai-review')">Cancel</button>
            <button class="btn btn-primary" onclick="applyAISuggestions()" id="btn-ai-apply">‚úÖ Apply All</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="modal-category">
    <div class="modal" style="max-width:400px;">
        <h2>Set Category</h2>
        <p id="modal-cat-desc" style="font-size:0.85rem;color:var(--sage-500);margin-bottom:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></p>
        <div style="max-height:300px;overflow-y:auto;margin-bottom:12px;" id="modal-cat-list"></div>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:16px;">
            <input type="text" id="modal-cat-new" placeholder="New category name..." style="flex:1;padding:8px 12px;border:1px solid var(--sage-200);border-radius:8px;font-family:'Karla',sans-serif;font-size:0.9rem;">
            <button class="btn btn-small btn-primary" onclick="addNewCategory()">+ Add</button>
        </div>
        <div class="btn-row">
            <button class="btn btn-secondary" onclick="closeModal('modal-category')">Cancel</button>
        </div>
    </div>
</div>

<script>
const SUPABASE_URL = 'https://jzpipxvxrtdhmsdkveog.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp6cGlweHZ4cnRkaG1zZGt2ZW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NTE1MjUsImV4cCI6MjA4NTMyNzUyNX0.7mm0ts91y0leGKLFCgRk6KJitah3V5WJZdiD_gHL57o';

async function supaFetch(table, method='GET', body=null, query='') {
    const opts = { method, headers: {
        'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': method==='POST' ? 'return=representation' : method==='PATCH' ? 'return=representation' : ''
    }};
    if (body) opts.body = JSON.stringify(body);
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}${query}`, opts);
    if (!res.ok) throw new Error(await res.text());
    const text = await res.text();
    return text ? JSON.parse(text) : null;
}

// State
let accounts=[], closedAccounts=[], bills=[], billPayments=[];
let editingAccountId=null, editingBillId=null, editingBillPaymentId=null, closingAccountId=null;
let currentBillMonth = new Date(); currentBillMonth.setDate(1);

// Tabs
function switchTab(tab) {
    document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
    event.target.classList.add('active');
    if (tab==='dashboard') loadDashboard();
    if (tab==='weekly') { populateWeekDropdown(); onWeekChange(); }
    if (tab==='import') initImportTab();
    if (tab==='transactions') initTransactions();
    if (tab==='bills') loadBillPayments();
    if (tab==='history') loadHistory();
}

// Helpers
function fmt(n) {
    if (n==null||isNaN(n)) return '-';
    const v=Number(n), s='$'+Math.abs(v).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
    return v<0?`(${s})`:s;
}
function fmtDate(d){return d?new Date(d+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'-';}
function fmtShort(d){return d?new Date(d+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'}):'-';}
function monthKey(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-01`;}
function monthDisplay(d){return d.toLocaleDateString('en-US',{month:'long',year:'numeric'});}
function typeLabel(t){return{credit_card:'Credit Card',loan:'Loan',bank:'Bank',tax_debt:'Tax Debt',other:'Other'}[t]||t;}
function closeReasonLabel(r){return{paid_off:'üéâ Paid Off',closed:'Closed',refinanced:'Refinanced',other:'Other'}[r]||'-';}
function closeModal(id){document.getElementById(id).classList.remove('active');}

// ==================== ACCOUNTS ====================
async function loadAccounts() {
    try {
        accounts = await supaFetch('finance_accounts','GET',null,'?is_active=eq.true&order=display_order.asc,name.asc');
        closedAccounts = await supaFetch('finance_accounts','GET',null,'?is_active=eq.false&order=closed_date.desc');
        renderAccounts();
    } catch(e){console.error('Load accounts:',e);}
}

function renderAccounts() {
    const container=document.getElementById('accounts-grouped'), empty=document.getElementById('accounts-empty');
    const filtered=accounts.filter(a=>a.name.toLowerCase()!=='recurring bills');
    if (!filtered.length){container.innerHTML='';empty.style.display='block';}
    else {
        empty.style.display='none';
        const typeOrder=['credit_card','loan','tax_debt','bank','other'];
        const typeLabels={credit_card:'üí≥ Credit Cards',loan:'üè¶ Loans',tax_debt:'üèõÔ∏è Tax Debt',bank:'üèß Bank Accounts',other:'üìÅ Other'};
        const groups={};
        filtered.forEach(a=>{
            const t=a.account_type||'other';
            if(!groups[t])groups[t]=[];
            groups[t].push(a);
        });
        let html='';
        let grandTotal=0;
        typeOrder.forEach(type=>{
            if(!groups[type])return;
            const accs=groups[type];
            const subtotal=accs.reduce((s,a)=>s+(parseFloat(a.min_payment)||0),0);
            grandTotal+=subtotal;
            html+=`<div style="margin-bottom:20px;">
                <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--sage-100);border-radius:8px;margin-bottom:8px;">
                    <strong style="color:var(--sage-700);font-size:0.95rem;">${typeLabels[type]||type}</strong>
                    <span style="color:var(--sage-600);font-size:0.85rem;">Min Pay Total: <strong>${fmt(subtotal)}</strong></span>
                </div>
                <div class="table-scroll"><table class="data-table"><thead><tr>
                    <th>Name</th><th>Rate</th><th>Starting Bal</th><th>Min Pay</th><th>Pays From</th><th>Actions</th>
                </tr></thead><tbody>`;
            accs.forEach(a=>{
                html+=`<tr>
                    <td><strong>${a.name}</strong></td>
                    <td class="amount">${a.interest_rate}%</td><td class="amount">${fmt(a.starting_balance)}</td>
                    <td class="amount">${fmt(a.min_payment)}</td><td>${a.pays_from||'-'}</td>
                    <td><button class="btn btn-small btn-secondary" onclick="editAccount('${a.id}')">Edit</button>
                    <button class="btn btn-small btn-primary" onclick="openCloseAccount('${a.id}')">Close Out</button></td>
                </tr>`;
            });
            html+=`</tbody></table></div></div>`;
        });
        html+=`<div style="text-align:right;padding:10px 12px;border-top:2px solid var(--sage-300);margin-top:8px;">
            <strong style="color:var(--sage-700);">Total Min Payments: ${fmt(grandTotal)}</strong></div>`;
        container.innerHTML=html;
    }
    const cc=document.getElementById('closed-card'), cb=document.getElementById('closed-body');
    if (closedAccounts.length){
        cc.style.display='block';
        cb.innerHTML=closedAccounts.map(a=>`<tr style="opacity:0.8">
            <td><strong>${a.name}</strong></td><td>${typeLabel(a.account_type)}</td>
            <td class="amount">${a.interest_rate}%</td><td>${fmtDate(a.closed_date)}</td>
            <td><span class="badge ${a.closed_reason==='paid_off'?'badge-paid':'badge-auto'}">${closeReasonLabel(a.closed_reason)}</span></td>
            <td><button class="btn btn-small btn-secondary" onclick="reopenAccount('${a.id}')">Reopen</button></td>
        </tr>`).join('');
    } else cc.style.display='none';
}

function toggleLoanFields(){
    const isLoan=document.getElementById('acc-type').value==='loan';
    document.getElementById('loan-fields').style.display=isLoan?'flex':'none';
    if(isLoan){document.getElementById('acc-isdebt').value='true';}
}

async function saveAccount() {
    const data={
        name:document.getElementById('acc-name').value.trim(),
        account_type:document.getElementById('acc-type').value,
        interest_rate:parseFloat(document.getElementById('acc-rate').value)||0,
        starting_balance:parseFloat(document.getElementById('acc-starting').value)||0,
        min_payment:parseFloat(document.getElementById('acc-minpay').value)||0,
        is_debt:document.getElementById('acc-isdebt').value==='true',
        pays_from:document.getElementById('acc-paysfrom').value.trim()||null,
        last_4:document.getElementById('acc-last4').value.trim()||null,
        notes:document.getElementById('acc-notes').value.trim()||null
    };
    if(!data.name)return alert('Enter a name.');
    
    const isNewLoan=data.account_type==='loan'&&!editingAccountId;
    const loanTerm=parseInt(document.getElementById('acc-loan-term').value)||0;
    const loanStart=document.getElementById('acc-loan-start').value;
    const createBill=document.getElementById('acc-loan-bill').value==='true';
    
    if(isNewLoan&&(!loanTerm||!loanStart))return alert('Enter loan term and first payment date.');
    
    try{
        let accountId;
        if(editingAccountId){
            await supaFetch('finance_accounts','PATCH',data,`?id=eq.${editingAccountId}`);
            accountId=editingAccountId;
            editingAccountId=null;
            document.getElementById('btn-cancel-edit').style.display='none';
        } else {
            const result=await supaFetch('finance_accounts','POST',data);
            accountId=result?.[0]?.id||result?.id;
        }
        
        // Auto-generate amortization schedule for new loans
        if(isNewLoan&&accountId&&loanTerm&&loanStart){
            const balance=data.starting_balance;
            const monthlyRate=data.interest_rate/100/12;
            const payment=data.min_payment;
            let bal=balance;
            const rows=[];
            
            for(let i=0;i<loanTerm;i++){
                const dt=new Date(loanStart+'T00:00:00');
                dt.setMonth(dt.getMonth()+i);
                const dateStr=dt.toISOString().split('T')[0];
                const interest=Math.round(bal*monthlyRate*100)/100;
                
                let payAmt=payment,princ=payment-interest;
                if(i===loanTerm-1||princ>=bal){payAmt=Math.round((bal+interest)*100)/100;princ=bal;}
                else{princ=Math.round(princ*100)/100;}
                
                const newBal=Math.max(0,Math.round((bal-princ)*100)/100);
                rows.push({account_id:accountId,payment_number:i+1,due_date:dateStr,
                    payment_amount:payAmt,interest:interest,principal:princ,balance_after:newBal});
                bal=newBal;
                if(bal<=0)break;
            }
            
            // Insert in batches
            for(let i=0;i<rows.length;i+=50){
                await supaFetch('finance_loan_schedules','POST',rows.slice(i,i+50));
            }
            
            // Auto-create bill
            if(createBill){
                await supaFetch('finance_bills','POST',{
                    name:data.name,expected_amount:data.min_payment,
                    is_variable_amount:false,is_auto_pay:true,
                    pays_from:data.pays_from||'',category:'loan',
                    is_variable_date:false,notes:'Auto-created from loan setup'
                });
                await loadBills();
            }
            
            alert(`‚úÖ ${data.name} set up!\n‚Ä¢ ${rows.length} payment schedule created\n${createBill?'‚Ä¢ Bill added':''}`)
        }
        
        clearAccForm(); await loadAccounts();
    }catch(e){alert('Error: '+e.message);}
}
function editAccount(id){
    const a=accounts.find(x=>x.id===id);if(!a)return;
    editingAccountId=id;
    document.getElementById('acc-name').value=a.name;
    document.getElementById('acc-type').value=a.account_type;
    document.getElementById('acc-rate').value=a.interest_rate;
    document.getElementById('acc-starting').value=a.starting_balance;
    document.getElementById('acc-minpay').value=a.min_payment;
    document.getElementById('acc-isdebt').value=String(a.is_debt);
    document.getElementById('acc-paysfrom').value=a.pays_from||'';
    document.getElementById('acc-last4').value=a.last_4||'';
    document.getElementById('acc-notes').value=a.notes||'';
    document.getElementById('btn-cancel-edit').style.display='inline-block';
    toggleLoanFields();
    window.scrollTo({top:0,behavior:'smooth'});
}
function cancelEditAccount(){editingAccountId=null;document.getElementById('btn-cancel-edit').style.display='none';clearAccForm();}
function clearAccForm(){['acc-name','acc-rate','acc-starting','acc-minpay','acc-paysfrom','acc-last4','acc-notes','acc-loan-term','acc-loan-start'].forEach(id=>document.getElementById(id).value='');document.getElementById('acc-type').value='credit_card';document.getElementById('acc-isdebt').value='true';document.getElementById('acc-loan-bill').value='true';document.getElementById('loan-fields').style.display='none';}
function openCloseAccount(id){closingAccountId=id;document.getElementById('modal-close-date').value=new Date().toISOString().split('T')[0];document.getElementById('modal-close-account').classList.add('active');}
async function confirmCloseAccount(){
    const d=document.getElementById('modal-close-date').value,r=document.getElementById('modal-close-reason').value;
    if(!d)return alert('Pick a date.');
    try{await supaFetch('finance_accounts','PATCH',{is_active:false,closed_date:d,closed_reason:r},`?id=eq.${closingAccountId}`);closeModal('modal-close-account');await loadAccounts();}catch(e){alert('Error: '+e.message);}
}
async function reopenAccount(id){
    if(!confirm('Reopen this account?'))return;
    try{await supaFetch('finance_accounts','PATCH',{is_active:true,closed_date:null,closed_reason:null},`?id=eq.${id}`);await loadAccounts();}catch(e){alert('Error: '+e.message);}
}

// ==================== BILLS ====================
async function loadBills(){try{bills=await supaFetch('finance_bills','GET',null,'?is_active=eq.true&order=due_day.asc.nullsfirst,name.asc');}catch(e){console.error(e);}}
async function loadBillPayments(){
    try{billPayments=await supaFetch('finance_bill_payments','GET',null,`?bill_month=eq.${monthKey(currentBillMonth)}`);}catch(e){billPayments=[];}
    renderBills();
}
function renderBills(){
    const container=document.getElementById('bills-grouped'),empty=document.getElementById('bills-empty');
    document.getElementById('bill-month-display').textContent=monthDisplay(currentBillMonth);
    if(!bills.length){container.innerHTML='';empty.style.display='block';return;}
    empty.style.display='none';
    
    const catOrder=['loan','electric','insurance','tax','mortgage','phone','internet','subscription','vehicle','other'];
    const catLabels={loan:'üè¶ Loans',electric:'‚ö° Electric',insurance:'üõ°Ô∏è Insurance',tax:'üèõÔ∏è Taxes',mortgage:'üè† Mortgage',phone:'üì± Phone',internet:'üåê Internet',subscription:'üì∫ Subscriptions',vehicle:'üöó Vehicle',other:'üìÅ Other'};
    const groups={};
    bills.forEach(b=>{
        const c=b.category||'other';
        if(!groups[c])groups[c]=[];
        groups[c].push(b);
    });
    
    let html='';
    let grandTotal=0;
    catOrder.forEach(cat=>{
        if(!groups[cat])return;
        const catBills=groups[cat];
        const subtotal=catBills.reduce((s,b)=>s+(parseFloat(b.expected_amount)||0),0);
        grandTotal+=subtotal;
        html+=`<div style="margin-bottom:20px;">
            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--sage-100);border-radius:8px;margin-bottom:8px;">
                <strong style="color:var(--sage-700);font-size:0.95rem;">${catLabels[cat]||cat}</strong>
                <span style="color:var(--sage-600);font-size:0.85rem;">Subtotal: <strong>${fmt(subtotal)}</strong></span>
            </div>
            <div class="table-scroll"><table class="data-table"><thead><tr>
                <th>Paid</th><th>Bill</th><th>Due</th><th>Expected</th><th>Actual</th><th>Auto</th><th>Actions</th>
            </tr></thead><tbody>`;
        catBills.forEach(b=>{
            const p=billPayments.find(x=>x.bill_id===b.id);
            html+=`<tr>
                <td><input type="checkbox" class="check-paid" ${p?.is_paid?'checked':''} ${b.is_auto_pay?'disabled title="Auto"':''} onchange="toggleBillPaid('${b.id}',this.checked)"></td>
                <td><strong>${b.name}</strong>${b.is_variable_amount?'<br><span class="badge badge-variable">Variable</span>':''}</td>
                <td>${b.is_variable_date?'Varies':(b.due_day||'-')}</td>
                <td class="amount">${b.is_variable_amount?'~':''}${fmt(b.expected_amount)}</td>
                <td class="amount">${p?.actual_amount!=null?fmt(p.actual_amount):'-'}${b.is_variable_amount?`<br><button class="btn btn-small btn-secondary" onclick="openAmountModal('${b.id}')">Enter</button>`:''}</td>
                <td>${b.is_auto_pay?'<span class="badge badge-auto">Auto</span>':''}</td>
                <td><button class="btn btn-small btn-secondary" onclick="editBill('${b.id}')">Edit</button><button class="btn btn-small btn-danger" onclick="deleteBill('${b.id}')">Del</button></td>
            </tr>`;
        });
        html+=`</tbody></table></div></div>`;
    });
    html+=`<div style="text-align:right;padding:10px 12px;border-top:2px solid var(--sage-300);margin-top:8px;">
        <strong style="color:var(--sage-700);">Total Monthly Bills: ${fmt(grandTotal)}</strong></div>`;
    container.innerHTML=html;
}
function changeMonth(d){currentBillMonth.setMonth(currentBillMonth.getMonth()+d);loadBillPayments();}
async function toggleBillPaid(billId,isPaid){
    const mk=monthKey(currentBillMonth),ex=billPayments.find(p=>p.bill_id===billId),bill=bills.find(b=>b.id===billId);
    try{
        if(ex)await supaFetch('finance_bill_payments','PATCH',{is_paid:isPaid,paid_date:isPaid?new Date().toISOString().split('T')[0]:null},`?id=eq.${ex.id}`);
        else await supaFetch('finance_bill_payments','POST',{bill_id:billId,bill_month:mk,actual_amount:bill?.expected_amount||0,is_paid:isPaid,paid_date:isPaid?new Date().toISOString().split('T')[0]:null});
        await loadBillPayments();
    }catch(e){alert('Error: '+e.message);}
}
function openAmountModal(billId){editingBillPaymentId=billId;const p=billPayments.find(x=>x.bill_id===billId);document.getElementById('modal-actual-amount').value=p?.actual_amount||'';document.getElementById('modal-bill-amount').classList.add('active');}
async function saveActualAmount(){
    const amount=parseFloat(document.getElementById('modal-actual-amount').value)||0,mk=monthKey(currentBillMonth),ex=billPayments.find(p=>p.bill_id===editingBillPaymentId);
    try{
        if(ex)await supaFetch('finance_bill_payments','PATCH',{actual_amount:amount},`?id=eq.${ex.id}`);
        else await supaFetch('finance_bill_payments','POST',{bill_id:editingBillPaymentId,bill_month:mk,actual_amount:amount,is_paid:false});
        closeModal('modal-bill-amount');await loadBillPayments();
    }catch(e){alert('Error: '+e.message);}
}
async function saveBill(){
    const data={name:document.getElementById('bill-name').value.trim(),expected_amount:parseFloat(document.getElementById('bill-amount').value)||0,
        is_variable_amount:document.getElementById('bill-variable-amt').value==='true',due_day:parseInt(document.getElementById('bill-due-day').value)||null,
        is_variable_date:document.getElementById('bill-variable-date').value==='true',is_auto_pay:document.getElementById('bill-autopay').value==='true',
        pays_from:document.getElementById('bill-pays-from').value.trim(),category:document.getElementById('bill-category').value,notes:document.getElementById('bill-notes').value.trim()};
    if(!data.name)return alert('Enter a name.');
    try{
        if(editingBillId){await supaFetch('finance_bills','PATCH',data,`?id=eq.${editingBillId}`);editingBillId=null;document.getElementById('btn-cancel-bill').style.display='none';}
        else await supaFetch('finance_bills','POST',data);
        clearBillForm();await loadBills();await loadBillPayments();
    }catch(e){alert('Error: '+e.message);}
}
function editBill(id){
    const b=bills.find(x=>x.id===id);if(!b)return;editingBillId=id;
    document.getElementById('bill-name').value=b.name;document.getElementById('bill-amount').value=b.expected_amount;
    document.getElementById('bill-variable-amt').value=String(b.is_variable_amount);document.getElementById('bill-due-day').value=b.due_day||'';
    document.getElementById('bill-variable-date').value=String(b.is_variable_date);document.getElementById('bill-autopay').value=String(b.is_auto_pay);
    document.getElementById('bill-pays-from').value=b.pays_from||'';document.getElementById('bill-category').value=b.category||'other';
    document.getElementById('bill-notes').value=b.notes||'';document.getElementById('btn-cancel-bill').style.display='inline-block';
    window.scrollTo({top:0,behavior:'smooth'});
}
function cancelEditBill(){editingBillId=null;document.getElementById('btn-cancel-bill').style.display='none';clearBillForm();}
function clearBillForm(){['bill-name','bill-amount','bill-due-day','bill-pays-from','bill-notes'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('bill-variable-amt').value='false';document.getElementById('bill-variable-date').value='false';
    document.getElementById('bill-autopay').value='false';document.getElementById('bill-category').value='other';}
async function deleteBill(id){if(!confirm('Delete?'))return;try{await supaFetch('finance_bills','PATCH',{is_active:false},`?id=eq.${id}`);await loadBills();await loadBillPayments();}catch(e){alert(e.message);}}

// ==================== WEEKLY ENTRY ====================

function getWednesdays(){
    const weds=[];
    const start=new Date('2024-06-05T12:00:00');
    const end=new Date();
    end.setDate(end.getDate()+28);
    let d=new Date(start);
    while(d.getDay()!==3) d.setDate(d.getDate()+1);
    while(d<=end){
        const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
        weds.push(`${y}-${m}-${dd}`);
        d.setDate(d.getDate()+7);
    }
    return weds;
}

function populateWeekDropdown(){
    const sel=document.getElementById('entry-date');
    const weds=getWednesdays();
    const today=new Date();
    const dayOfWeek=today.getDay();
    const diff=dayOfWeek<=3?3-dayOfWeek:10-dayOfWeek;
    const thisWed=new Date(today);
    thisWed.setDate(today.getDate()+diff);
    const y=thisWed.getFullYear(), m=String(thisWed.getMonth()+1).padStart(2,'0'), dd=String(thisWed.getDate()).padStart(2,'0');
    const thisWedStr=`${y}-${m}-${dd}`;

    sel.innerHTML=weds.reverse().map(w=>{
        const dt=new Date(w+'T12:00:00');
        const label=dt.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'});
        const selected=w===thisWedStr?'selected':'';
        return`<option value="${w}" ${selected}>${label}</option>`;
    }).join('');
}

function shiftWeek(dir){
    const sel=document.getElementById('entry-date');
    const idx=sel.selectedIndex+dir;
    if(idx>=0 && idx<sel.options.length){
        sel.selectedIndex=idx;
        onWeekChange();
    }
}

async function onWeekChange(){
    loanDueDates={};
    buildWeeklyForm();
    const loaded=await loadWeekData();
    if(!loaded){
        await autoFillFromPrior();
    }
    // Always fill loans from schedule (skips accounts that already have data from saved week)
    await autoFillLoans(document.getElementById('entry-date').value, loaded);
    if(loaded){
        await fetchLoanDueDates(document.getElementById('entry-date').value);
    }
    await loadWeeklyBills();
    await calcCCSpent();
    await loadOtherPNC();
    await loadExtraPayment();
    updateTaxDueDates();
    autoDefaultBOA();
}

function autoDefaultBOA(){
    const boa=accounts.find(a=>a.name.toLowerCase().includes('boa'));
    if(!boa)return;
    const bI=document.querySelector(`input[data-id="${boa.id}"][data-f="bal"]`);
    const pI=document.querySelector(`input[data-id="${boa.id}"][data-f="pay"]`);
    if(bI && pI){
        const bal=parseFloat(bI.value)||0;
        const pay=parseFloat(pI.value)||0;
        // Only auto-fill if payment is 0 or empty and balance exists
        if(bal>0 && pay===0) pI.value=bal;
    }
    calcWeekly();
}

function updateTaxDueDates(){
    const dt=document.getElementById('entry-date').value;
    if(!dt)return;
    const weekDate=new Date(dt+'T12:00:00');
    const taxes=accounts.filter(a=>a.account_type==='tax_debt');
    taxes.forEach(a=>{
        // Find matching bill by name
        const bill=bills.find(b=>b.name.toLowerCase().includes(a.name.toLowerCase())||
            (a.name.toLowerCase().includes('fed')&&b.name.toLowerCase().includes('irs'))||
            (a.name.toLowerCase().includes('pa')&&b.name.toLowerCase().includes('pa')));
        if(bill){
            loanDueDates[a.id]=`${weekDate.getFullYear()}-${String(weekDate.getMonth()+1).padStart(2,'0')}-${String(bill.due_day).padStart(2,'0')}`;
        }
    });
    updateDueDateLabels();
}

async function calcCCSpent(){
    const dt=document.getElementById('entry-date').value;
    if(!dt)return;
    const d=new Date(dt+'T12:00:00');
    d.setDate(d.getDate()-7);
    const priorWeek=d.toISOString().split('T')[0];

    const ccs=accounts.filter(a=>a.account_type==='credit_card');
    if(!ccs.length)return;

    try{
        const priorEntries=await supaFetch('finance_weekly_entries','GET',null,
            `?entry_date=eq.${priorWeek}&account_id=in.(${ccs.map(a=>a.id).join(',')})`);

        priorCCEndings={};
        ccs.forEach(a=>{
            const prior=priorEntries?.find(e=>e.account_id===a.id);
            priorCCEndings[a.id]=prior?parseFloat(prior.ending_balance)||0:0;
        });
        updateCCSpentDisplay();
    }catch(e){console.error('CC spent calc:',e);}
}

function updateCCSpentDisplay(){
    const ccs=accounts.filter(a=>a.account_type==='credit_card');
    let totalSpent=0;
    ccs.forEach(a=>{
        const priorEnding=priorCCEndings[a.id]||0;
        const bI=document.querySelector(`input[data-id="${a.id}"][data-f="bal"]`);
        const thisStart=parseFloat(bI?.value)||0;
        const diff=thisStart-priorEnding;
        const spent=diff>0?diff:0;
        totalSpent+=spent;
        // Update per-line indicator
        const spentEl=document.querySelector(`.cc-spent[data-cc-id="${a.id}"]`);
        if(spentEl){
            if(spent>0) spentEl.textContent=`(+${fmt(spent)} spent)`;
            else if(diff<0) spentEl.textContent=`(${fmt(Math.abs(diff))} paid down)`;
            else spentEl.textContent='';
        }
    });
    const el=document.getElementById('we-cc-spent');
    if(el){
        el.textContent=fmt(totalSpent);
        el.className=`value ${totalSpent>0?'negative':'positive'}`;
    }
}

async function loadWeekData(){
    const dt=document.getElementById('entry-date').value;
    if(!dt)return false;
    try{
        const entries=await supaFetch('finance_weekly_entries','GET',null,`?entry_date=eq.${dt}`);
        if(!entries?.length)return false;
        entries.forEach(e=>{
            const bI=document.querySelector(`input[data-id="${e.account_id}"][data-f="bal"]`);
            const pI=document.querySelector(`input[data-id="${e.account_id}"][data-f="pay"]`);
            if(bI) bI.value=e.starting_balance||0;
            if(pI&&!pI.readOnly) pI.value=Math.abs(e.payment)||0;
        });
        calcWeekly();
        return true;
    }catch(e){console.error('Load week:',e);return false;}
}

async function autoFillFromPrior(){
    // Auto-fill tax balances from prior week's ending
    const dt=document.getElementById('entry-date').value;
    if(!dt)return;
    const d=new Date(dt+'T12:00:00');
    d.setDate(d.getDate()-7);
    const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0');
    const prevWed=`${y}-${m}-${dd}`;
    try{
        const prevEntries=await supaFetch('finance_weekly_entries','GET',null,`?entry_date=eq.${prevWed}`);
        if(!prevEntries?.length)return;
        // Fill tax account balances with prior ending
        const taxAccs=accounts.filter(a=>a.account_type==='tax_debt');
        prevEntries.forEach(e=>{
            const isTax=taxAccs.some(a=>a.id===e.account_id);
            if(isTax){
                const bI=document.querySelector(`input[data-id="${e.account_id}"][data-f="bal"]`);
                if(bI) bI.value=e.ending_balance||0;
            }
        });
        calcWeekly();
    }catch(e){console.error('Auto-fill:',e);}
}

let calculatedBillTotal=0;
let priorCCEndings={}; // account_id -> ending balance from prior week
let loanDueDates={}; // account_id -> next due date string

async function autoFillLoans(weekStr, hasSavedData){
    if(!weekStr)return;
    const weekDate=new Date(weekStr+'T12:00:00');
    const nextWed=new Date(weekDate);
    nextWed.setDate(nextWed.getDate()+7);
    const priorWed=new Date(weekDate);
    priorWed.setDate(priorWed.getDate()-7);
    const priorWedStr=priorWed.toISOString().split('T')[0];
    const wkEnd=nextWed.toISOString().split('T')[0];

    try{
        const weekPayments=await supaFetch('finance_loan_schedules','GET',null,
            `?due_date=gt.${priorWedStr}&due_date=lte.${weekStr}&order=due_date`);

        const loanAccounts=accounts.filter(a=>a.account_type==='loan');

        for(const a of loanAccounts){
            const bI=document.querySelector(`input[data-id="${a.id}"][data-f="bal"]`);
            const pI=document.querySelector(`input[data-id="${a.id}"][data-f="pay"]`);
            if(!bI||!pI)continue;

            // Skip if this account already has saved data
            const existingBal=parseFloat(bI.value)||0;
            const existingPay=parseFloat(pI.value)||0;
            if(hasSavedData && (existingBal!==0 || existingPay!==0)) continue;

            // Balance: latest schedule entry on or before this Wed
            const balEntries=await supaFetch('finance_loan_schedules','GET',null,
                `?account_id=eq.${a.id}&due_date=lte.${weekStr}&order=due_date.desc&limit=1`);
            if(balEntries?.length){
                bI.value=balEntries[0].balance_after;
            }

            // Payments due this week for this account
            const dueThisWeek=weekPayments?.filter(p=>p.account_id===a.id)||[];
            if(dueThisWeek.length){
                const totalPay=dueThisWeek.reduce((s,p)=>s+parseFloat(p.payment_amount),0);
                pI.value=totalPay.toFixed(2);
                loanDueDates[a.id]=dueThisWeek[0].due_date;
            }
        }

        // Also fetch next upcoming due date for each loan (for label display)
        for(const a of loanAccounts){
            if(!loanDueDates[a.id]){
                const next=await supaFetch('finance_loan_schedules','GET',null,
                    `?account_id=eq.${a.id}&due_date=gt.${weekStr}&order=due_date&limit=1`);
                if(next?.length) loanDueDates[a.id]=next[0].due_date;
            }
        }
        updateDueDateLabels();
        calcWeekly();
    }catch(e){console.error('Auto-fill loans:',e);}
}

function updateDueDateLabels(){
    const dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const monthNames=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    accounts.forEach(a=>{
        const dd=loanDueDates[a.id];
        if(!dd)return;
        const label=document.querySelector(`label[data-acct-id="${a.id}"] .due-date`);
        if(label){
            const d=new Date(dd+'T12:00:00');
            const day=d.getDate();
            const suffix=day===1||day===21||day===31?'st':day===2||day===22?'nd':day===3||day===23?'rd':'th';
            label.textContent=`üìÖ ${monthNames[d.getMonth()]} ${day}${suffix}`;
        }
    });
}

function isDueThisWeek(dueDay,weekStart,weekEnd){
    for(let m=0;m<2;m++){
        const checkDate=new Date(weekStart);
        checkDate.setMonth(checkDate.getMonth()+m);
        checkDate.setDate(dueDay);
        if(checkDate.getDate()!==dueDay)continue;
        if(checkDate>=weekStart && checkDate<weekEnd) return true;
    }
    return false;
}

async function fetchLoanDueDates(weekStr){
    if(!weekStr)return;
    const priorWed=new Date(weekStr+'T12:00:00');
    priorWed.setDate(priorWed.getDate()-7);
    const priorWedStr=priorWed.toISOString().split('T')[0];

    const loanAccounts=accounts.filter(a=>a.account_type==='loan');
    try{
        // Check for payments due this week
        const weekPayments=await supaFetch('finance_loan_schedules','GET',null,
            `?due_date=gt.${priorWedStr}&due_date=lte.${weekStr}&order=due_date`);
        loanAccounts.forEach(a=>{
            const due=weekPayments?.find(p=>p.account_id===a.id);
            if(due) loanDueDates[a.id]=due.due_date;
        });
        // For any without, get next upcoming
        for(const a of loanAccounts){
            if(!loanDueDates[a.id]){
                const next=await supaFetch('finance_loan_schedules','GET',null,
                    `?account_id=eq.${a.id}&due_date=gt.${weekStr}&order=due_date&limit=1`);
                if(next?.length) loanDueDates[a.id]=next[0].due_date;
            }
        }
        updateDueDateLabels();
    }catch(e){console.error('Fetch loan due dates:',e);}
}

async function loadWeeklyBills(){
    const dt=document.getElementById('entry-date').value;
    if(!dt||!bills.length){document.getElementById('weekly-bills-section').style.display='none';document.getElementById('weekly-bills-total-row').style.display='none';return;}

    const weekDate=new Date(dt+'T12:00:00');
    const nextWed=new Date(weekDate);
    nextWed.setDate(nextWed.getDate()+7);

    const mk1=`${weekDate.getFullYear()}-${String(weekDate.getMonth()+1).padStart(2,'0')}-01`;
    const mk2=`${nextWed.getFullYear()}-${String(nextWed.getMonth()+1).padStart(2,'0')}-01`;

    let payments=[];
    try{
        payments=await supaFetch('finance_bill_payments','GET',null,`?bill_month=eq.${mk1}`);
        if(mk2!==mk1){
            const p2=await supaFetch('finance_bill_payments','GET',null,`?bill_month=eq.${mk2}`);
            if(p2) payments=payments.concat(p2);
        }
    }catch(e){payments=[];}

    // Only show household bills - exclude tax and loan bills
    const excludeNames=['irs','pa tax','kubota','side by side'];
    const householdBills=bills.filter(b=>!excludeNames.some(n=>b.name.toLowerCase().includes(n)));

    // Find bills due between this Wed and next Wed
    const dueBills=[];
    householdBills.forEach(b=>{
        if(!b.due_day)return;
        for(let m=0;m<2;m++){
            const checkDate=new Date(weekDate);
            checkDate.setMonth(checkDate.getMonth()+m);
            checkDate.setDate(b.due_day);
            if(checkDate.getDate()!==b.due_day) continue;
            if(checkDate>=weekDate && checkDate<nextWed){
                const billMonth=`${checkDate.getFullYear()}-${String(checkDate.getMonth()+1).padStart(2,'0')}-01`;
                const p=payments.find(x=>x.bill_id===b.id && x.bill_month===billMonth);
                dueBills.push({bill:b, dueDate:new Date(checkDate), payment:p, billMonth});
                break;
            }
        }
    });

    dueBills.sort((a,b)=>a.dueDate-b.dueDate);

    const section=document.getElementById('weekly-bills-section');
    const list=document.getElementById('weekly-bills-list');
    const totalRow=document.getElementById('weekly-bills-total-row');
    section.style.display='';
    totalRow.style.display='flex';

    calculatedBillTotal=0;
    let html='';

    if(dueBills.length){
        html+=`<div style="display:grid;grid-template-columns:30px 1fr 110px 110px 60px;gap:8px;align-items:center;padding:8px 0;font-size:0.8rem;font-weight:600;color:var(--sage-600);text-transform:uppercase;letter-spacing:0.5px;border-bottom:2px solid var(--sage-300);">
            <div>‚úì</div><div>Bill</div><div style="text-align:center">Date</div><div style="text-align:right">Amount</div><div></div>
        </div>`;

        dueBills.forEach(({bill:b, dueDate, payment:p, billMonth})=>{
            const amt=p?.actual_amount||b.expected_amount||0;
            const paid=p?p.is_paid:true; // default to paid if no record
            const dateVal=p?.paid_date||`${dueDate.getFullYear()}-${String(dueDate.getMonth()+1).padStart(2,'0')}-${String(dueDate.getDate()).padStart(2,'0')}`;
            calculatedBillTotal+=amt;

            html+=`<div style="display:grid;grid-template-columns:30px 1fr 110px 110px 60px;gap:8px;align-items:center;padding:8px 0;border-bottom:1px solid var(--sage-100);${paid?'opacity:0.5':''}">
                <div><input type="checkbox" class="check-paid" data-bill-id="${b.id}" data-bill-month="${billMonth}" ${paid?'checked':''} onchange="toggleWeeklyBillPaid('${b.id}','${billMonth}',this.checked,this)" style="accent-color:var(--sage-500);width:18px;height:18px;cursor:pointer;"></div>
                <div>
                    <strong>${b.name}</strong>
                    ${b.is_variable_amount?'<span class="badge badge-variable" style="margin-left:4px;">~</span>':''}
                    ${b.is_auto_pay?'<span class="badge badge-auto" style="margin-left:4px;">Auto</span>':''}
                </div>
                <div><input type="date" value="${dateVal}" data-bill-id="${b.id}" data-bill-month="${billMonth}" data-field="date" style="padding:4px 6px;border:1px solid var(--sage-200);border-radius:6px;font-family:'Karla',sans-serif;font-size:0.85rem;width:100%;"></div>
                <div><input type="number" step="0.01" value="${amt.toFixed(2)}" data-bill-id="${b.id}" data-bill-month="${billMonth}" data-field="amount" onchange="recalcBillTotal()" style="padding:4px 8px;border:1px solid var(--sage-200);border-radius:6px;font-family:'Karla',sans-serif;font-size:0.9rem;text-align:right;width:100%;"></div>
                <div><button class="btn btn-small btn-secondary" onclick="saveWeeklyBill('${b.id}','${billMonth}')">‚úì</button></div>
            </div>`;
        });
    } else {
        html+='<p style="color:var(--sage-400);padding:12px 0;">No bills due before next Wednesday</p>';
    }

    // Monthly summary - household bills only
    let monthTotal=0, paidTotal=0;
    const mkCurrent=`${weekDate.getFullYear()}-${String(weekDate.getMonth()+1).padStart(2,'0')}-01`;
    householdBills.forEach(b=>{
        const p=payments.find(x=>x.bill_id===b.id && x.bill_month===mkCurrent);
        const amt=p?.actual_amount||b.expected_amount||0;
        monthTotal+=amt;
        if(p?.is_paid) paidTotal+=amt;
    });

    html+=`<div style="display:flex;justify-content:space-between;padding:8px 0;font-size:0.85rem;border-top:1px solid var(--sage-200);margin-top:8px;">
        <span>Month total: ${fmt(monthTotal)}</span>
        <span style="color:var(--green-soft);">Paid: ${fmt(paidTotal)}</span>
        <span style="color:var(--dusty-rose);">Remaining: ${fmt(monthTotal-paidTotal)}</span>
    </div>`;
    list.innerHTML=html;

    // Set the override total to calculated amount
    document.getElementById('bills-override-total').value=calculatedBillTotal.toFixed(2);
    calcWeekly();
}

function recalcBillTotal(){
    let total=0;
    document.querySelectorAll('#weekly-bills-list input[data-field="amount"]').forEach(input=>{
        total+=parseFloat(input.value)||0;
    });
    calculatedBillTotal=total;
    document.getElementById('bills-override-total').value=total.toFixed(2);
    calcWeekly();
}

function resetBillTotal(){
    document.getElementById('bills-override-total').value=calculatedBillTotal.toFixed(2);
    calcWeekly();
}

async function toggleWeeklyBillPaid(billId,billMonth,isPaid,checkbox){
    const row=checkbox.closest('div[style*="grid"]');
    const amtInput=row.querySelector('input[data-field="amount"]');
    const dateInput=row.querySelector('input[data-field="date"]');
    const amt=parseFloat(amtInput?.value)||0;
    const paidDate=dateInput?.value||null;

    try{
        const existing=await supaFetch('finance_bill_payments','GET',null,`?bill_id=eq.${billId}&bill_month=eq.${billMonth}`);
        if(existing?.length){
            await supaFetch('finance_bill_payments','PATCH',{is_paid:isPaid,actual_amount:amt,paid_date:isPaid?paidDate:null},`?id=eq.${existing[0].id}`);
        }else{
            await supaFetch('finance_bill_payments','POST',{bill_id:billId,bill_month:billMonth,actual_amount:amt,is_paid:isPaid,paid_date:isPaid?paidDate:null});
        }
        await loadWeeklyBills();
    }catch(e){alert('Error: '+e.message);}
}
async function saveWeeklyBill(billId,billMonth){
    const amtInput=document.querySelector(`input[data-bill-id="${billId}"][data-bill-month="${billMonth}"][data-field="amount"]`);
    const dateInput=document.querySelector(`input[data-bill-id="${billId}"][data-bill-month="${billMonth}"][data-field="date"]`);
    const amt=parseFloat(amtInput?.value)||0;
    const paidDate=dateInput?.value||null;

    try{
        const existing=await supaFetch('finance_bill_payments','GET',null,`?bill_id=eq.${billId}&bill_month=eq.${billMonth}`);
        if(existing?.length){
            await supaFetch('finance_bill_payments','PATCH',{actual_amount:amt,paid_date:paidDate},`?id=eq.${existing[0].id}`);
        }else{
            await supaFetch('finance_bill_payments','POST',{bill_id:billId,bill_month:billMonth,actual_amount:amt,is_paid:false,paid_date:paidDate});
        }
        await loadWeeklyBills();
    }catch(e){alert('Error: '+e.message);}
}

function buildWeeklyForm(){
    const c=document.getElementById('weekly-entries');
    if(!accounts.length){c.innerHTML='<p style="color:var(--sage-600);padding:12px 0;">Add accounts first.</p>';return;}

    const pnc=accounts.find(a=>a.name.toLowerCase().includes('pnc'));
    const rental=accounts.find(a=>a.name.toLowerCase().includes('rental'));
    const ccs=accounts.filter(a=>a.account_type==='credit_card');
    const taxes=accounts.filter(a=>a.account_type==='tax_debt');
    const loans=accounts.filter(a=>a.is_debt && a.account_type==='loan');
    const skipIds=new Set([pnc?.id,rental?.id,...ccs.map(a=>a.id),...taxes.map(a=>a.id),...loans.map(a=>a.id)].filter(Boolean));
    const recurringAcc=accounts.find(a=>a.name.toLowerCase().includes('recurring'));
    if(recurringAcc) skipIds.add(recurringAcc.id);
    const other=accounts.filter(a=>!skipIds.has(a.id));

    let h=`<div class="entry-row header"><div>Account</div><div style="text-align:right">Balance</div><div style="text-align:right">Payment</div><div style="text-align:right">Ending</div></div>`;

    if(pnc){
        h+=`<div class="section-divider">üí∞ PNC Checking</div>`;
        h+=`<div class="entry-row">
            <label>${pnc.name}</label>
            <input type="number" step="0.01" placeholder="0.00" data-id="${pnc.id}" data-f="bal" class="we-in" oninput="calcWeekly()">
            <input type="number" step="0.01" placeholder="0.00" data-id="${pnc.id}" data-f="pay" class="we-in" readonly style="background:var(--sage-100);font-weight:600;color:var(--sage-700);" title="Auto-calculated">
            <div class="calc" data-id="${pnc.id}" data-f="end">-</div>
        </div>
        <div style="font-size:0.75rem;color:var(--sage-400);padding:2px 0 6px;font-style:italic;">‚Üë Auto-totals from all payments + bills + other below</div>`;

        // Other PNC Payments (dynamic rows)
        h+=`<div class="section-divider" style="font-size:0.9rem;">üí∏ Other PNC Payments</div>`;
        h+=`<div id="other-pnc-rows"></div>`;
        h+=`<div style="display:flex;gap:8px;align-items:center;padding:4px 0 12px;">
            <button class="btn btn-small btn-secondary" onclick="addOtherPNC()">+ Add Payment</button>
            <div style="flex:1;text-align:right;font-weight:700;color:var(--sage-700);font-size:0.9rem;">Other Total: <span id="other-pnc-total">$0.00</span></div>
        </div>`;
    }

    if(ccs.length){
        h+=`<div class="section-divider">üí≥ Credit Cards</div>`;
        ccs.forEach(a=>{h+=ccEntryRow(a);});
        h+=sumRow('cc','CC Total');
    }

    if(taxes.length){
        h+=`<div class="section-divider">üèõÔ∏è Tax Debts</div>`;
        taxes.forEach(a=>{h+=entryRow(a,true);});
        h+=sumRow('tax','Tax Total');
    }

    if(loans.length){
        h+=`<div class="section-divider">üè¶ Loans</div>`;
        loans.forEach(a=>{
            h+=entryRow(a,true);
            if(a.name.toLowerCase().includes('prudential')){
                h+=`<div style="display:grid;grid-template-columns:1fr 120px 120px 120px;gap:8px;align-items:center;padding:2px 0 8px;margin-left:8px;" id="extra-pay-row">
                    <label style="font-size:0.85rem;color:var(--sage-500);font-style:italic;">‚Ü≥ Extra Payment</label>
                    <input type="number" step="0.01" placeholder="0.00" id="prudential-extra" data-acct-id="${a.id}" class="we-in" oninput="calcWeekly();previewExtraPayment()" style="border:2px dashed var(--sage-400);background:rgba(122,144,97,0.08);">
                    <div></div><div></div>
                </div>
                <div id="extra-pay-impact" style="margin:0 0 12px 8px;padding:10px 14px;border-radius:8px;background:rgba(122,144,97,0.1);border:1px solid var(--sage-300);display:none;">
                    <div style="font-size:0.8rem;color:var(--sage-600);font-weight:600;margin-bottom:4px;">üìä Extra Payment Impact</div>
                    <div id="extra-impact-details" style="font-size:0.85rem;color:var(--sage-700);line-height:1.6;"></div>
                </div>`;
            }
        });
        h+=sumRow('loan','Loan Total');
    }

    if(rental){
        h+=`<div class="section-divider">üè† Rental <span style="font-size:0.7rem;color:var(--sage-400);font-weight:400;margin-left:8px;">payment transfers from PNC</span></div>`;
        h+=entryRow(rental,false);
    }

    // Set Aside for Bills placeholder - filled by loadWeeklyBills
    h+=`<div class="section-divider" id="weekly-bills-section" style="display:none;">üìã Set Aside for Bills</div>`;
    h+=`<div id="weekly-bills-list"></div>`;
    h+=`<div id="weekly-bills-total-row" style="display:none;display:flex;align-items:center;gap:12px;margin:8px 0 12px;padding-top:8px;border-top:2px solid var(--sage-300);">
        <label style="font-weight:700;color:var(--sage-700);white-space:nowrap;font-size:0.9rem;">Bill Total (from PNC):</label>
        <input type="number" step="0.01" id="bills-override-total" oninput="calcWeekly()" style="padding:6px 10px;border:2px solid var(--sage-400);border-radius:8px;font-family:'Karla',sans-serif;font-size:1rem;font-weight:700;text-align:right;width:140px;background:white;color:var(--charcoal);">
        <button class="btn btn-small btn-secondary" onclick="resetBillTotal()" title="Reset to calculated total">‚Üª</button>
    </div>`;

    if(other.length){
        const filtered=other.filter(a=>!a.name.toLowerCase().includes('recurring'));
        if(filtered.length){
            h+=`<div class="section-divider">Other</div>`;
            filtered.forEach(a=>{h+=entryRow(a,false);});
        }
    }

    c.innerHTML=h;
}

function entryRow(a,showRate){
    const rateStr=showRate?' <span class="rate">'+a.interest_rate+'%</span>':'';
    const dueStr=(a.account_type==='loan'||a.account_type==='tax_debt')?' <span class="rate due-date" style="color:var(--sage-500);"></span>':'';
    return`<div class="entry-row">
        <label data-acct-id="${a.id}">${a.name}${rateStr}${dueStr}</label>
        <input type="number" step="0.01" placeholder="0.00" data-id="${a.id}" data-f="bal" class="we-in" oninput="calcWeekly()">
        <input type="number" step="0.01" placeholder="0.00" data-id="${a.id}" data-f="pay" class="we-in" oninput="calcWeekly()">
        <div class="calc" data-id="${a.id}" data-f="end">-</div>
    </div>`;
}

function ccEntryRow(a){
    const isBOA=a.name.toLowerCase().includes('boa');
    return`<div class="entry-row">
        <label data-acct-id="${a.id}">${a.name} <span class="rate">${a.interest_rate}%</span> <span class="cc-spent" data-cc-id="${a.id}" style="color:var(--sage-500);font-size:0.75rem;font-weight:400;"></span></label>
        <input type="number" step="0.01" placeholder="0.00" data-id="${a.id}" data-f="bal" data-type="credit_card" data-debt="true" class="we-in" oninput="${isBOA?'autoPayBOA(this);':''}calcWeekly()">
        <input type="number" step="0.01" placeholder="0.00" data-id="${a.id}" data-f="pay" class="we-in" oninput="calcWeekly()">
        <div class="calc" data-id="${a.id}" data-f="end">-</div>
    </div>`;
}

function autoPayBOA(balInput){
    const id=balInput.dataset.id;
    const payInput=document.querySelector(`input[data-id="${id}"][data-f="pay"]`);
    if(payInput) payInput.value=balInput.value;
}

// Other PNC Payments
let otherPNCCounter=0;
function addOtherPNC(desc='',amt=''){
    otherPNCCounter++;
    const container=document.getElementById('other-pnc-rows');
    const row=document.createElement('div');
    row.id=`opnc-${otherPNCCounter}`;
    row.style.cssText='display:grid;grid-template-columns:1fr 120px 30px;gap:8px;align-items:center;padding:4px 0;';
    row.innerHTML=`
        <input type="text" placeholder="Description (e.g. Childcare)" value="${desc}" class="opnc-desc" style="padding:6px 10px;border:1px solid var(--sage-200);border-radius:6px;font-family:'Karla',sans-serif;font-size:0.9rem;">
        <input type="number" step="0.01" placeholder="0.00" value="${amt}" class="opnc-amt" oninput="calcWeekly()" style="padding:6px 10px;border:1px solid var(--sage-200);border-radius:6px;font-family:'Karla',sans-serif;font-size:0.9rem;text-align:right;">
        <button onclick="this.parentElement.remove();calcWeekly();" style="background:none;border:none;cursor:pointer;font-size:1.1rem;color:var(--sage-400);" title="Remove">‚úï</button>
    `;
    container.appendChild(row);
}

function getOtherPNCTotal(){
    let total=0;
    document.querySelectorAll('.opnc-amt').forEach(i=>{total+=parseFloat(i.value)||0;});
    const el=document.getElementById('other-pnc-total');
    if(el) el.textContent=fmt(total);
    return total;
}

function getOtherPNCData(){
    const items=[];
    document.querySelectorAll('#other-pnc-rows > div').forEach(row=>{
        const desc=row.querySelector('.opnc-desc')?.value||'';
        const amt=parseFloat(row.querySelector('.opnc-amt')?.value)||0;
        if(desc||amt) items.push({description:desc,amount:amt});
    });
    return items;
}

async function loadOtherPNC(){
    const dt=document.getElementById('entry-date').value;
    if(!dt)return;
    const container=document.getElementById('other-pnc-rows');
    if(!container)return;
    container.innerHTML='';
    otherPNCCounter=0;
    try{
        const rows=await supaFetch('finance_other_payments','GET',null,`?entry_date=eq.${dt}&order=id`);
        if(rows?.length){
            rows.forEach(r=>addOtherPNC(r.description||'',r.amount||''));
        }
        calcWeekly();
    }catch(e){console.error('Load other PNC:',e);}
}

async function saveOtherPNC(dt){
    const items=getOtherPNCData();
    try{
        await supaFetch('finance_other_payments','DELETE',null,`?entry_date=eq.${dt}`);
        if(items.length){
            const rows=items.map(i=>({entry_date:dt,description:i.description,amount:i.amount}));
            await supaFetch('finance_other_payments','POST',rows);
        }
    }catch(e){console.error('Save other PNC:',e);}
}

function sumRow(prefix,label){
    return`<div class="entry-row" style="font-weight:700;color:var(--sage-700);border-top:2px solid var(--sage-300);padding-top:10px;">
        <label>${label}</label><div class="calc" id="sum-${prefix}-bal" style="text-align:right;padding-right:12px;">-</div><div class="calc" id="sum-${prefix}-pay" style="text-align:right;padding-right:12px;">-</div><div class="calc" id="sum-${prefix}-end" style="text-align:right;padding-right:12px;">-</div>
    </div>`;
}

function calcWeekly(){
    let totalDebt=0, totalDebtPay=0, pncBal=0;
    let ccBal=0,ccPay=0,ccEnd=0, taxBal=0,taxPay=0,taxEnd=0, loanBal=0,loanPay=0,loanEnd=0;
    let pncAutoPayTotal=0;
    let rentalIncome=0;

    const pncAcc=accounts.find(a=>a.name.toLowerCase().includes('pnc'));
    const rentalAcc=accounts.find(a=>a.name.toLowerCase().includes('rental'));
    const billsTotal=parseFloat(document.getElementById('bills-override-total')?.value)||0;

    accounts.forEach(a=>{
        const bI=document.querySelector(`input[data-id="${a.id}"][data-f="bal"]`);
        const pI=document.querySelector(`input[data-id="${a.id}"][data-f="pay"]`);
        const eD=document.querySelector(`div[data-id="${a.id}"][data-f="end"]`);
        if(!bI)return;

        if(pncAcc && a.id===pncAcc.id){
            pncBal=parseFloat(bI.value)||0;
            return;
        }

        const bal=parseFloat(bI.value)||0, pay=parseFloat(pI.value)||0;

        // Rental: payment is income (bal + pay)
        if(rentalAcc && a.id===rentalAcc.id){
            const end=bal+pay;
            eD.textContent=fmt(end); eD.className=`calc ${end<0?'negative':''}`;
            rentalIncome+=pay;
            return;
        }

        // Include extra payment for Prudential loan
        let extraForThis=0;
        if(a.name.toLowerCase().includes('prudential')){
            extraForThis=parseFloat(document.getElementById('prudential-extra')?.value)||0;
        }
        const end=bal-pay-extraForThis;
        eD.textContent=fmt(end); eD.className=`calc ${end<0?'negative':''}`;

        if(a.is_debt){totalDebt+=bal; totalDebtPay+=pay;}

        if(a.pays_from && a.pays_from.toLowerCase().includes('pnc') && pay>0){
            pncAutoPayTotal+=pay;
        }

        if(a.account_type==='credit_card'){ccBal+=bal;ccPay+=pay;ccEnd+=end;}
        if(a.account_type==='tax_debt'){taxBal+=bal;taxPay+=pay;taxEnd+=end;}
        if(a.is_debt&&a.account_type==='loan'){loanBal+=bal;loanPay+=pay;loanEnd+=end;}
    });

    // PNC: subtract expenses, add rental income
    if(pncAcc){
        const otherPNC=getOtherPNCTotal();
        const extraPay=parseFloat(document.getElementById('prudential-extra')?.value)||0;
        const totalOut=pncAutoPayTotal+billsTotal+otherPNC+extraPay;
        const pncPayInput=document.querySelector(`input[data-id="${pncAcc.id}"][data-f="pay"]`);
        const pncEndDiv=document.querySelector(`div[data-id="${pncAcc.id}"][data-f="end"]`);
        const netOut=totalOut+rentalIncome;
        if(pncPayInput) pncPayInput.value=netOut.toFixed(2);
        const pncEnding=pncBal-netOut;
        if(pncEndDiv){pncEndDiv.textContent=fmt(pncEnding);pncEndDiv.className=`calc ${pncEnding<0?'negative':''}`;}

        const afterAll=pncEnding-500;

        document.getElementById('we-after-reserve').textContent=fmt(afterAll);
        document.getElementById('we-after-reserve').className=`value ${afterAll>=0?'positive':'negative'}`;
        document.getElementById('we-bills-total').textContent=fmt(billsTotal);
    }

    const setSum=(id,val)=>{const el=document.getElementById(id);if(el)el.textContent=fmt(val);};
    setSum('sum-cc-bal',ccBal);setSum('sum-cc-pay',ccPay);setSum('sum-cc-end',ccEnd);
    setSum('sum-tax-bal',taxBal);setSum('sum-tax-pay',taxPay);setSum('sum-tax-end',taxEnd);
    setSum('sum-loan-bal',loanBal);setSum('sum-loan-pay',loanPay);setSum('sum-loan-end',loanEnd);

    document.getElementById('we-total-debt').textContent=fmt(totalDebt);
    document.getElementById('we-total-payments').textContent=fmt(totalDebtPay);
    updateCCSpentDisplay();
}

async function loadPreviousWeek(){
    const currentDate=document.getElementById('entry-date').value;
    if(!currentDate)return;
    // Find the Wednesday before this one
    const d=new Date(currentDate+'T00:00:00');
    d.setDate(d.getDate()-7);
    const prevWed=d.toISOString().split('T')[0];
    try{
        const prevEntries=await supaFetch('finance_weekly_entries','GET',null,`?entry_date=eq.${prevWed}`);
        if(!prevEntries?.length)return alert('No data for previous week.');
        prevEntries.forEach(e=>{
            const bI=document.querySelector(`input[data-id="${e.account_id}"][data-f="bal"]`);
            if(bI) bI.value=e.ending_balance||e.starting_balance||0;
        });
        calcWeekly();
    }catch(e){alert('Error: '+e.message);}
}

async function saveWeeklyEntries(){
    const dt=document.getElementById('entry-date').value;
    if(!dt)return alert('Pick a week.');
    const entries=[];
    const rentalAcc=accounts.find(a=>a.name.toLowerCase().includes('rental'));
    accounts.forEach(a=>{
        const bI=document.querySelector(`input[data-id="${a.id}"][data-f="bal"]`);
        const pI=document.querySelector(`input[data-id="${a.id}"][data-f="pay"]`);
        if(!bI)return;
        const bal=parseFloat(bI.value)||0, pay=parseFloat(pI.value)||0;
        const isRental=rentalAcc&&a.id===rentalAcc.id;
        let extraForLoan=0;
        if(a.name.toLowerCase().includes('prudential')){
            extraForLoan=parseFloat(document.getElementById('prudential-extra')?.value)||0;
        }
        const ending=isRental?bal+pay:bal-pay-extraForLoan;
        if(bal!==0||pay!==0) entries.push({entry_date:dt,account_id:a.id,starting_balance:bal,payment:isRental?pay:-pay,ending_balance:ending});
    });
    if(!entries.length)return alert('Enter at least one balance.');
    try{
        await supaFetch('finance_weekly_entries','DELETE',null,`?entry_date=eq.${dt}`);
        await supaFetch('finance_weekly_entries','POST',entries);

        // Also save all bill edits
        const billRows=document.querySelectorAll('#weekly-bills-list [data-bill-id]');
        const billPairs=new Set();
        billRows.forEach(el=>{
            const key=el.dataset.billId+'|'+el.dataset.billMonth;
            if(billPairs.has(key))return;
            billPairs.add(key);
            const billId=el.dataset.billId, billMonth=el.dataset.billMonth;
            const amtInput=document.querySelector(`input[data-bill-id="${billId}"][data-bill-month="${billMonth}"][data-field="amount"]`);
            const dateInput=document.querySelector(`input[data-bill-id="${billId}"][data-bill-month="${billMonth}"][data-field="date"]`);
            const checkbox=document.querySelector(`.check-paid[data-bill-id="${billId}"][data-bill-month="${billMonth}"]`);
            if(amtInput){
                const amt=parseFloat(amtInput.value)||0;
                const paidDate=dateInput?.value||null;
                const isPaid=checkbox?.checked||false;
                saveBillPayment(billId,billMonth,amt,paidDate,isPaid);
            }
        });

        // Save other PNC payments
        await saveOtherPNC(dt);

        // Save extra loan payment and recalculate schedule
        const extraMsg=await saveExtraPayment(dt);

        alert('Week saved!' + (extraMsg||''));
    }catch(e){alert('Error: '+e.message);}
}

async function saveBillPayment(billId,billMonth,amt,paidDate,isPaid){
    try{
        const existing=await supaFetch('finance_bill_payments','GET',null,`?bill_id=eq.${billId}&bill_month=eq.${billMonth}`);
        if(existing?.length){
            await supaFetch('finance_bill_payments','PATCH',{actual_amount:amt,paid_date:paidDate,is_paid:isPaid},`?id=eq.${existing[0].id}`);
        }else{
            await supaFetch('finance_bill_payments','POST',{bill_id:billId,bill_month:billMonth,actual_amount:amt,is_paid:isPaid,paid_date:paidDate});
        }
    }catch(e){console.error('Bill save error:',e);}
}

// ==================== EXTRA LOAN PAYMENTS ====================

async function previewExtraPayment(){
    const extraInput=document.getElementById('prudential-extra');
    const impactDiv=document.getElementById('extra-pay-impact');
    const detailsDiv=document.getElementById('extra-impact-details');
    const extraAmt=parseFloat(extraInput?.value)||0;
    
    if(extraAmt<=0){impactDiv.style.display='none';return;}
    impactDiv.style.display='block';
    detailsDiv.innerHTML='Calculating...';
    
    const accountId=extraInput.dataset.acctId;
    const weekStr=document.getElementById('entry-date').value;
    if(!accountId||!weekStr)return;
    
    try{
        const acct=accounts.find(a=>a.id===accountId);
        if(!acct)return;
        
        // Get full current schedule
        const schedule=await supaFetch('finance_loan_schedules','GET',null,
            `?account_id=eq.${accountId}&order=due_date`);
        if(!schedule?.length){detailsDiv.innerHTML='No schedule found.';return;}
        
        // Find current position - latest payment on or before this week
        let currentIdx=-1;
        for(let i=schedule.length-1;i>=0;i--){
            if(schedule[i].due_date<=weekStr){currentIdx=i;break;}
        }
        
        const currentBal=currentIdx>=0?parseFloat(schedule[currentIdx].balance_after):parseFloat(acct.starting_balance);
        const monthlyRate=(acct.interest_rate||0)/100/12;
        const monthlyPayment=acct.min_payment;
        const originalPayoff=schedule[schedule.length-1].due_date;
        const remainingPayments=schedule.length-(currentIdx+1);
        
        // Calculate original remaining interest
        let origInterest=0;
        for(let i=currentIdx+1;i<schedule.length;i++){
            origInterest+=parseFloat(schedule[i].interest)||0;
        }
        
        // Simulate with extra payment
        let newBal=Math.max(0,currentBal-extraAmt);
        let newPayments=0, newInterest=0;
        let simBal=newBal;
        let lastDate='';
        const nextDueIdx=currentIdx+1;
        
        if(simBal<=0){
            detailsDiv.innerHTML=`<strong style="color:var(--green-soft);">üéâ This would pay off the loan!</strong>`;
            return;
        }
        
        for(let i=0;i<remainingPayments+60;i++){
            if(simBal<=0)break;
            const dt=new Date(schedule[Math.min(nextDueIdx+i,schedule.length-1)]?.due_date+'T12:00:00'||new Date());
            if(i>=1){dt.setMonth(dt.getMonth()+i);}
            if(nextDueIdx+i<schedule.length){
                lastDate=schedule[nextDueIdx+i].due_date;
            } else {
                const base=new Date(schedule[nextDueIdx]?.due_date+'T12:00:00'||new Date());
                base.setMonth(base.getMonth()+i);
                lastDate=base.toISOString().split('T')[0];
            }
            
            const interest=Math.round(simBal*monthlyRate*100)/100;
            newInterest+=interest;
            let princ=monthlyPayment-interest;
            if(princ>=simBal){princ=simBal;}
            simBal=Math.max(0,Math.round((simBal-princ)*100)/100);
            newPayments++;
        }
        
        const savedPayments=remainingPayments-newPayments;
        const savedInterest=origInterest-newInterest;
        const origDate=new Date(originalPayoff+'T12:00:00');
        const newDate=new Date(lastDate+'T12:00:00');
        
        const fmtDate=d=>d.toLocaleDateString('en-US',{month:'short',year:'numeric'});
        
        let html=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">`;
        html+=`<div>Original payoff: <strong>${fmtDate(origDate)}</strong></div>`;
        html+=`<div>New payoff: <strong style="color:var(--green-soft);">${fmtDate(newDate)}</strong></div>`;
        if(savedPayments>0) html+=`<div>Payments saved: <strong style="color:var(--green-soft);">${savedPayments} months</strong></div>`;
        if(savedInterest>0) html+=`<div>Interest saved: <strong style="color:var(--green-soft);">${fmt(savedInterest)}</strong></div>`;
        html+=`</div>`;
        detailsDiv.innerHTML=html;
    }catch(e){
        console.error('Preview extra payment:',e);
        detailsDiv.innerHTML='Could not calculate impact.';
    }
}

async function saveExtraPayment(dt){
    const extraInput=document.getElementById('prudential-extra');
    const extraAmt=parseFloat(extraInput?.value)||0;
    const accountId=extraInput?.dataset?.acctId;
    if(!accountId||!dt)return '';
    
    // Delete any existing extra payment for this week
    try{
        await supaFetch('finance_extra_payments','DELETE',null,`?account_id=eq.${accountId}&entry_date=eq.${dt}`);
    }catch(e){}
    
    if(extraAmt<=0)return '';
    
    // Save the extra payment record
    await supaFetch('finance_extra_payments','POST',{account_id:accountId,entry_date:dt,amount:extraAmt});
    
    // Recalculate the amortization schedule
    return await recalculateLoanSchedule(accountId,dt,extraAmt);
}

async function recalculateLoanSchedule(accountId,weekStr,extraAmt){
    try{
        const acct=accounts.find(a=>a.id===accountId);
        if(!acct)return;
        
        // Get full current schedule
        const schedule=await supaFetch('finance_loan_schedules','GET',null,
            `?account_id=eq.${accountId}&order=due_date`);
        if(!schedule?.length)return;
        
        // Find current position
        let currentIdx=-1;
        for(let i=schedule.length-1;i>=0;i--){
            if(schedule[i].due_date<=weekStr){currentIdx=i;break;}
        }
        
        const currentBal=currentIdx>=0?parseFloat(schedule[currentIdx].balance_after):parseFloat(acct.starting_balance);
        const monthlyRate=(acct.interest_rate||0)/100/12;
        const monthlyPayment=acct.min_payment;
        
        // Apply extra payment to principal
        let newBal=Math.max(0,currentBal-extraAmt);
        
        // Delete all future schedule entries (after current position)
        const futurePayments=schedule.filter(s=>s.due_date>weekStr);
        if(futurePayments.length){
            await supaFetch('finance_loan_schedules','DELETE',null,
                `?account_id=eq.${accountId}&due_date=gt.${weekStr}`);
        }
        
        // Rebuild future schedule from new balance
        if(newBal<=0){
            // Loan is paid off! Update the current entry's balance_after
            if(currentIdx>=0){
                await supaFetch('finance_loan_schedules','PATCH',
                    {balance_after:0},
                    `?id=eq.${schedule[currentIdx].id}`);
            }
            alert(`üéâ Prudential Loan will be paid off with this extra payment!\nSchedule updated.`);
            return '';
        }
        
        const nextPayNum=(currentIdx>=0?schedule[currentIdx].payment_number:0)+1;
        const nextDueDate=futurePayments.length?futurePayments[0].due_date:null;
        
        if(!nextDueDate)return '';
        
        let bal=newBal;
        const newRows=[];
        let payNum=nextPayNum;
        
        for(let i=0;i<600;i++){  // safety limit
            if(bal<=0)break;
            
            const dt=new Date(nextDueDate+'T00:00:00');
            dt.setMonth(dt.getMonth()+i);
            const dateStr=dt.toISOString().split('T')[0];
            
            const interest=Math.round(bal*monthlyRate*100)/100;
            let payAmt=monthlyPayment;
            let princ=payAmt-interest;
            
            if(princ>=bal){
                princ=bal;
                payAmt=Math.round((bal+interest)*100)/100;
            } else {
                princ=Math.round(princ*100)/100;
            }
            
            const newBalAfter=Math.max(0,Math.round((bal-princ)*100)/100);
            
            newRows.push({
                account_id:accountId,
                payment_number:payNum,
                due_date:dateStr,
                payment_amount:payAmt,
                interest:interest,
                principal:princ,
                balance_after:newBalAfter
            });
            
            bal=newBalAfter;
            payNum++;
        }
        
        // Insert new schedule in batches
        for(let i=0;i<newRows.length;i+=50){
            await supaFetch('finance_loan_schedules','POST',newRows.slice(i,i+50));
        }
        
        const origPayoff=schedule[schedule.length-1].due_date;
        const newPayoff=newRows.length?newRows[newRows.length-1].due_date:origPayoff;
        const fmtD=d=>new Date(d+'T12:00:00').toLocaleDateString('en-US',{month:'long',year:'numeric'});
        
        return `\n\nüìä Prudential schedule recalculated!\nExtra payment: ${fmt(extraAmt)}\nNew payoff: ${fmtD(newPayoff)}\nPayments remaining: ${newRows.length}`;
        
    }catch(e){
        console.error('Recalculate schedule:',e);
        return '\n\n‚ö†Ô∏è Error recalculating schedule: '+e.message;
    }
}

async function loadExtraPayment(){
    const dt=document.getElementById('entry-date').value;
    const extraInput=document.getElementById('prudential-extra');
    if(!dt||!extraInput)return;
    const accountId=extraInput.dataset.acctId;
    if(!accountId)return;
    
    try{
        const rows=await supaFetch('finance_extra_payments','GET',null,
            `?account_id=eq.${accountId}&entry_date=eq.${dt}`);
        if(rows?.length){
            extraInput.value=rows[0].amount;
            previewExtraPayment();
        } else {
            extraInput.value='';
            document.getElementById('extra-pay-impact').style.display='none';
        }
    }catch(e){console.error('Load extra payment:',e);}
}

// ==================== HISTORY ====================
let historyEntries=[], historyOrdered=[], historyDates=[], historyAccMap={};
let visibleCols=new Set(); // account IDs that are visible

async function loadHistory(){
    try{
        historyEntries=await supaFetch('finance_weekly_entries','GET',null,'?order=entry_date.desc');
        if(!historyEntries?.length){document.getElementById('history-empty').style.display='block';document.getElementById('history-head').innerHTML='';document.getElementById('history-body').innerHTML='';return;}
        document.getElementById('history-empty').style.display='none';

        const allAcc=[...accounts,...closedAccounts];
        historyAccMap={};
        allAcc.forEach(a=>historyAccMap[a.id]=a);

        historyDates=[...new Set(historyEntries.map(e=>e.entry_date))];
        const accIds=[...new Set(historyEntries.map(e=>e.account_id))];
        historyOrdered=accIds.map(id=>historyAccMap[id]).filter(Boolean).sort((a,b)=>{
            if(a.is_debt!==b.is_debt)return a.is_debt?-1:1;
            return(a.display_order||0)-(b.display_order||0);
        });

        // Init visible columns (all on first load)
        if(visibleCols.size===0) historyOrdered.forEach(a=>visibleCols.add(a.id));

        buildColumnPicker();
        renderHistory();
    }catch(e){console.error('History:',e);}
}

function buildColumnPicker(){
    const container=document.getElementById('column-checks');
    container.innerHTML=historyOrdered.map(a=>`
        <label style="display:flex;align-items:center;gap:4px;font-size:0.85rem;cursor:pointer;color:var(--charcoal);">
            <input type="checkbox" ${visibleCols.has(a.id)?'checked':''} onchange="toggleCol('${a.id}',this.checked)" style="accent-color:var(--sage-500);">
            ${a.name}
        </label>
    `).join('');
}

function toggleCol(id,checked){
    if(checked)visibleCols.add(id); else visibleCols.delete(id);
    renderHistory();
}
function checkAllCols(on){
    historyOrdered.forEach(a=>{if(on)visibleCols.add(a.id);else visibleCols.delete(a.id);});
    buildColumnPicker();renderHistory();
}
function showDebtOnly(){
    visibleCols.clear();
    historyOrdered.filter(a=>a.is_debt).forEach(a=>visibleCols.add(a.id));
    buildColumnPicker();renderHistory();
}
function showBanksOnly(){
    visibleCols.clear();
    historyOrdered.filter(a=>!a.is_debt).forEach(a=>visibleCols.add(a.id));
    buildColumnPicker();renderHistory();
}
function toggleColumnPicker(){
    const el=document.getElementById('column-picker');
    el.style.display=el.style.display==='none'?'block':'none';
}
function resetHistoryFilters(){
    document.getElementById('hist-from').value='';
    document.getElementById('hist-to').value='';
    renderHistory();
}

function renderHistory(){
    const fromDate=document.getElementById('hist-from').value;
    const toDate=document.getElementById('hist-to').value;

    // Filter dates
    let dates=historyDates;
    if(fromDate) dates=dates.filter(d=>d>=fromDate);
    if(toDate) dates=dates.filter(d=>d<=toDate);

    // Visible accounts
    const shown=historyOrdered.filter(a=>visibleCols.has(a.id));
    const hasDebt=shown.some(a=>a.is_debt);

    document.getElementById('history-head').innerHTML=`<tr><th>Date</th>${shown.map(a=>`<th class="amount">${a.name}</th>`).join('')}${hasDebt?'<th class="amount">Total Debt</th>':''}</tr>`;

    document.getElementById('history-body').innerHTML=dates.map((date,i)=>{
        const week=historyEntries.filter(e=>e.entry_date===date), eMap={};
        week.forEach(e=>eMap[e.account_id]=e);
        let debt=0;
        const cells=shown.map(a=>{
            const e=eMap[a.id];
            if(e){if(a.is_debt)debt+=e.ending_balance;return`<td class="amount">${fmt(e.ending_balance)}</td>`;}
            return`<td class="amount" style="color:var(--sage-300)">-</td>`;
        }).join('');

        let prevDebt=0, debtCell='';
        if(hasDebt){
            const nextIdx=historyDates.indexOf(dates[i])+1;
            if(nextIdx<historyDates.length){
                const prevDate=historyDates[nextIdx];
                historyEntries.filter(e=>e.entry_date===prevDate).forEach(e=>{const a=historyAccMap[e.account_id];if(a?.is_debt&&visibleCols.has(a.id))prevDebt+=e.ending_balance;});
            }
            const chg=nextIdx<historyDates.length?debt-prevDebt:0;
            debtCell=`<td class="amount">${fmt(debt)}${chg!==0?`<br><small class="${chg<0?'positive':'negative'}">${chg<0?'‚ñº':'‚ñ≤'} ${fmt(Math.abs(chg))}</small>`:''}</td>`;
        }

        return`<tr><td><strong>${fmtShort(date)}</strong></td>${cells}${debtCell}</tr>`;
    }).join('');
}

// ==================== AI CATEGORIZATION ====================
let aiSuggestions=[];

async function aiCategorize(){
    if(!txnData.length)return alert('No transactions loaded.');
    
    const btn=document.getElementById('btn-ai-cat');
    btn.disabled=true;
    btn.textContent='ü§ñ Working...';
    
    const cats=getCatOptions();
    const allAcc=[...accounts,...closedAccounts];
    const accMap={};allAcc.forEach(a=>accMap[a.id]=a);
    
    // Build transaction list for AI - batch in chunks of 50
    aiSuggestions=[];
    const batchSize=50;
    
    try{
        for(let i=0;i<txnData.length;i+=batchSize){
            const batch=txnData.slice(i,i+batchSize);
            btn.textContent=`ü§ñ ${Math.min(i+batchSize,txnData.length)}/${txnData.length}...`;
            
            const txnList=batch.map(t=>{
                const acctName=accMap[t.account_id]?.name||'Unknown';
                return `ID:${t.id} | Account:${acctName} | ${t.transaction_date} | ${t.description} | ${t.amount<0?'-':''}$${Math.abs(t.amount).toFixed(2)} | Current:${t.category||'Uncategorized'}`;
            }).join('\n');
            
            const prompt=`You are categorizing bank transactions. Assign each transaction one category from this list ONLY:\n${cats.join(', ')}\n\nRules:\n- ALL transactions from "BOA CC" account must be "Girls"\n- DraftKings = "Draftkings"\n- Zelle with Colette or Martin = "Internal Transfer"\n- Grocery stores (ShopRite, Walmart, Aldi) = "Groceries"\n- Gas stations (Wawa, Sheetz, Sunoco) = "Auto"\n- Zaritza = "Rent Payment"\n- Use your best judgment for the rest based on the description\n\nTransactions:\n${txnList}\n\nRespond with ONLY a JSON array of objects, no markdown, no backticks. Each object: {"id": number, "category": "string"}\nExample: [{"id":123,"category":"Groceries"},{"id":456,"category":"Auto"}]`;
            
            const response=await fetch('https://api.anthropic.com/v1/messages',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({
                    model:'claude-sonnet-4-20250514',
                    max_tokens:4000,
                    messages:[{role:'user',content:prompt}]
                })
            });
            
            const data=await response.json();
            const text=data.content?.map(c=>c.text||'').join('')||'';
            const clean=text.replace(/```json|```/g,'').trim();
            
            try{
                const results=JSON.parse(clean);
                aiSuggestions.push(...results);
            }catch(e){
                console.error('Parse error for batch:',e,clean);
            }
        }
        
        showAIReview();
    }catch(e){
        alert('AI error: '+e.message);
        console.error('AI categorize:',e);
    }finally{
        btn.disabled=false;
        btn.textContent='ü§ñ AI Categorize';
    }
}

function showAIReview(){
    const allAcc=[...accounts,...closedAccounts];
    const accMap={};allAcc.forEach(a=>accMap[a.id]=a);
    const cats=getCatOptions();
    
    // Build a map of suggestions
    const sugMap={};
    aiSuggestions.forEach(s=>sugMap[s.id]=s.category);
    
    // Count changes
    let changed=0,same=0;
    txnData.forEach(t=>{
        if(sugMap[t.id]&&sugMap[t.id]!==t.category)changed++;
        else same++;
    });
    
    document.getElementById('ai-review-status').textContent=`${changed} changes suggested, ${same} unchanged`;
    
    const catOptions=cats.map(c=>`<option value="${c}">${c}</option>`).join('');
    
    let html=`<div style="font-size:0.75rem;display:grid;grid-template-columns:30px 80px 1fr 130px 30px 130px;gap:6px;align-items:center;padding:6px 0;font-weight:600;color:var(--sage-600);text-transform:uppercase;letter-spacing:0.5px;border-bottom:2px solid var(--sage-300);position:sticky;top:0;background:var(--cream);z-index:1;">
        <div>‚úì</div><div>Date</div><div>Description</div><div>Current</div><div>‚Üí</div><div>Suggested</div>
    </div>`;
    
    txnData.forEach(t=>{
        const sug=sugMap[t.id]||t.category||'Uncategorized';
        const isChanged=sug!==t.category;
        const desc=(t.description||'').length>40?(t.description||'').substring(0,40)+'‚Ä¶':(t.description||'');
        
        html+=`<div style="display:grid;grid-template-columns:30px 80px 1fr 130px 30px 130px;gap:6px;align-items:center;padding:6px 0;border-bottom:1px solid var(--sage-100);${isChanged?'background:rgba(122,144,97,0.06);':'opacity:0.5;'}" data-ai-id="${t.id}">
            <div><input type="checkbox" ${isChanged?'checked':''} class="ai-check" data-ai-id="${t.id}" style="accent-color:var(--sage-500);width:16px;height:16px;cursor:pointer;"></div>
            <div style="font-size:0.8rem;white-space:nowrap;">${t.transaction_date}</div>
            <div style="font-size:0.8rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${(t.description||'').replace(/"/g,'&quot;')}">${desc}</div>
            <div style="font-size:0.8rem;color:var(--sage-500);">${t.category||'‚Äî'}</div>
            <div style="color:${isChanged?'var(--sage-500)':'var(--sage-300)'};">${isChanged?'‚Üí':'='}</div>
            <div><select class="ai-cat-select" data-ai-id="${t.id}" style="padding:4px 6px;border:1px solid ${isChanged?'var(--sage-400)':'var(--sage-200)'};border-radius:6px;font-family:'Karla',sans-serif;font-size:0.8rem;width:100%;${isChanged?'font-weight:600;background:rgba(122,144,97,0.1);':''}">
                ${catOptions.replace(`value="${sug}"`,`value="${sug}" selected`)}
            </select></div>
        </div>`;
    });
    
    document.getElementById('ai-review-list').innerHTML=html;
    document.getElementById('modal-ai-review').classList.add('active');
}

async function applyAISuggestions(){
    const btn=document.getElementById('btn-ai-apply');
    btn.disabled=true;
    btn.textContent='Saving...';
    
    const updates=[];
    document.querySelectorAll('.ai-check:checked').forEach(cb=>{
        const id=parseInt(cb.dataset.aiId);
        const sel=document.querySelector(`.ai-cat-select[data-ai-id="${id}"]`);
        const txn=txnData.find(t=>t.id===id);
        if(sel&&txn&&sel.value!==txn.category){
            updates.push({id,category:sel.value});
        }
    });
    
    if(!updates.length){
        closeModal('modal-ai-review');
        btn.disabled=false;
        btn.textContent='‚úÖ Apply All';
        return;
    }
    
    try{
        // Batch update in groups of 20
        for(let i=0;i<updates.length;i+=20){
            const batch=updates.slice(i,i+20);
            for(const u of batch){
                await supaFetch('finance_transactions','PATCH',{category:u.category},`?id=eq.${u.id}`);
            }
        }
        
        closeModal('modal-ai-review');
        await loadTransactions();
        await loadCategoryFilter();
        alert(`‚úÖ Updated ${updates.length} transactions!`);
    }catch(e){
        alert('Error saving: '+e.message);
    }finally{
        btn.disabled=false;
        btn.textContent='‚úÖ Apply All';
    }
}

// ==================== INIT ====================
// ==================== DASHBOARD ====================
let dashWeekOffset=0;

function getDashWeekRange(offset=0){
    const today=new Date();
    const dayOfWeek=today.getDay();
    const diff=dayOfWeek<=3?3-dayOfWeek:10-dayOfWeek;
    const thisWed=new Date(today);
    thisWed.setDate(today.getDate()+diff);
    thisWed.setDate(thisWed.getDate()+(offset*7));
    const twoWeeksAgo=new Date(thisWed);
    twoWeeksAgo.setDate(twoWeeksAgo.getDate()-14);
    const fmt=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    return {start:fmt(twoWeeksAgo), end:fmt(thisWed), label:twoWeeksAgo.toLocaleDateString('en-US',{month:'short',day:'numeric'})+' ‚Äì '+thisWed.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})};
}

function shiftDashWeek(dir){
    dashWeekOffset+=dir;
    loadDashboard();
}

async function loadDashboard(){
    try{
        const week=getDashWeekRange(dashWeekOffset);
        document.getElementById('dash-week-label').textContent=week.label;

        const allAcc=[...accounts,...closedAccounts];
        const accMap={};allAcc.forEach(a=>accMap[a.id]=a);
        const ccAccs=allAcc.filter(a=>a.account_type==='credit_card');
        const boaAcc=ccAccs.find(a=>a.name?.toLowerCase().includes('boa'));
        const taxAccs=allAcc.filter(a=>a.account_type==='tax_debt');
        const loanAccs=accounts.filter(a=>a.account_type==='loan');

        // === 1. BOA Girls spending from transactions ===
        let boaGirlsSpent=0;
        let boaGirlsTxns=[];
        if(boaAcc){
            const txns=await supaFetch('finance_transactions','GET',null,
                `?account_id=eq.${boaAcc.id}&category=eq.Girls&transaction_date=gt.${week.start}&transaction_date=lte.${week.end}&amount=lt.0&order=transaction_date.desc`);
            if(txns?.length){
                boaGirlsTxns=txns;
                boaGirlsSpent=txns.reduce((s,t)=>s+Math.abs(parseFloat(t.amount)||0),0);
            }
        }

        // === 2. All other CC spending (from weekly entries: start - prior end) ===
        let otherCCSpent=0;
        for(const cc of ccAccs){
            if(boaAcc && cc.id===boaAcc.id) continue;
            const rows=await supaFetch('finance_weekly_entries','GET',null,
                `?account_id=eq.${cc.id}&entry_date=gte.${week.start}&entry_date=lte.${week.end}&order=entry_date.desc&limit=1`);
            if(rows?.length){
                const thisStart=parseFloat(rows[0].starting_balance)||0;
                // Get prior week ending
                const prior=await supaFetch('finance_weekly_entries','GET',null,
                    `?account_id=eq.${cc.id}&entry_date=lt.${week.start}&order=entry_date.desc&limit=1`);
                if(prior?.length){
                    const prevEnd=parseFloat(prior[0].ending_balance)||0;
                    const spent=Math.max(0,thisStart-prevEnd);
                    otherCCSpent+=spent;
                }
            }
        }

        // === 3. Debt difference from last week ===
        // Get total debt for this week and prior week
        let thisWeekDebt=0, priorWeekDebt=0;

        // This week entries
        const thisEntries=await supaFetch('finance_weekly_entries','GET',null,
            `?entry_date=eq.${week.end}&order=entry_date.desc`);
        if(thisEntries?.length){
            thisEntries.forEach(e=>{
                const a=accMap[e.account_id];
                if(a&&a.is_debt) thisWeekDebt+=parseFloat(e.ending_balance)||0;
            });
        }
        // Add loans from schedule for this week
        let thisWeekLoans=0;
        for(const a of loanAccs){
            const r=await supaFetch('finance_loan_schedules','GET',null,
                `?account_id=eq.${a.id}&due_date=lte.${week.end}&order=due_date.desc&limit=1`);
            if(r?.length) thisWeekLoans+=parseFloat(r[0].balance_after)||0;
            else thisWeekLoans+=parseFloat(a.starting_balance)||0;
        }
        thisWeekDebt+=thisWeekLoans;

        // Prior week entries
        const priorEntries=await supaFetch('finance_weekly_entries','GET',null,
            `?entry_date=eq.${week.start}&order=entry_date.desc`);
        if(priorEntries?.length){
            priorEntries.forEach(e=>{
                const a=accMap[e.account_id];
                if(a&&a.is_debt) priorWeekDebt+=parseFloat(e.ending_balance)||0;
            });
        }
        let priorWeekLoans=0;
        for(const a of loanAccs){
            const r=await supaFetch('finance_loan_schedules','GET',null,
                `?account_id=eq.${a.id}&due_date=lte.${week.start}&order=due_date.desc&limit=1`);
            if(r?.length) priorWeekLoans+=parseFloat(r[0].balance_after)||0;
            else priorWeekLoans+=parseFloat(a.starting_balance)||0;
        }
        priorWeekDebt+=priorWeekLoans;

        const debtDiff=thisWeekDebt-priorWeekDebt;

        // === 4. Overall totals (from most recent data) ===
        let totalDebt=thisWeekDebt;
        let totalTax=0;
        let ccDebt=0;
        let loanDebt=thisWeekLoans;

        // CC debt from latest entries
        for(const cc of ccAccs){
            const rows=await supaFetch('finance_weekly_entries','GET',null,
                `?account_id=eq.${cc.id}&order=entry_date.desc&limit=1`);
            if(rows?.length) ccDebt+=parseFloat(rows[0].ending_balance)||0;
        }

        if(thisEntries?.length){
            thisEntries.forEach(e=>{
                const a=accMap[e.account_id];
                if(a&&a.account_type==='tax_debt') totalTax+=parseFloat(e.ending_balance)||0;
            });
        }else{
            // Fallback to latest entries for any week
            for(const t of taxAccs){
                const rows=await supaFetch('finance_weekly_entries','GET',null,
                    `?account_id=eq.${t.id}&order=entry_date.desc&limit=1`);
                if(rows?.length) totalTax+=parseFloat(rows[0].ending_balance)||0;
            }
        }

        // === 5. Charges over $200 from transactions (exclude payments/credits) ===
        const bigCharges=await supaFetch('finance_transactions','GET',null,
            `?transaction_date=gt.${week.start}&transaction_date=lte.${week.end}&order=transaction_date.desc`);
        const over200=(bigCharges||[]).filter(t=>{
            const amt=parseFloat(t.amount)||0;
            return amt<0 && Math.abs(amt)>=200;
        });

        // === BUILD CARDS ===
        const card=(label,value,icon,extraClass='')=>`
            <div style="background:white;padding:20px;border-radius:12px;text-align:center;border:2px solid var(--sage-200);">
                <div style="font-size:0.7rem;text-transform:uppercase;letter-spacing:1px;color:var(--sage-500);">${icon} ${label}</div>
                <div style="font-size:1.6rem;font-weight:700;font-family:'Crimson Pro',serif;margin-top:6px;color:var(--sage-700);${extraClass}">${value}</div>
            </div>`;

        const diffSign=debtDiff>0?'+':'';
        const diffColor=debtDiff>0?'color:#c0392b;':'color:#27ae60;';
        const diffIcon=debtDiff>0?'üî¥':'üü¢';

        document.getElementById('dash-cards').innerHTML=
            card('BOA Girls Spent',fmt(boaGirlsSpent),'üëß')+
            card('Other CC Spent',fmt(otherCCSpent),'üí≥')+
            card('Debt Change',diffSign+fmt(Math.abs(debtDiff)),diffIcon,diffColor);

        document.getElementById('dash-total-debt').textContent=fmt(totalDebt);
        document.getElementById('dash-cc-debt').textContent=fmt(ccDebt);
        document.getElementById('dash-loan-debt').textContent=fmt(loanDebt);
        document.getElementById('dash-total-tax').textContent=fmt(totalTax);

        // === BUILD $200+ TABLE ===
        const bigEl=document.getElementById('dash-big-charges');
        if(over200.length){
            let tbl=`<h3 style="font-family:'Crimson Pro',serif;font-size:1.1rem;color:var(--sage-700);margin-bottom:10px;">üî¥ Charges Over $200</h3>
                <div class="table-scroll"><table class="data-table"><thead><tr>
                    <th>Date</th><th>Account</th><th>Description</th><th>Category</th><th style="text-align:right;">Amount</th>
                </tr></thead><tbody>`;
            over200.forEach(t=>{
                const acctName=accMap[t.account_id]?.name||'?';
                tbl+=`<tr>
                    <td style="white-space:nowrap;">${t.transaction_date}</td>
                    <td style="font-size:0.8rem;">${acctName}</td>
                    <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${(t.description||'').replace(/"/g,'&quot;')}">${t.description||''}</td>
                    <td><span class="badge" style="background:var(--sage-100);color:var(--sage-600);">${t.category||'‚Äî'}</span></td>
                    <td style="text-align:right;font-weight:600;">${fmt(Math.abs(parseFloat(t.amount)||0))}</td>
                </tr>`;
            });
            tbl+=`</tbody></table></div>`;
            bigEl.innerHTML=tbl;
        }else{
            bigEl.innerHTML='';
        }

        // === BUILD BOA GIRLS TABLE ===
        const boaEl=document.getElementById('dash-boa-girls');
        if(boaGirlsTxns.length){
            let tbl=`<h3 style="font-family:'Crimson Pro',serif;font-size:1.1rem;color:var(--sage-700);margin-bottom:10px;">üëß BOA Girls Charges</h3>
                <div class="table-scroll"><table class="data-table"><thead><tr>
                    <th>Date</th><th>Description</th><th style="text-align:right;">Amount</th>
                </tr></thead><tbody>`;
            let girlsTotal=0;
            boaGirlsTxns.forEach(t=>{
                const amt=Math.abs(parseFloat(t.amount)||0);
                girlsTotal+=amt;
                tbl+=`<tr>
                    <td style="white-space:nowrap;">${t.transaction_date}</td>
                    <td style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${(t.description||'').replace(/"/g,'&quot;')}">${t.description||''}</td>
                    <td style="text-align:right;font-weight:600;">${fmt(amt)}</td>
                </tr>`;
            });
            tbl+=`<tr style="font-weight:700;border-top:2px solid var(--sage-500);">
                <td colspan="2" style="text-align:right;">Total</td>
                <td style="text-align:right;">${fmt(girlsTotal)}</td>
            </tr></tbody></table></div>`;
            boaEl.innerHTML=tbl;
        }else{
            boaEl.innerHTML='';
        }

    }catch(e){console.error('Dashboard:',e);}
}

// ==================== CSV PARSING HELPERS ====================

function detectCSVFormat(headers){
    const h=headers.map(c=>c.trim().toLowerCase());
    if(h.includes('reference number')&&h.includes('payee')) return 'boa';
    if(h.includes('details')&&h.includes('posting date')&&h.includes('type')) return 'chase_checking';
    if(h.includes('category')&&h.includes('post date')) return 'chase';
    if(h.includes('transaction description')&&h.includes('balance')) return 'pnc';
    if(h[0]==='date'&&h[1]==='description'&&h[2]==='amount'&&h[3]&&h[3].includes('running')) return 'boa_checking';
    return 'unknown';
}

// Map accounts to expected CSV formats
const accountFormatMap={};
function buildAccountFormatMap(){
    const allAcc=[...accounts,...closedAccounts];
    allAcc.forEach(a=>{
        const n=a.name.toLowerCase();
        if(n.includes('family cc')||n.includes('prime')||n.includes('chase cc')) accountFormatMap[a.id]='chase';
        else if(n==='boa cc') accountFormatMap[a.id]='boa';
        else if(n.includes('pnc')) accountFormatMap[a.id]='pnc';
        else if(n==='boa checking') accountFormatMap[a.id]='boa_checking';
        else if(n.includes('rental')) accountFormatMap[a.id]='chase_checking';
    });
}

function parseCSVLine(line){
    const result=[];
    let current='';
    let inQuotes=false;
    for(let i=0;i<line.length;i++){
        const c=line[i];
        if(c==='"'){inQuotes=!inQuotes;}
        else if(c===','&&!inQuotes){result.push(current.trim());current='';}
        else{current+=c;}
    }
    result.push(current.trim());
    return result;
}

function parsePNCAmount(str){
    if(!str)return 0;
    const clean=str.replace(/[$,\s"]/g,'');
    if(clean.startsWith('-')) return parseFloat(clean);
    if(clean.startsWith('+')) return parseFloat(clean);
    return parseFloat(clean)||0;
}

function parseDate(str){
    if(!str)return null;
    const s=str.replace(/"/g,'').trim();
    if(s.toUpperCase().startsWith('PENDING')) return null;
    if(s.match(/^\d{4}-\d{2}-\d{2}$/)) return s;
    const m=s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if(m) return `${m[3]}-${m[1]}-${m[2]}`;
    return null;
}

function guessCategory(desc){
    if(!desc)return 'Uncategorized';
    const upper=desc.toUpperCase();
    for(const rule of categoryRules){
        if(upper.includes(rule.pattern.toUpperCase())) return rule.category;
    }
    return 'Uncategorized';
}

function hashTxn(date,desc,amount,ref){
    const key=ref?`${ref}`:`${date}|${desc}|${amount}`;
    let h=0;
    for(let i=0;i<key.length;i++){h=((h<<5)-h)+key.charCodeAt(i);h|=0;}
    return Math.abs(h).toString(36);
}

// ==================== IMPORT TAB ====================
let categoryRules=[];
let txnData=[];
let lastImport=null;
let txnSort={col:'transaction_date',dir:'desc'};
let txnSelected=new Set();
let financeCategories=[];

async function loadFinanceCategories(){
    try{
        financeCategories=await supaFetch('finance_categories','GET',null,'?order=sort_order');
    }catch(e){financeCategories=[];console.error('Load categories:',e);}
}

function initImportTab(){
    buildAccountFormatMap();
}

function dzDropSingle(e){
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    const files=e.dataTransfer.files;
    for(const file of files) autoDetectAndImport(file);
}
function dzFileSelectSingle(e){
    const files=e.target.files;
    for(const file of files) autoDetectAndImport(file);
    e.target.value='';
}

async function autoDetectAndImport(file){
    const log=document.getElementById('import-log');
    const entryId='imp-'+Date.now();
    log.insertAdjacentHTML('afterbegin',`<div id="${entryId}" style="padding:12px;margin-bottom:8px;border-radius:8px;background:var(--sage-50);border:1px solid var(--sage-200);">
        <strong>${file.name}</strong> ‚Äî <span class="imp-status">Reading...</span></div>`);
    const statusEl=document.querySelector(`#${entryId} .imp-status`);
    
    buildAccountFormatMap();
    const importAccounts=[...accounts,...closedAccounts];
    const importNames=['family cc','prime','chase cc','boa cc','pnc checking','rental account','pnc 1407','boa checking'];
    const eligible=importAccounts.filter(a=>importNames.includes(a.name.toLowerCase()));
    
    const text=await file.text();
    const lines=text.split('\n').filter(l=>l.trim());
    if(lines.length<2){statusEl.textContent='File appears empty.';statusEl.style.color='#c44';return;}
    
    // Find header row
    let headerIdx=0;
    for(let i=0;i<Math.min(lines.length,15);i++){
        const test=parseCSVLine(lines[i]).map(c=>c.trim().toLowerCase());
        if(test[0]==='date'&&test[1]==='description'&&test[2]==='amount'&&test[3]&&test[3].includes('running')){
            headerIdx=i;break;
        }
    }
    const headers=parseCSVLine(lines[headerIdx]);
    const detectedFormat=detectCSVFormat(headers);
    
    if(detectedFormat==='unknown'){
        statusEl.innerHTML='‚ùå Unrecognized CSV format';statusEl.style.color='#c44';return;
    }
    
    // Find matching accounts by format
    const formatMatches=eligible.filter(a=>accountFormatMap[a.id]===detectedFormat);
    
    if(!formatMatches.length){
        statusEl.innerHTML=`‚ùå No account set up for this format (${detectedFormat})`;statusEl.style.color='#c44';return;
    }
    
    // Narrow down by last 4 digits in filename or file content
    let match=null;
    if(formatMatches.length===1){
        match=formatMatches[0];
    } else {
        // Check last 4 in filename first, then file content
        for(const a of formatMatches){
            if(a.last_4&&file.name.includes(a.last_4)){match=a;break;}
        }
        if(!match){
            for(const a of formatMatches){
                if(a.last_4&&text.includes(a.last_4)){match=a;break;}
            }
        }
        if(!match){
            // Can't determine ‚Äî ask user
            const names=formatMatches.map(a=>`${a.name}${a.last_4?' (‚Ä¢‚Ä¢'+a.last_4+')':''}`).join('\n');
            const pick=prompt(`Multiple accounts match this format.\nWhich account is "${file.name}" for?\n\n${names}\n\nType the account name:`);
            if(!pick){statusEl.innerHTML='‚è≠ Skipped';statusEl.style.color='var(--sage-400)';return;}
            match=formatMatches.find(a=>a.name.toLowerCase().includes(pick.toLowerCase()));
            if(!match){statusEl.innerHTML='‚ùå No matching account found';statusEl.style.color='#c44';return;}
        }
    }
    
    statusEl.innerHTML=`Matched ‚Üí <strong>${match.name}</strong>${match.last_4?' (‚Ä¢‚Ä¢'+match.last_4+')':''} ¬∑ Importing...`;
    statusEl.style.color='var(--sage-600)';
    
    // Run the import
    await importCSVForAccountSingle(file,match.id,entryId,statusEl);
}

async function importCSVForAccountSingle(file,accountId,entryId,statusEl){
    if(!categoryRules.length){
        try{categoryRules=await supaFetch('finance_category_rules','GET',null,'?order=pattern');}catch(e){categoryRules=[];}
    }
    
    const text=await file.text();
    const lines=text.split('\n').filter(l=>l.trim());
    
    let headerIdx=0;
    for(let i=0;i<Math.min(lines.length,15);i++){
        const test=parseCSVLine(lines[i]).map(c=>c.trim().toLowerCase());
        if(test[0]==='date'&&test[1]==='description'&&test[2]==='amount'&&test[3]&&test[3].includes('running')){
            headerIdx=i;break;
        }
    }
    const headers=parseCSVLine(lines[headerIdx]);
    const format=detectCSVFormat(headers);
    
    const txns=[];
    for(let i=headerIdx+1;i<lines.length;i++){
        const cols=parseCSVLine(lines[i]);
        if(cols.length<3)continue;
        let txn={account_id:accountId};
        
        if(format==='chase'){
            txn.transaction_date=parseDate(cols[0]);
            txn.post_date=parseDate(cols[1]);
            txn.description=cols[2]||'';
            txn.category=cols[3]||'Uncategorized';
            txn.amount=parseFloat(cols[5])||0;
            txn.memo=cols[6]||null;
            txn.dedup_hash=hashTxn(txn.transaction_date,txn.description,txn.amount);
        } else if(format==='boa'){
            txn.transaction_date=parseDate(cols[0]);
            txn.post_date=parseDate(cols[0]);
            txn.description=(cols[2]||'').trim();
            txn.address=(cols[3]||'').trim();
            txn.amount=parseFloat(cols[4])||0;
            txn.reference_number=cols[1]||'';
            txn.category='Girls';
            txn.dedup_hash=hashTxn(null,null,null,txn.reference_number);
        } else if(format==='pnc'){
            txn.transaction_date=parseDate(cols[0]);
            if(!txn.transaction_date)continue;
            txn.description=(cols[1]||'').trim();
            txn.amount=parsePNCAmount(cols[2]);
            txn.raw_balance=cols[3]||'';
            txn.category=guessCategory(txn.description);
            txn.dedup_hash=hashTxn(txn.transaction_date,txn.description,txn.amount);
        } else if(format==='boa_checking'){
            txn.transaction_date=parseDate(cols[0]);
            if(!txn.transaction_date)continue;
            txn.description=(cols[1]||'').trim();
            if(txn.description.toLowerCase().includes('beginning balance'))continue;
            txn.amount=parsePNCAmount(cols[2]);
            txn.raw_balance=cols[3]||'';
            txn.category=guessCategory(txn.description);
            txn.dedup_hash=hashTxn(txn.transaction_date,txn.description,txn.amount);
        } else if(format==='chase_checking'){
            txn.transaction_date=parseDate(cols[1]);
            if(!txn.transaction_date)continue;
            txn.description=(cols[2]||'').trim();
            txn.amount=parsePNCAmount(cols[3]);
            txn.raw_balance=cols[5]||'';
            txn.category=guessCategory(txn.description);
            txn.dedup_hash=hashTxn(txn.transaction_date,txn.description,txn.amount);
        }
        
        if(!txn.transaction_date)continue;
        if(!txn.category) txn.category=guessCategory(txn.description);
        txns.push(txn);
    }
    
    // Check for duplicates
    let existingHashes=new Set();
    try{
        const hashData=await supaFetch('finance_transactions','GET',null,`?account_id=eq.${accountId}&select=dedup_hash`);
        if(Array.isArray(hashData)) hashData.forEach(r=>existingHashes.add(r.dedup_hash));
    }catch(e){console.error('Hash fetch error:',e);}
    
    const newTxns=txns.filter(t=>!existingHashes.has(t.dedup_hash));
    // Also deduplicate within the CSV itself
    const seenHashes=new Set();
    const dedupedTxns=newTxns.filter(t=>{
        if(seenHashes.has(t.dedup_hash))return false;
        seenHashes.add(t.dedup_hash);
        return true;
    });
    const skipped=txns.length-dedupedTxns.length;
    let imported=0;
    const importedIds=[];
    
    if(dedupedTxns.length===0){
        statusEl.innerHTML=`‚úÖ <strong>0</strong> new ¬∑ <strong>${skipped}</strong> skipped`;
        statusEl.style.color='#2e7d32';
        return;
    }
    
    const batchSize=50;
    for(let i=0;i<dedupedTxns.length;i+=batchSize){
        const batch=dedupedTxns.slice(i,i+batchSize);
        try{
            const clean=batch.map(t=>{
                const c={...t};
                Object.keys(c).forEach(k=>{if(c[k]===null||c[k]===undefined||c[k]==='')delete c[k];});
                if(!c.category)c.category='Uncategorized';
                return c;
            });
            // Ensure all objects have the same keys (Supabase requirement)
            const allKeys=new Set();
            clean.forEach(c=>Object.keys(c).forEach(k=>allKeys.add(k)));
            clean.forEach(c=>allKeys.forEach(k=>{if(!(k in c))c[k]=null;}));
            const data=await fetch(`${SUPABASE_URL}/rest/v1/finance_transactions?on_conflict=account_id,dedup_hash`,{
                method:'POST',
                headers:{
                    'apikey':SUPABASE_KEY,
                    'Authorization':`Bearer ${SUPABASE_KEY}`,
                    'Content-Type':'application/json',
                    'Prefer':'return=representation,resolution=ignore-duplicates'
                },
                body:JSON.stringify(clean)
            }).then(r=>{if(!r.ok)throw new Error(r.statusText);return r.json();});
            if(Array.isArray(data)){imported+=data.length;importedIds.push(...data.map(d=>d.id));}
        }catch(e){console.error('Batch error:',e);statusEl.innerHTML=`‚ùå Error: ${e.message}`;statusEl.style.color='#c44';return;}
    }
    
    lastImport={ids:importedIds,accountId,count:imported,entryId};
    
    const allAcc=[...accounts,...closedAccounts];
    const acc=allAcc.find(a=>a.id===accountId);
    statusEl.innerHTML=`‚úÖ ‚Üí <strong>${acc?.name||'Account'}</strong> ¬∑ <strong>${imported}</strong> new ¬∑ <strong>${skipped}</strong> skipped <button onclick="undoImport('${entryId}')" style="margin-left:8px;padding:4px 10px;border-radius:6px;border:1px solid #c44;background:white;color:#c44;cursor:pointer;font-size:0.8rem;">‚Ü© Undo</button>`;
    statusEl.style.color='#2e7d32';
}

function dzOver(e){e.preventDefault();e.currentTarget.classList.add('drag-over');}
function dzLeave(e){e.currentTarget.classList.remove('drag-over');}

// ==================== TRANSACTIONS TAB ====================

async function undoImport(entryId){
    if(!lastImport||!lastImport.ids.length)return;
    if(!confirm(`Undo import of ${lastImport.count} transactions?`))return;
    try{
        for(let i=0;i<lastImport.ids.length;i+=50){
            const batch=lastImport.ids.slice(i,i+50);
            const idList=batch.map(id=>`"${id}"`).join(',');
            await supaFetch('finance_transactions','DELETE',null,`?id=in.(${idList})`);
        }
        const entry=document.getElementById(entryId||lastImport.entryId);
        if(entry){
            const st=entry.querySelector('.imp-status');
            if(st){st.style.color='#c44';st.innerHTML=`‚Ü© <strong>${lastImport.count}</strong> transactions removed`;}
        }
        lastImport=null;
    }catch(e){alert('Undo failed: '+e.message);}
}

async function initTransactions(){
    const allAcc=[...accounts,...closedAccounts];
    const filterSel=document.getElementById('txn-filter-account');
    filterSel.innerHTML='<option value="">All Accounts</option>'+allAcc.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
    
    if(!categoryRules.length){
        try{categoryRules=await supaFetch('finance_category_rules','GET',null,'?order=pattern');}catch(e){categoryRules=[];}
    }
    
    populateBulkCatDropdown();
    await loadTransactions();
    await loadCategoryFilter();
    await loadVendorFilter();
}

async function loadCategoryFilter(){
    try{
        const sel=document.getElementById('txn-filter-category');
        sel.innerHTML='<option value="">All Categories</option>'+getCatOptions().map(c=>`<option value="${c}">${c}</option>`).join('');
    }catch(e){}
}

async function loadVendorFilter(){
    try{
        const txns=await supaFetch('finance_transactions','GET',null,'?select=description&order=description');
        const vendors={};
        txns.forEach(t=>{
            if(!t.description)return;
            let v=t.description.split(/\s{2,}|\d{4,}/)[0].trim();
            v=v.replace(/[#*]+.*$/,'').trim();
            if(v.length>=3) vendors[v]=(vendors[v]||0)+1;
        });
        const sorted=Object.entries(vendors).sort((a,b)=>b[1]-a[1]).slice(0,50);
        const sel=document.getElementById('txn-filter-vendor');
        sel.innerHTML='<option value="">All Vendors</option>'+sorted.map(([v,c])=>`<option value="${v}">${v} (${c})</option>`).join('');
    }catch(e){}
}

async function loadTransactions(){
    const acct=document.getElementById('txn-filter-account')?.value||'';
    const cat=document.getElementById('txn-filter-category')?.value||'';
    const vendor=document.getElementById('txn-filter-vendor')?.value||'';
    const search=document.getElementById('txn-search')?.value?.trim()||'';
    const fromDate=document.getElementById('txn-filter-from')?.value||'';
    const toDate=document.getElementById('txn-filter-to')?.value||'';
    
    let query='?order=transaction_date.desc,id.desc&limit=300';
    if(acct) query+=`&account_id=eq.${acct}`;
    if(cat) query+=`&category=eq.${encodeURIComponent(cat)}`;
    if(fromDate) query+=`&transaction_date=gte.${fromDate}`;
    if(toDate) query+=`&transaction_date=lte.${toDate}`;
    if(search) query+=`&description=ilike.*${encodeURIComponent(search)}*`;
    if(vendor) query+=`&description=ilike.*${encodeURIComponent(vendor)}*`;
    
    try{
        txnData=await supaFetch('finance_transactions','GET',null,query);
    }catch(e){txnData=[];console.error('Load txns:',e);}
    
    txnSelected.clear();
    renderTransactions();
}

function renderTransactions(){
    const wrap=document.getElementById('txn-table-wrap');
    const allAcc=[...accounts,...closedAccounts];
    const accMap={};allAcc.forEach(a=>accMap[a.id]=a);
    
    if(!txnData.length){
        wrap.innerHTML='<p style="color:var(--sage-400);padding:16px;">No transactions found. Go to the Import tab to upload CSVs!</p>';
        document.getElementById('txn-summary').textContent='';
        document.getElementById('txn-bulk-bar').style.display='none';
        return;
    }
    
    // Sort data
    const sorted=[...txnData].sort((a,b)=>{
        let va,vb;
        if(txnSort.col==='transaction_date'){va=a.transaction_date||'';vb=b.transaction_date||'';}
        else if(txnSort.col==='account'){va=accMap[a.account_id]?.name||'';vb=accMap[b.account_id]?.name||'';}
        else if(txnSort.col==='description'){va=(a.description||'').toLowerCase();vb=(b.description||'').toLowerCase();}
        else if(txnSort.col==='category'){va=(a.category||'').toLowerCase();vb=(b.category||'').toLowerCase();}
        else if(txnSort.col==='amount'){va=a.amount||0;vb=b.amount||0;return txnSort.dir==='asc'?va-vb:vb-va;}
        if(va<vb)return txnSort.dir==='asc'?-1:1;
        if(va>vb)return txnSort.dir==='asc'?1:-1;
        return 0;
    });
    
    let totalSpend=0,totalIncome=0;
    txnData.forEach(t=>{
        if(t.amount<0)totalSpend+=t.amount;
        else totalIncome+=t.amount;
    });
    document.getElementById('txn-summary').innerHTML=
        `${txnData.length} txns &nbsp;|&nbsp; <span style="color:#c44">${fmt(Math.abs(totalSpend))} out</span> &nbsp;|&nbsp; <span style="color:#4a7c3f">${fmt(totalIncome)} in</span>`;
    
    // Bulk bar
    const bulkBar=document.getElementById('txn-bulk-bar');
    if(txnSelected.size>0){
        bulkBar.style.display='flex';
        document.getElementById('txn-bulk-count').textContent=`${txnSelected.size} selected`;
    } else {
        bulkBar.style.display='none';
    }
    
    const arrow=col=>{
        if(txnSort.col!==col)return' <span style="opacity:0.3;font-size:0.7rem;">‚áÖ</span>';
        return txnSort.dir==='asc'?' ‚Üë':' ‚Üì';
    };
    const thStyle='cursor:pointer;user-select:none;';
    
    const allChecked=sorted.length>0&&sorted.every(t=>txnSelected.has(t.id));
    let html=`<table class="data-table" style="width:100%;">
        <thead><tr>
            <th style="width:30px;"><input type="checkbox" ${allChecked?'checked':''} onchange="toggleAllTxn(this.checked)" style="accent-color:var(--sage-500);width:16px;height:16px;cursor:pointer;"></th>
            <th style="${thStyle}" onclick="sortTxn('transaction_date')">Date${arrow('transaction_date')}</th>
            <th style="${thStyle}" onclick="sortTxn('account')">Account${arrow('account')}</th>
            <th style="${thStyle}" onclick="sortTxn('description')">Description${arrow('description')}</th>
            <th style="${thStyle}" onclick="sortTxn('category')">Category${arrow('category')}</th>
            <th style="${thStyle}text-align:right;" onclick="sortTxn('amount')">Amount${arrow('amount')}</th>
        </tr></thead><tbody>`;
    
    sorted.forEach(t=>{
        const acctName=accMap[t.account_id]?.name||'?';
        const shortAcct=acctName.length>12?acctName.substring(0,12)+'‚Ä¶':acctName;
        const isNeg=t.amount<0;
        const catStyle=t.category==='Uncategorized'?'background:#ffeeba;color:#856404;':'';
        const checked=txnSelected.has(t.id)?'checked':'';
        html+=`<tr style="${checked?'background:rgba(122,144,97,0.12);':''}">
            <td><input type="checkbox" ${checked} onchange="toggleTxnSelect(${t.id},this.checked)" style="accent-color:var(--sage-500);width:16px;height:16px;cursor:pointer;"></td>
            <td style="white-space:nowrap;font-size:0.8rem;">${t.transaction_date}</td>
            <td style="font-size:0.75rem;color:var(--sage-500);" title="${acctName}">${shortAcct}</td>
            <td style="font-size:0.8rem;max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${(t.description||'').replace(/"/g,'&quot;')}">${t.description||''}</td>
            <td><span class="badge" style="cursor:pointer;${catStyle}" onclick="editCategory(${t.id},'${(t.description||'').replace(/'/g,"\\'")}','${t.category}')" title="Click to change">${t.category||'‚Äî'}</span></td>
            <td style="text-align:right;font-weight:600;color:${isNeg?'var(--sage-700)':'#4a7c3f'};white-space:nowrap;">${isNeg?'-':''}${fmt(Math.abs(t.amount))}</td>
        </tr>`;
    });
    
    html+=`</tbody></table>`;
    wrap.innerHTML=html;
}

function sortTxn(col){
    if(txnSort.col===col){txnSort.dir=txnSort.dir==='asc'?'desc':'asc';}
    else{txnSort.col=col;txnSort.dir=col==='amount'?'desc':'asc';}
    renderTransactions();
}

function toggleTxnSelect(id,checked){
    if(checked)txnSelected.add(id);else txnSelected.delete(id);
    renderTransactions();
}

function toggleAllTxn(checked){
    if(checked){txnData.forEach(t=>txnSelected.add(t.id));}
    else{txnSelected.clear();}
    renderTransactions();
}

async function bulkApplyCategory(){
    const cat=document.getElementById('txn-bulk-category').value;
    if(!cat)return alert('Pick a category first.');
    if(!txnSelected.size)return;
    
    const count=txnSelected.size;
    if(!confirm(`Set ${count} transaction${count>1?'s':''} to "${cat}"?`))return;
    
    try{
        const ids=[...txnSelected];
        // Batch in groups of 20
        for(let i=0;i<ids.length;i+=20){
            const batch=ids.slice(i,i+20);
            const idList=batch.join(',');
            await supaFetch('finance_transactions','PATCH',{category:cat},`?id=in.(${idList})`);
        }
        
        txnSelected.clear();
        document.getElementById('txn-bulk-category').value='';
        await loadTransactions();
        await loadCategoryFilter();
    }catch(e){alert('Error: '+e.message);}
}

let editingCatTxnId=null;
let editingCatDesc='';

function getCatOptions(){
    return financeCategories.map(c=>c.name);
}

function populateBulkCatDropdown(){
    const sel=document.getElementById('txn-bulk-category');
    sel.innerHTML='<option value="">Pick category...</option>'+getCatOptions().map(c=>`<option value="${c}">${c}</option>`).join('');
}

function editCategory(txnId,description,currentCat){
    editingCatTxnId=txnId;
    editingCatDesc=description;
    document.getElementById('modal-cat-desc').textContent=description;
    document.getElementById('modal-cat-new').value='';
    
    const list=document.getElementById('modal-cat-list');
    list.innerHTML=getCatOptions().map(c=>{
        const isActive=c===currentCat;
        return `<div onclick="applyCategory('${c.replace(/'/g,"\\'")}')" style="padding:10px 14px;cursor:pointer;border-radius:8px;margin-bottom:4px;font-size:0.9rem;transition:all 0.15s;
            ${isActive?'background:var(--sage-500);color:white;font-weight:600;':'background:var(--sage-50);color:var(--charcoal);'}
            " onmouseover="this.style.background='${isActive?'var(--sage-600)':'var(--sage-100)'}'" 
            onmouseout="this.style.background='${isActive?'var(--sage-500)':'var(--sage-50)'}'">
            ${c}${isActive?' ‚úì':''}
        </div>`;
    }).join('');
    
    document.getElementById('modal-category').classList.add('active');
}

async function applyCategory(newCat){
    if(!editingCatTxnId)return;
    try{
        await supaFetch('finance_transactions','PATCH',{category:newCat},`?id=eq.${editingCatTxnId}`);
        
        const vendor=editingCatDesc.split(/\s{2,}|\d/)[0].trim().toUpperCase();
        if(vendor.length>=3){
            try{
                await supaFetch('finance_category_rules','POST',{pattern:vendor,category:newCat});
                categoryRules=await supaFetch('finance_category_rules','GET',null,'?order=pattern');
            }catch(e){}
        }
        
        closeModal('modal-category');
        await loadTransactions();
        await loadCategoryFilter();
    }catch(e){alert('Error: '+e.message);}
}

async function addNewCategory(){
    const name=document.getElementById('modal-cat-new').value.trim();
    if(!name)return;
    
    // Check if it already exists
    if(financeCategories.some(c=>c.name.toLowerCase()===name.toLowerCase())){
        alert('That category already exists!');
        return;
    }
    
    try{
        const maxOrder=financeCategories.length?Math.max(...financeCategories.map(c=>c.sort_order)):0;
        await supaFetch('finance_categories','POST',{name:name,sort_order:maxOrder+1});
        await loadFinanceCategories();
        
        // If we're in the single-edit modal, refresh it and auto-apply
        if(editingCatTxnId){
            applyCategory(name);
        } else {
            // Refresh the bulk dropdown
            populateBulkCatDropdown();
        }
    }catch(e){alert('Error adding category: '+e.message);}
}

async function init(){
    await loadFinanceCategories();
    await loadAccounts(); await loadBills(); await loadBillPayments();
    loadDashboard();
}
init();
</script>
</body>
</html>
