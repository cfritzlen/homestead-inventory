<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finances - Homestead Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@300;400;600&family=Karla:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --sage-50: #f6f7f3;
            --sage-100: #e8ebe0;
            --sage-200: #d4dac5;
            --sage-300: #b8c5a3;
            --sage-400: #98ab7e;
            --sage-500: #7a9061;
            --sage-600: #5f734c;
            --sage-700: #4a5a3b;
            --sage-800: #3d4a32;
            --cream: #ece8dd;
            --taupe: #c4b5a4;
            --dusty-sage: #a4ac95;
            --mauve: #a88479;
            --charcoal: #4a4d47;
            --dusty-rose: #9b7269;
            --red-soft: #c0392b;
            --green-soft: #27ae60;
        }

        body {
            font-family: 'Karla', sans-serif;
            background: var(--charcoal);
            min-height: 100vh;
            color: var(--cream);
        }

        .top-bar {
            background: rgba(61, 74, 50, 0.9);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--sage-700);
        }
        .top-bar a { color: var(--sage-200); text-decoration: none; font-size: 0.9rem; }
        .top-bar a:hover { color: var(--cream); }
        .top-bar h1 { font-family: 'Crimson Pro', serif; font-size: 1.4rem; font-weight: 400; color: var(--cream); }

        .tab-bar { display: flex; gap: 0; background: rgba(74, 90, 59, 0.5); overflow-x: auto; }
        .tab-btn {
            padding: 14px 24px; background: none; border: none; color: var(--sage-200);
            font-family: 'Karla', sans-serif; font-size: 0.95rem; font-weight: 500;
            cursor: pointer; border-bottom: 3px solid transparent; white-space: nowrap; transition: all 0.2s;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.05); color: var(--cream); }
        .dash-card { transition: all 0.15s; -webkit-tap-highlight-color: transparent; }
        .dash-card:hover, .dash-card:active { border-color: var(--sage-400) !important; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08) !important; }
        @media (hover: none) { .dash-card:active { transform: scale(0.97); } .dash-card:hover { transform: none; } }
        .tab-btn.active { color: var(--cream); border-bottom-color: var(--sage-400); background: rgba(255,255,255,0.08); }

        .main-content { max-width: 1200px; margin: 0 auto; padding: 24px 20px; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        .card {
            background: rgba(236, 232, 221, 0.95); border-radius: 12px; padding: 24px;
            margin-bottom: 20px; color: var(--charcoal); box-shadow: 0 4px 16px rgba(0,0,0,0.25);
        }
        .card h2 { font-family: 'Crimson Pro', serif; font-size: 1.5rem; font-weight: 600; color: var(--sage-700); margin-bottom: 16px; }

        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 12px; }
        .form-group { display: flex; flex-direction: column; gap: 4px; }
        .form-group label { font-size: 0.8rem; font-weight: 600; color: var(--sage-600); text-transform: uppercase; letter-spacing: 0.5px; }
        .form-group input, .form-group select {
            padding: 10px 12px; border: 1px solid var(--sage-200); border-radius: 8px;
            font-family: 'Karla', sans-serif; font-size: 0.95rem; background: white; color: var(--charcoal);
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--sage-500); box-shadow: 0 0 0 3px rgba(122, 144, 97, 0.15); }

        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-family: 'Karla', sans-serif; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--sage-500); color: white; }
        .btn-primary:hover { background: var(--sage-600); }
        .btn-secondary { background: var(--taupe); color: white; }
        .btn-secondary:hover { background: var(--mauve); }
        .btn-danger { background: var(--dusty-rose); color: white; }
        .btn-danger:hover { background: var(--red-soft); }
        .btn-small { padding: 6px 12px; font-size: 0.8rem; }
        .btn-row { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }

        .data-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .data-table th { background: var(--sage-600); color: white; padding: 10px 12px; text-align: left; font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; }
        .data-table td { padding: 10px 12px; border-bottom: 1px solid var(--sage-100); }
        .data-table tr:hover { background: rgba(122, 144, 97, 0.08); }
        .data-table .amount { text-align: right; font-variant-numeric: tabular-nums; }
        .data-table .negative { color: var(--red-soft); }
        .data-table .positive { color: var(--green-soft); }

        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .summary-box { background: var(--sage-700); border-radius: 10px; padding: 16px; text-align: center; color: var(--cream); }
        .summary-box .label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--sage-200); margin-bottom: 6px; }
        .summary-box .value { font-family: 'Crimson Pro', serif; font-size: 1.6rem; font-weight: 600; }
        .summary-box .value.positive { color: #6dd59a; }
        .summary-box .value.negative { color: #e88; }
        .summary-box.highlight { background: var(--sage-500); border: 2px solid var(--sage-300); }

        .check-paid { width: 20px; height: 20px; cursor: pointer; accent-color: var(--sage-500); }
        .badge { display: inline-block; padding: 3px 10px; border-radius: 10px; font-size: 0.75rem; font-weight: 600; }
        .drop-zone {
            border: 2px dashed var(--sage-300); border-radius: 12px; padding: 24px 16px;
            text-align: center; cursor: pointer; transition: all 0.2s;
            background: white; position: relative; min-height: 120px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .drop-zone:hover { border-color: var(--sage-400); background: var(--sage-50); }
        .drop-zone.drag-over { border-color: var(--sage-600); background: var(--sage-100); border-style: solid; transform: scale(1.02); }
        .drop-zone.success { border-color: #4a7c3f; background: #e8f5e9; }
        .drop-zone.error { border-color: #c44; background: #fee; }
        .drop-zone-name { font-weight: 700; color: var(--sage-700); font-size: 1rem; margin-bottom: 4px; }
        .drop-zone-type { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: var(--sage-400); margin-bottom: 8px; }
        .drop-zone-icon { font-size: 1.8rem; margin-bottom: 6px; opacity: 0.5; }
        .drop-zone-hint { font-size: 0.75rem; color: var(--sage-400); }
        .drop-zone-status { font-size: 0.8rem; margin-top: 8px; font-weight: 600; }
        .drop-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .badge-paid { background: rgba(39, 174, 96, 0.15); color: var(--green-soft); }
        .badge-auto { background: rgba(122, 144, 97, 0.15); color: var(--sage-600); }
        .badge-variable { background: rgba(168, 132, 121, 0.15); color: var(--mauve); }

        .entry-row { display: grid; grid-template-columns: 1.5fr 120px 120px 120px; gap: 8px; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--sage-100); }
        .entry-row.header { font-size: 0.8rem; font-weight: 600; color: var(--sage-600); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid var(--sage-300); padding-bottom: 10px; }
        .entry-row label { font-weight: 500; color: var(--charcoal); }
        .entry-row .rate { font-size: 0.8rem; color: var(--sage-400); }
        .entry-row input {
            padding: 8px 10px; border: 1px solid var(--sage-200); border-radius: 8px;
            font-family: 'Karla', sans-serif; font-size: 0.95rem; text-align: right; background: white; color: var(--charcoal); width: 100%;
        }
        .entry-row input:focus { outline: none; border-color: var(--sage-500); box-shadow: 0 0 0 3px rgba(122, 144, 97, 0.15); }
        .entry-row .calc { text-align: right; font-variant-numeric: tabular-nums; font-weight: 500; padding-right: 12px; }
        .section-divider { font-family: 'Crimson Pro', serif; font-size: 1.1rem; color: var(--sage-600); padding: 16px 0 6px; border-bottom: 2px solid var(--sage-300); margin-top: 8px; }

        .month-selector { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
        .month-selector button { background: var(--sage-600); color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 1.1rem; }
        .month-selector button:hover { background: var(--sage-700); }
        .month-selector .current-month { font-family: 'Crimson Pro', serif; font-size: 1.3rem; color: var(--charcoal); min-width: 160px; text-align: center; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--cream); border-radius: 12px; padding: 28px; max-width: 500px; width: 90%; color: var(--charcoal); box-shadow: 0 8px 40px rgba(0,0,0,0.4); }
        .modal h2 { font-family: 'Crimson Pro', serif; color: var(--sage-700); margin-bottom: 16px; }

        .table-scroll { overflow-x: auto; }
        .empty-state { text-align: center; padding: 40px; color: var(--sage-600); }
        .empty-state .icon { font-size: 3rem; margin-bottom: 12px; }

        #column-picker label:hover { background: var(--sage-100); border-radius: 4px; padding: 2px 4px; margin: -2px -4px; }

        @media (max-width: 768px) {
            /* Tabs - scrollable, dashboard first */
            .tab-bar { overflow-x: auto; -webkit-overflow-scrolling: touch; flex-wrap: nowrap; }
            .tab-btn { padding: 10px 12px; font-size: 0.78rem; white-space: nowrap; flex-shrink: 0; }

            .form-row { grid-template-columns: 1fr; }
            .summary-grid { grid-template-columns: 1fr 1fr; }
            .card { padding: 12px; margin: 8px; }
            .entry-row { grid-template-columns: 1fr 90px 90px 90px; gap: 4px; }
            .entry-row input { padding: 6px 8px; font-size: 0.85rem; }
            .data-table { font-size: 0.8rem; }
            .data-table th, .data-table td { padding: 8px 6px; }

            /* Dashboard cards - 2 column on phone */
            #dash-cards { grid-template-columns: 1fr 1fr !important; gap: 10px !important; }
            .dash-card { padding: 14px 10px !important; }
            .dash-card div:first-child { font-size: 0.6rem !important; }
            .dash-card div:last-child { font-size: 1.3rem !important; }

            /* Chart taller on mobile */
            #dash-debt-chart { height: 260px !important; }
            #dash-chart-title { font-size: 1rem !important; }

            /* Transactions & Import mobile */
            #tab-transactions .card > div[style*="grid-template-columns"] { grid-template-columns: 1fr 1fr !important; }
            #txn-table-wrap { font-size: 0.75rem; }
            #import-zones { grid-template-columns: 1fr !important; }
            .drop-zone { min-height: 90px !important; padding: 16px 12px !important; }
        }

        @media (max-width: 420px) {
            /* Small phones - stack cards */
            #dash-cards { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
            .dash-card div:last-child { font-size: 1.15rem !important; }

            /* Top bar compact */
            .top-bar h1 { font-size: 1.2rem; }
            .top-bar a { font-size: 0.75rem; }
        }
    </style>
</head>
<body>

<div class="top-bar">
    <a href="index.html">‚Üê Back to Hub</a>
    <h1>üìä Finances</h1>
    <div></div>
</div>

<div class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</button>
    <button class="tab-btn" onclick="switchTab('weekly')">Weekly Entry</button>
    <button class="tab-btn" onclick="switchTab('import')">Import</button>
    <button class="tab-btn" onclick="switchTab('transactions')">Transactions</button>
    <button class="tab-btn" onclick="switchTab('accounts')">Accounts</button>
    <button class="tab-btn" onclick="switchTab('bills')">Bills</button>
    <button class="tab-btn" onclick="switchTab('history')">History</button>
</div>

<div class="main-content">

    <!-- ==================== DASHBOARD ==================== -->
    <div id="tab-dashboard" class="tab-panel active">
        <div class="card">
            <h2>üìä Dashboard</h2>
            <div id="dash-cards" style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin:16px 0 28px;"></div>
            <div class="card" style="padding:16px;margin:0;background:white;border:1px solid var(--sage-200);">
                <h3 id="dash-chart-title" onclick="switchChart('debt')" style="font-family:'Crimson Pro',serif;font-size:1.1rem;color:var(--sage-700);margin-bottom:12px;cursor:pointer;" title="Click to show total debt">üìâ Total Debt (Last Year)</h3>
                <div id="dash-debt-chart" style="height:220px;position:relative;"></div>
            </div>
        </div>
    </div>

    <!-- ==================== IMPORT ==================== -->
    <div id="tab-import" class="tab-panel">
        <div class="card">
            <h2>üì• Import Transactions</h2>
            <p style="color:var(--sage-500);font-size:0.85rem;margin-bottom:16px;">Drag & drop a CSV export onto the matching account. Duplicates are automatically skipped.</p>
            <div id="import-zones" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;"></div>
        </div>
    </div>

    <!-- ==================== TRANSACTIONS ==================== -->
    <div id="tab-transactions" class="tab-panel">
        <div class="card">
            <h2>üîç Transactions</h2>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;align-items:end;margin-bottom:12px;">
                <div class="form-group">
                    <label>Account</label>
                    <select id="txn-filter-account" onchange="loadTransactions()" style="padding:8px;border:1px solid var(--sage-200);border-radius:8px;font-family:'Karla',sans-serif;">
                        <option value="">All Accounts</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="txn-filter-category" onchange="loadTransactions()" style="padding:8px;border:1px solid var(--sage-200);border-radius:8px;font-family:'Karla',sans-serif;">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Vendor</label>
                    <select id="txn-filter-vendor" onchange="loadTransactions()" style="padding:8px;border:1px solid var(--sage-200);border-radius:8px;font-family:'Karla',sans-serif;">
                        <option value="">All Vendors</option>
                    </select>
                </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;align-items:end;margin-bottom:16px;">
                <div class="form-group">
                    <label>From</label>
                    <input type="date" id="txn-filter-from" onchange="loadTransactions()" style="padding:8px;border:1px solid var(--sage-200);border-radius:8px;font-family:'Karla',sans-serif;">
                </div>
                <div class="form-group">
                    <label>To</label>
                    <input type="date" id="txn-filter-to" onchange="loadTransactions()" style="padding:8px;border:1px solid var(--sage-200);border-radius:8px;font-family:'Karla',sans-serif;">
                </div>
                <div class="form-group">
                    <label>Search</label>
                    <input type="text" id="txn-search" placeholder="Search description..." oninput="loadTransactions()" style="padding:8px;border:1px solid var(--sage-200);border-radius:8px;font-family:'Karla',sans-serif;">
                </div>
            </div>
            <div id="txn-summary" style="font-weight:700;color:var(--sage-700);font-size:0.9rem;margin-bottom:12px;"></div>
            <div id="txn-table-wrap" style="max-height:500px;overflow-y:auto;"></div>
        </div>
    </div>

    <!-- ==================== ACCOUNTS ==================== -->
    <div id="tab-accounts" class="tab-panel">
        <div class="card">
            <h2>‚ûï Add Account</h2>
            <div class="form-row">
                <div class="form-group"><label>Account Name</label><input type="text" id="acc-name" placeholder="e.g. Family CC"></div>
                <div class="form-group"><label>Type</label>
                    <select id="acc-type">
                        <option value="credit_card">Credit Card</option>
                        <option value="loan">Loan</option>
                        <option value="bank">Bank Account</option>
                        <option value="tax_debt">Tax Debt</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group"><label>Interest Rate %</label><input type="number" id="acc-rate" step="0.01" placeholder="24.24"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Starting Balance</label><input type="number" id="acc-starting" step="0.01" placeholder="5000.00"></div>
                <div class="form-group"><label>Min Payment</label><input type="number" id="acc-minpay" step="0.01" placeholder="150.00"></div>
                <div class="form-group"><label>Is Debt?</label>
                    <select id="acc-isdebt"><option value="true">Yes (CC, Loan)</option><option value="false">No (Bank account)</option></select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Pays From</label><input type="text" id="acc-paysfrom" placeholder="e.g. PNC Checking"></div>
                <div class="form-group"><label>Notes</label><input type="text" id="acc-notes" placeholder="Optional"></div>
            </div>
            <div class="btn-row">
                <button class="btn btn-primary" onclick="saveAccount()">Save Account</button>
                <button class="btn btn-secondary" id="btn-cancel-edit" style="display:none" onclick="cancelEditAccount()">Cancel</button>
            </div>
        </div>

        <div class="card">
            <h2>Active Accounts</h2>
            <div class="table-scroll">
                <table class="data-table"><thead><tr>
                    <th>Name</th><th>Type</th><th>Rate</th><th>Starting Bal</th><th>Min Pay</th><th>Pays From</th><th>Actions</th>
                </tr></thead><tbody id="accounts-body"></tbody></table>
            </div>
            <div id="accounts-empty" class="empty-state" style="display:none;"><div class="icon">üè¶</div><p>No accounts yet.</p></div>
        </div>

        <div class="card" id="closed-card" style="display:none;">
            <h2>Closed / Paid Off</h2>
            <div class="table-scroll">
                <table class="data-table"><thead><tr>
                    <th>Name</th><th>Type</th><th>Rate</th><th>Closed</th><th>Reason</th><th>Actions</th>
                </tr></thead><tbody id="closed-body"></tbody></table>
            </div>
        </div>
    </div>

    <!-- ==================== BILLS ==================== -->
    <div id="tab-bills" class="tab-panel">
        <div class="card">
            <h2>‚ûï Add Recurring Bill</h2>
            <div class="form-row">
                <div class="form-group"><label>Bill Name</label><input type="text" id="bill-name" placeholder="e.g. Electric - House 1"></div>
                <div class="form-group"><label>Expected Amount</label><input type="number" id="bill-amount" step="0.01" placeholder="150.00"></div>
                <div class="form-group"><label>Amount Varies?</label>
                    <select id="bill-variable-amt"><option value="false">No - Fixed</option><option value="true">Yes - Enter each month</option></select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Due Day</label><input type="number" id="bill-due-day" min="1" max="31" placeholder="15"></div>
                <div class="form-group"><label>Date Varies?</label>
                    <select id="bill-variable-date"><option value="false">No</option><option value="true">Yes</option></select>
                </div>
                <div class="form-group"><label>Auto-Pay?</label>
                    <select id="bill-autopay"><option value="false">No</option><option value="true">Yes</option></select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Pays From</label><input type="text" id="bill-pays-from" placeholder="PNC Checking"></div>
                <div class="form-group"><label>Category</label>
                    <select id="bill-category"><option value="electric">Electric</option><option value="mortgage">Mortgage</option><option value="insurance">Insurance</option><option value="phone">Phone</option><option value="internet">Internet</option><option value="subscription">Subscription</option><option value="vehicle">Vehicle</option><option value="other">Other</option></select>
                </div>
                <div class="form-group"><label>Notes</label><input type="text" id="bill-notes" placeholder="Optional"></div>
            </div>
            <div class="btn-row">
                <button class="btn btn-primary" onclick="saveBill()">Save Bill</button>
                <button class="btn btn-secondary" id="btn-cancel-bill" style="display:none" onclick="cancelEditBill()">Cancel</button>
            </div>
        </div>

        <div class="card">
            <h2>Monthly Bill Tracker</h2>
            <div class="month-selector">
                <button onclick="changeMonth(-1)">‚óÄ</button>
                <span class="current-month" id="bill-month-display"></span>
                <button onclick="changeMonth(1)">‚ñ∂</button>
            </div>
            <div class="table-scroll">
                <table class="data-table"><thead><tr>
                    <th>Paid</th><th>Bill</th><th>Due</th><th>Expected</th><th>Actual</th><th>Auto</th><th>Actions</th>
                </tr></thead><tbody id="bills-body"></tbody></table>
            </div>
            <div id="bills-empty" class="empty-state" style="display:none;"><div class="icon">üìã</div><p>No bills yet.</p></div>
        </div>
    </div>

    <!-- ==================== WEEKLY ENTRY ==================== -->
    <div id="tab-weekly" class="tab-panel">
        <div class="card">
            <h2>üì∏ Weekly Entry</h2>
            <div class="form-row" style="margin-bottom:12px;">
                <div class="form-group">
                    <label>Week Of (Wednesday)</label>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <button class="btn btn-secondary btn-small" onclick="shiftWeek(1)" title="Previous week" style="padding:8px 12px;font-size:1.1rem;">‚óÄ</button>
                        <select id="entry-date" onchange="onWeekChange()" style="padding:10px 12px;border:1px solid var(--sage-200);border-radius:8px;font-family:'Karla',sans-serif;font-size:0.95rem;background:white;color:var(--charcoal);flex:1;"></select>
                        <button class="btn btn-secondary btn-small" onclick="shiftWeek(-1)" title="Next week" style="padding:8px 12px;font-size:1.1rem;">‚ñ∂</button>
                    </div>
                </div>
            </div>

            <!-- Summary at top -->
            <div class="summary-grid">
                <div class="summary-box"><div class="label">Total Debt</div><div class="value negative" id="we-total-debt">$0</div></div>
                <div class="summary-box"><div class="label">Total Payments</div><div class="value positive" id="we-total-payments">$0</div></div>
                <div class="summary-box"><div class="label">CC Spent This Week</div><div class="value negative" id="we-cc-spent">$0</div></div>
                <div class="summary-box"><div class="label">PNC - $500 - Set Aside</div><div class="value" id="we-after-reserve">$0</div></div>
                <div class="summary-box highlight"><div class="label">Set Aside for Bills</div><div class="value" id="we-bills-total">$0</div></div>
            </div>

            <div id="weekly-entries"></div>

            <div class="btn-row" style="margin-top:16px;">
                <button class="btn btn-primary" onclick="saveWeeklyEntries()">üíæ Save Week</button>
            </div>
        </div>
    </div>

    <!-- ==================== HISTORY ==================== -->
    <div id="tab-history" class="tab-panel">
        <div class="card">
            <h2>üìà Weekly History</h2>
            
            <!-- Filters -->
            <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end;margin-bottom:16px;">
                <div class="form-group">
                    <label>From</label>
                    <input type="date" id="hist-from" onchange="renderHistory()">
                </div>
                <div class="form-group">
                    <label>To</label>
                    <input type="date" id="hist-to" onchange="renderHistory()">
                </div>
                <button class="btn btn-small btn-secondary" onclick="resetHistoryFilters()">Reset Dates</button>
                <button class="btn btn-small btn-primary" onclick="toggleColumnPicker()" id="btn-col-toggle">‚öô Columns</button>
            </div>

            <!-- Column picker -->
            <div id="column-picker" style="display:none;background:var(--sage-50);border-radius:8px;padding:12px 16px;margin-bottom:16px;border:1px solid var(--sage-200);">
                <div style="font-size:0.8rem;font-weight:600;color:var(--sage-600);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Show / Hide Columns</div>
                <div id="column-checks" style="display:flex;flex-wrap:wrap;gap:8px 16px;"></div>
                <div style="margin-top:10px;display:flex;gap:8px;">
                    <button class="btn btn-small btn-secondary" onclick="checkAllCols(true)">All</button>
                    <button class="btn btn-small btn-secondary" onclick="checkAllCols(false)">None</button>
                    <button class="btn btn-small btn-secondary" onclick="showDebtOnly()">Debts Only</button>
                    <button class="btn btn-small btn-secondary" onclick="showBanksOnly()">Banks Only</button>
                </div>
            </div>

            <div class="table-scroll" style="max-height:600px;overflow-y:auto;">
                <table class="data-table"><thead id="history-head"></thead><tbody id="history-body"></tbody></table>
            </div>
            <div id="history-empty" class="empty-state" style="display:none;"><div class="icon">üìä</div><p>No entries yet.</p></div>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="modal-overlay" id="modal-bill-amount">
    <div class="modal">
        <h2>Enter Actual Amount</h2>
        <div class="form-group" style="margin-bottom:16px;"><label>Amount</label><input type="number" id="modal-actual-amount" step="0.01" placeholder="0.00"></div>
        <div class="btn-row">
            <button class="btn btn-primary" onclick="saveActualAmount()">Save</button>
            <button class="btn btn-secondary" onclick="closeModal('modal-bill-amount')">Cancel</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="modal-close-account">
    <div class="modal">
        <h2>Close Out Account</h2>
        <p style="margin-bottom:16px;color:var(--sage-600);">Keeps in history, removes from weekly entry.</p>
        <div class="form-group" style="margin-bottom:12px;"><label>Close Date</label><input type="date" id="modal-close-date"></div>
        <div class="form-group" style="margin-bottom:16px;"><label>Reason</label>
            <select id="modal-close-reason"><option value="paid_off">Paid Off üéâ</option><option value="closed">Closed</option><option value="refinanced">Refinanced</option><option value="other">Other</option></select>
        </div>
        <div class="btn-row">
            <button class="btn btn-primary" onclick="confirmCloseAccount()">Close Account</button>
            <button class="btn btn-secondary" onclick="closeModal('modal-close-account')">Cancel</button>
        </div>
    </div>
</div>

<script>
const SUPABASE_URL = 'https://jzpipxvxrtdhmsdkveog.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp6cGlweHZ4cnRkaG1zZGt2ZW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NTE1MjUsImV4cCI6MjA4NTMyNzUyNX0.7mm0ts91y0leGKLFCgRk6KJitah3V5WJZdiD_gHL57o';

async function supaFetch(table, method='GET', body=null, query='') {
    const opts = { method, headers: {
        'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': method==='POST' ? 'return=representation' : method==='PATCH' ? 'return=representation' : ''
    }};
    if (body) opts.body = JSON.stringify(body);
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}${query}`, opts);
    if (!res.ok) throw new Error(await res.text());
    const text = await res.text();
    return text ? JSON.parse(text) : null;
}

// State
let accounts=[], closedAccounts=[], bills=[], billPayments=[];
let editingAccountId=null, editingBillId=null, editingBillPaymentId=null, closingAccountId=null;
let currentBillMonth = new Date(); currentBillMonth.setDate(1);

// Tabs
function switchTab(tab) {
    document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');
    event.target.classList.add('active');
    if (tab==='dashboard') loadDashboard();
    if (tab==='weekly') { populateWeekDropdown(); onWeekChange(); }
    if (tab==='import') initImportTab();
    if (tab==='transactions') initTransactions();
    if (tab==='bills') loadBillPayments();
    if (tab==='history') loadHistory();
}

// Helpers
function fmt(n) {
    if (n==null||isNaN(n)) return '-';
    const v=Number(n), s='$'+Math.abs(v).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
    return v<0?`(${s})`:s;
}
function fmtDate(d){return d?new Date(d+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'-';}
function fmtShort(d){return d?new Date(d+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'}):'-';}
function monthKey(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-01`;}
function monthDisplay(d){return d.toLocaleDateString('en-US',{month:'long',year:'numeric'});}
function typeLabel(t){return{credit_card:'Credit Card',loan:'Loan',bank:'Bank',tax_debt:'Tax Debt',other:'Other'}[t]||t;}
function closeReasonLabel(r){return{paid_off:'üéâ Paid Off',closed:'Closed',refinanced:'Refinanced',other:'Other'}[r]||'-';}
function closeModal(id){document.getElementById(id).classList.remove('active');}

// ==================== ACCOUNTS ====================
async function loadAccounts() {
    try {
        accounts = await supaFetch('finance_accounts','GET',null,'?is_active=eq.true&order=display_order.asc,name.asc');
        closedAccounts = await supaFetch('finance_accounts','GET',null,'?is_active=eq.false&order=closed_date.desc');
        renderAccounts();
    } catch(e){console.error('Load accounts:',e);}
}

function renderAccounts() {
    const tbody=document.getElementById('accounts-body'), empty=document.getElementById('accounts-empty');
    if (!accounts.length){tbody.innerHTML='';empty.style.display='block';}
    else {
        empty.style.display='none';
        tbody.innerHTML=accounts.map(a=>`<tr>
            <td><strong>${a.name}</strong></td><td>${typeLabel(a.account_type)}</td>
            <td class="amount">${a.interest_rate}%</td><td class="amount">${fmt(a.starting_balance)}</td>
            <td class="amount">${fmt(a.min_payment)}</td><td>${a.pays_from||'-'}</td>
            <td><button class="btn btn-small btn-secondary" onclick="editAccount('${a.id}')">Edit</button>
            <button class="btn btn-small btn-primary" onclick="openCloseAccount('${a.id}')">Close Out</button></td>
        </tr>`).join('');
    }
    const cc=document.getElementById('closed-card'), cb=document.getElementById('closed-body');
    if (closedAccounts.length){
        cc.style.display='block';
        cb.innerHTML=closedAccounts.map(a=>`<tr style="opacity:0.8">
            <td><strong>${a.name}</strong></td><td>${typeLabel(a.account_type)}</td>
            <td class="amount">${a.interest_rate}%</td><td>${fmtDate(a.closed_date)}</td>
            <td><span class="badge ${a.closed_reason==='paid_off'?'badge-paid':'badge-auto'}">${closeReasonLabel(a.closed_reason)}</span></td>
            <td><button class="btn btn-small btn-secondary" onclick="reopenAccount('${a.id}')">Reopen</button></td>
        </tr>`).join('');
    } else cc.style.display='none';
}

async function saveAccount() {
    const data={
        name:document.getElementById('acc-name').value.trim(),
        account_type:document.getElementById('acc-type').value,
        interest_rate:parseFloat(document.getElementById('acc-rate').value)||0,
        starting_balance:parseFloat(document.getElementById('acc-starting').value)||0,
        min_payment:parseFloat(document.getElementById('acc-minpay').value)||0,
        is_debt:document.getElementById('acc-isdebt').value==='true',
        pays_from:document.getElementById('acc-paysfrom').value.trim()||null,
        notes:document.getElementById('acc-notes').value.trim()||null
    };
    if(!data.name)return alert('Enter a name.');
    try{
        if(editingAccountId){await supaFetch('finance_accounts','PATCH',data,`?id=eq.${editingAccountId}`);editingAccountId=null;document.getElementById('btn-cancel-edit').style.display='none';}
        else await supaFetch('finance_accounts','POST',data);
        clearAccForm(); await loadAccounts();
    }catch(e){alert('Error: '+e.message);}
}
function editAccount(id){
    const a=accounts.find(x=>x.id===id);if(!a)return;
    editingAccountId=id;
    document.getElementById('acc-name').value=a.name;
    document.getElementById('acc-type').value=a.account_type;
    document.getElementById('acc-rate').value=a.interest_rate;
    document.getElementById('acc-starting').value=a.starting_balance;
    document.getElementById('acc-minpay').value=a.min_payment;
    document.getElementById('acc-isdebt').value=String(a.is_debt);
    document.getElementById('acc-paysfrom').value=a.pays_from||'';
    document.getElementById('acc-notes').value=a.notes||'';
    document.getElementById('btn-cancel-edit').style.display='inline-block';
    window.scrollTo({top:0,behavior:'smooth'});
}
function cancelEditAccount(){editingAccountId=null;document.getElementById('btn-cancel-edit').style.display='none';clearAccForm();}
function clearAccForm(){['acc-name','acc-rate','acc-starting','acc-minpay','acc-paysfrom','acc-notes'].forEach(id=>document.getElementById(id).value='');document.getElementById('acc-type').value='credit_card';document.getElementById('acc-isdebt').value='true';}
function openCloseAccount(id){closingAccountId=id;document.getElementById('modal-close-date').value=new Date().toISOString().split('T')[0];document.getElementById('modal-close-account').classList.add('active');}
async function confirmCloseAccount(){
    const d=document.getElementById('modal-close-date').value,r=document.getElementById('modal-close-reason').value;
    if(!d)return alert('Pick a date.');
    try{await supaFetch('finance_accounts','PATCH',{is_active:false,closed_date:d,closed_reason:r},`?id=eq.${closingAccountId}`);closeModal('modal-close-account');await loadAccounts();}catch(e){alert('Error: '+e.message);}
}
async function reopenAccount(id){
    if(!confirm('Reopen this account?'))return;
    try{await supaFetch('finance_accounts','PATCH',{is_active:true,closed_date:null,closed_reason:null},`?id=eq.${id}`);await loadAccounts();}catch(e){alert('Error: '+e.message);}
}

// ==================== BILLS ====================
async function loadBills(){try{bills=await supaFetch('finance_bills','GET',null,'?is_active=eq.true&order=due_day.asc.nullsfirst,name.asc');}catch(e){console.error(e);}}
async function loadBillPayments(){
    try{billPayments=await supaFetch('finance_bill_payments','GET',null,`?bill_month=eq.${monthKey(currentBillMonth)}`);}catch(e){billPayments=[];}
    renderBills();
}
function renderBills(){
    const tbody=document.getElementById('bills-body'),empty=document.getElementById('bills-empty');
    document.getElementById('bill-month-display').textContent=monthDisplay(currentBillMonth);
    if(!bills.length){tbody.innerHTML='';empty.style.display='block';return;}
    empty.style.display='none';
    tbody.innerHTML=bills.map(b=>{
        const p=billPayments.find(x=>x.bill_id===b.id);
        return`<tr>
            <td><input type="checkbox" class="check-paid" ${p?.is_paid?'checked':''} ${b.is_auto_pay?'disabled title="Auto"':''} onchange="toggleBillPaid('${b.id}',this.checked)"></td>
            <td><strong>${b.name}</strong>${b.is_variable_amount?'<br><span class="badge badge-variable">Variable</span>':''}</td>
            <td>${b.is_variable_date?'Varies':(b.due_day||'-')}</td>
            <td class="amount">${b.is_variable_amount?'~':''}${fmt(b.expected_amount)}</td>
            <td class="amount">${p?.actual_amount!=null?fmt(p.actual_amount):'-'}${b.is_variable_amount?`<br><button class="btn btn-small btn-secondary" onclick="openAmountModal('${b.id}')">Enter</button>`:''}</td>
            <td>${b.is_auto_pay?'<span class="badge badge-auto">Auto</span>':''}</td>
            <td><button class="btn btn-small btn-secondary" onclick="editBill('${b.id}')">Edit</button><button class="btn btn-small btn-danger" onclick="deleteBill('${b.id}')">Del</button></td>
        </tr>`;
    }).join('');
}
function changeMonth(d){currentBillMonth.setMonth(currentBillMonth.getMonth()+d);loadBillPayments();}
async function toggleBillPaid(billId,isPaid){
    const mk=monthKey(currentBillMonth),ex=billPayments.find(p=>p.bill_id===billId),bill=bills.find(b=>b.id===billId);
    try{
        if(ex)await supaFetch('finance_bill_payments','PATCH',{is_paid:isPaid,paid_date:isPaid?new Date().toISOString().split('T')[0]:null},`?id=eq.${ex.id}`);
        else await supaFetch('finance_bill_payments','POST',{bill_id:billId,bill_month:mk,actual_amount:bill?.expected_amount||0,is_paid:isPaid,paid_date:isPaid?new Date().toISOString().split('T')[0]:null});
        await loadBillPayments();
    }catch(e){alert('Error: '+e.message);}
}
function openAmountModal(billId){editingBillPaymentId=billId;const p=billPayments.find(x=>x.bill_id===billId);document.getElementById('modal-actual-amount').value=p?.actual_amount||'';document.getElementById('modal-bill-amount').classList.add('active');}
async function saveActualAmount(){
    const amount=parseFloat(document.getElementById('modal-actual-amount').value)||0,mk=monthKey(currentBillMonth),ex=billPayments.find(p=>p.bill_id===editingBillPaymentId);
    try{
        if(ex)await supaFetch('finance_bill_payments','PATCH',{actual_amount:amount},`?id=eq.${ex.id}`);
        else await supaFetch('finance_bill_payments','POST',{bill_id:editingBillPaymentId,bill_month:mk,actual_amount:amount,is_paid:false});
        closeModal('modal-bill-amount');await loadBillPayments();
    }catch(e){alert('Error: '+e.message);}
}
async function saveBill(){
    const data={name:document.getElementById('bill-name').value.trim(),expected_amount:parseFloat(document.getElementById('bill-amount').value)||0,
        is_variable_amount:document.getElementById('bill-variable-amt').value==='true',due_day:parseInt(document.getElementById('bill-due-day').value)||null,
        is_variable_date:document.getElementById('bill-variable-date').value==='true',is_auto_pay:document.getElementById('bill-autopay').value==='true',
        pays_from:document.getElementById('bill-pays-from').value.trim(),category:document.getElementById('bill-category').value,notes:document.getElementById('bill-notes').value.trim()};
    if(!data.name)return alert('Enter a name.');
    try{
        if(editingBillId){await supaFetch('finance_bills','PATCH',data,`?id=eq.${editingBillId}`);editingBillId=null;document.getElementById('btn-cancel-bill').style.display='none';}
        else await supaFetch('finance_bills','POST',data);
        clearBillForm();await loadBills();await loadBillPayments();
    }catch(e){alert('Error: '+e.message);}
}
function editBill(id){
    const b=bills.find(x=>x.id===id);if(!b)return;editingBillId=id;
    document.getElementById('bill-name').value=b.name;document.getElementById('bill-amount').value=b.expected_amount;
    document.getElementById('bill-variable-amt').value=String(b.is_variable_amount);document.getElementById('bill-due-day').value=b.due_day||'';
    document.getElementById('bill-variable-date').value=String(b.is_variable_date);document.getElementById('bill-autopay').value=String(b.is_auto_pay);
    document.getElementById('bill-pays-from').value=b.pays_from||'';document.getElementById('bill-category').value=b.category||'other';
    document.getElementById('bill-notes').value=b.notes||'';document.getElementById('btn-cancel-bill').style.display='inline-block';
    window.scrollTo({top:0,behavior:'smooth'});
}
function cancelEditBill(){editingBillId=null;document.getElementById('btn-cancel-bill').style.display='none';clearBillForm();}
function clearBillForm(){['bill-name','bill-amount','bill-due-day','bill-pays-from','bill-notes'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('bill-variable-amt').value='false';document.getElementById('bill-variable-date').value='false';
    document.getElementById('bill-autopay').value='false';document.getElementById('bill-category').value='other';}
async function deleteBill(id){if(!confirm('Delete?'))return;try{await supaFetch('finance_bills','PATCH',{is_active:false},`?id=eq.${id}`);await loadBills();await loadBillPayments();}catch(e){alert(e.message);}}

// ==================== WEEKLY ENTRY ====================

function getWednesdays(){
    const weds=[];
    const start=new Date('2024-06-05T12:00:00');
    const end=new Date();
    end.setDate(end.getDate()+28);
    let d=new Date(start);
    while(d.getDay()!==3) d.setDate(d.getDate()+1);
    while(d<=end){
        const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
        weds.push(`${y}-${m}-${dd}`);
        d.setDate(d.getDate()+7);
    }
    return weds;
}

function populateWeekDropdown(){
    const sel=document.getElementById('entry-date');
    const weds=getWednesdays();
    const today=new Date();
    const dayOfWeek=today.getDay();
    const diff=dayOfWeek<=3?3-dayOfWeek:10-dayOfWeek;
    const thisWed=new Date(today);
    thisWed.setDate(today.getDate()+diff);
    const y=thisWed.getFullYear(), m=String(thisWed.getMonth()+1).padStart(2,'0'), dd=String(thisWed.getDate()).padStart(2,'0');
    const thisWedStr=`${y}-${m}-${dd}`;

    sel.innerHTML=weds.reverse().map(w=>{
        const dt=new Date(w+'T12:00:00');
        const label=dt.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'});
        const selected=w===thisWedStr?'selected':'';
        return`<option value="${w}" ${selected}>${label}</option>`;
    }).join('');
}

function shiftWeek(dir){
    const sel=document.getElementById('entry-date');
    const idx=sel.selectedIndex+dir;
    if(idx>=0 && idx<sel.options.length){
        sel.selectedIndex=idx;
        onWeekChange();
    }
}

async function onWeekChange(){
    loanDueDates={};
    buildWeeklyForm();
    const loaded=await loadWeekData();
    if(!loaded){
        await autoFillFromPrior();
    }
    // Always fill loans from schedule (skips accounts that already have data from saved week)
    await autoFillLoans(document.getElementById('entry-date').value, loaded);
    if(loaded){
        await fetchLoanDueDates(document.getElementById('entry-date').value);
    }
    await loadWeeklyBills();
    await calcCCSpent();
    await loadOtherPNC();
    updateTaxDueDates();
    autoDefaultBOA();
}

function autoDefaultBOA(){
    const boa=accounts.find(a=>a.name.toLowerCase().includes('boa'));
    if(!boa)return;
    const bI=document.querySelector(`input[data-id="${boa.id}"][data-f="bal"]`);
    const pI=document.querySelector(`input[data-id="${boa.id}"][data-f="pay"]`);
    if(bI && pI){
        const bal=parseFloat(bI.value)||0;
        const pay=parseFloat(pI.value)||0;
        // Only auto-fill if payment is 0 or empty and balance exists
        if(bal>0 && pay===0) pI.value=bal;
    }
    calcWeekly();
}

function updateTaxDueDates(){
    const dt=document.getElementById('entry-date').value;
    if(!dt)return;
    const weekDate=new Date(dt+'T12:00:00');
    const taxes=accounts.filter(a=>a.account_type==='tax_debt');
    taxes.forEach(a=>{
        // Find matching bill by name
        const bill=bills.find(b=>b.name.toLowerCase().includes(a.name.toLowerCase())||
            (a.name.toLowerCase().includes('fed')&&b.name.toLowerCase().includes('irs'))||
            (a.name.toLowerCase().includes('pa')&&b.name.toLowerCase().includes('pa')));
        if(bill){
            loanDueDates[a.id]=`${weekDate.getFullYear()}-${String(weekDate.getMonth()+1).padStart(2,'0')}-${String(bill.due_day).padStart(2,'0')}`;
        }
    });
    updateDueDateLabels();
}

async function calcCCSpent(){
    const dt=document.getElementById('entry-date').value;
    if(!dt)return;
    const d=new Date(dt+'T12:00:00');
    d.setDate(d.getDate()-7);
    const priorWeek=d.toISOString().split('T')[0];

    const ccs=accounts.filter(a=>a.account_type==='credit_card');
    if(!ccs.length)return;

    try{
        const priorEntries=await supaFetch('finance_weekly_entries','GET',null,
            `?entry_date=eq.${priorWeek}&account_id=in.(${ccs.map(a=>a.id).join(',')})`);

        priorCCEndings={};
        ccs.forEach(a=>{
            const prior=priorEntries?.find(e=>e.account_id===a.id);
            priorCCEndings[a.id]=prior?parseFloat(prior.ending_balance)||0:0;
        });
        updateCCSpentDisplay();
    }catch(e){console.error('CC spent calc:',e);}
}

function updateCCSpentDisplay(){
    const ccs=accounts.filter(a=>a.account_type==='credit_card');
    let totalSpent=0;
    ccs.forEach(a=>{
        const priorEnding=priorCCEndings[a.id]||0;
        const bI=document.querySelector(`input[data-id="${a.id}"][data-f="bal"]`);
        const thisStart=parseFloat(bI?.value)||0;
        const diff=thisStart-priorEnding;
        const spent=diff>0?diff:0;
        totalSpent+=spent;
        // Update per-line indicator
        const spentEl=document.querySelector(`.cc-spent[data-cc-id="${a.id}"]`);
        if(spentEl){
            if(spent>0) spentEl.textContent=`(+${fmt(spent)} spent)`;
            else if(diff<0) spentEl.textContent=`(${fmt(Math.abs(diff))} paid down)`;
            else spentEl.textContent='';
        }
    });
    const el=document.getElementById('we-cc-spent');
    if(el){
        el.textContent=fmt(totalSpent);
        el.className=`value ${totalSpent>0?'negative':'positive'}`;
    }
}

async function loadWeekData(){
    const dt=document.getElementById('entry-date').value;
    if(!dt)return false;
    try{
        const entries=await supaFetch('finance_weekly_entries','GET',null,`?entry_date=eq.${dt}`);
        if(!entries?.length)return false;
        entries.forEach(e=>{
            const bI=document.querySelector(`input[data-id="${e.account_id}"][data-f="bal"]`);
            const pI=document.querySelector(`input[data-id="${e.account_id}"][data-f="pay"]`);
            if(bI) bI.value=e.starting_balance||0;
            if(pI&&!pI.readOnly) pI.value=Math.abs(e.payment)||0;
        });
        calcWeekly();
        return true;
    }catch(e){console.error('Load week:',e);return false;}
}

async function autoFillFromPrior(){
    // Auto-fill tax balances from prior week's ending
    const dt=document.getElementById('entry-date').value;
    if(!dt)return;
    const d=new Date(dt+'T12:00:00');
    d.setDate(d.getDate()-7);
    const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0');
    const prevWed=`${y}-${m}-${dd}`;
    try{
        const prevEntries=await supaFetch('finance_weekly_entries','GET',null,`?entry_date=eq.${prevWed}`);
        if(!prevEntries?.length)return;
        // Fill tax account balances with prior ending
        const taxAccs=accounts.filter(a=>a.account_type==='tax_debt');
        prevEntries.forEach(e=>{
            const isTax=taxAccs.some(a=>a.id===e.account_id);
            if(isTax){
                const bI=document.querySelector(`input[data-id="${e.account_id}"][data-f="bal"]`);
                if(bI) bI.value=e.ending_balance||0;
            }
        });
        calcWeekly();
    }catch(e){console.error('Auto-fill:',e);}
}

let calculatedBillTotal=0;
let priorCCEndings={}; // account_id -> ending balance from prior week
let loanDueDates={}; // account_id -> next due date string
let dashCharts={}; // key -> {title, data, type}
let activeChart='debt';

async function autoFillLoans(weekStr, hasSavedData){
    if(!weekStr)return;
    const weekDate=new Date(weekStr+'T12:00:00');
    const nextWed=new Date(weekDate);
    nextWed.setDate(nextWed.getDate()+7);
    const priorWed=new Date(weekDate);
    priorWed.setDate(priorWed.getDate()-7);
    const priorWedStr=priorWed.toISOString().split('T')[0];
    const wkEnd=nextWed.toISOString().split('T')[0];

    try{
        const weekPayments=await supaFetch('finance_loan_schedules','GET',null,
            `?due_date=gt.${priorWedStr}&due_date=lte.${weekStr}&order=due_date`);

        const loanAccounts=accounts.filter(a=>a.account_type==='loan');

        for(const a of loanAccounts){
            const bI=document.querySelector(`input[data-id="${a.id}"][data-f="bal"]`);
            const pI=document.querySelector(`input[data-id="${a.id}"][data-f="pay"]`);
            if(!bI||!pI)continue;

            // Skip if this account already has saved data
            const existingBal=parseFloat(bI.value)||0;
            const existingPay=parseFloat(pI.value)||0;
            if(hasSavedData && (existingBal!==0 || existingPay!==0)) continue;

            // Balance: latest schedule entry on or before this Wed
            const balEntries=await supaFetch('finance_loan_schedules','GET',null,
                `?account_id=eq.${a.id}&due_date=lte.${weekStr}&order=due_date.desc&limit=1`);
            if(balEntries?.length){
                bI.value=balEntries[0].balance_after;
            }

            // Payments due this week for this account
            const dueThisWeek=weekPayments?.filter(p=>p.account_id===a.id)||[];
            if(dueThisWeek.length){
                const totalPay=dueThisWeek.reduce((s,p)=>s+parseFloat(p.payment_amount),0);
                pI.value=totalPay.toFixed(2);
                loanDueDates[a.id]=dueThisWeek[0].due_date;
            }
        }

        // Also fetch next upcoming due date for each loan (for label display)
        for(const a of loanAccounts){
            if(!loanDueDates[a.id]){
                const next=await supaFetch('finance_loan_schedules','GET',null,
                    `?account_id=eq.${a.id}&due_date=gt.${weekStr}&order=due_date&limit=1`);
                if(next?.length) loanDueDates[a.id]=next[0].due_date;
            }
        }
        updateDueDateLabels();
        calcWeekly();
    }catch(e){console.error('Auto-fill loans:',e);}
}

function updateDueDateLabels(){
    const dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const monthNames=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    accounts.forEach(a=>{
        const dd=loanDueDates[a.id];
        if(!dd)return;
        const label=document.querySelector(`label[data-acct-id="${a.id}"] .due-date`);
        if(label){
            const d=new Date(dd+'T12:00:00');
            const day=d.getDate();
            const suffix=day===1||day===21||day===31?'st':day===2||day===22?'nd':day===3||day===23?'rd':'th';
            label.textContent=`üìÖ ${monthNames[d.getMonth()]} ${day}${suffix}`;
        }
    });
}

function isDueThisWeek(dueDay,weekStart,weekEnd){
    for(let m=0;m<2;m++){
        const checkDate=new Date(weekStart);
        checkDate.setMonth(checkDate.getMonth()+m);
        checkDate.setDate(dueDay);
        if(checkDate.getDate()!==dueDay)continue;
        if(checkDate>=weekStart && checkDate<weekEnd) return true;
    }
    return false;
}

async function fetchLoanDueDates(weekStr){
    if(!weekStr)return;
    const priorWed=new Date(weekStr+'T12:00:00');
    priorWed.setDate(priorWed.getDate()-7);
    const priorWedStr=priorWed.toISOString().split('T')[0];

    const loanAccounts=accounts.filter(a=>a.account_type==='loan');
    try{
        // Check for payments due this week
        const weekPayments=await supaFetch('finance_loan_schedules','GET',null,
            `?due_date=gt.${priorWedStr}&due_date=lte.${weekStr}&order=due_date`);
        loanAccounts.forEach(a=>{
            const due=weekPayments?.find(p=>p.account_id===a.id);
            if(due) loanDueDates[a.id]=due.due_date;
        });
        // For any without, get next upcoming
        for(const a of loanAccounts){
            if(!loanDueDates[a.id]){
                const next=await supaFetch('finance_loan_schedules','GET',null,
                    `?account_id=eq.${a.id}&due_date=gt.${weekStr}&order=due_date&limit=1`);
                if(next?.length) loanDueDates[a.id]=next[0].due_date;
            }
        }
        updateDueDateLabels();
    }catch(e){console.error('Fetch loan due dates:',e);}
}

async function loadWeeklyBills(){
    const dt=document.getElementById('entry-date').value;
    if(!dt||!bills.length){document.getElementById('weekly-bills-section').style.display='none';document.getElementById('weekly-bills-total-row').style.display='none';return;}

    const weekDate=new Date(dt+'T12:00:00');
    const nextWed=new Date(weekDate);
    nextWed.setDate(nextWed.getDate()+7);

    const mk1=`${weekDate.getFullYear()}-${String(weekDate.getMonth()+1).padStart(2,'0')}-01`;
    const mk2=`${nextWed.getFullYear()}-${String(nextWed.getMonth()+1).padStart(2,'0')}-01`;

    let payments=[];
    try{
        payments=await supaFetch('finance_bill_payments','GET',null,`?bill_month=eq.${mk1}`);
        if(mk2!==mk1){
            const p2=await supaFetch('finance_bill_payments','GET',null,`?bill_month=eq.${mk2}`);
            if(p2) payments=payments.concat(p2);
        }
    }catch(e){payments=[];}

    // Only show household bills - exclude tax and loan bills
    const excludeNames=['irs','pa tax','kubota','side by side'];
    const householdBills=bills.filter(b=>!excludeNames.some(n=>b.name.toLowerCase().includes(n)));

    // Find bills due between this Wed and next Wed
    const dueBills=[];
    householdBills.forEach(b=>{
        if(!b.due_day)return;
        for(let m=0;m<2;m++){
            const checkDate=new Date(weekDate);
            checkDate.setMonth(checkDate.getMonth()+m);
            checkDate.setDate(b.due_day);
            if(checkDate.getDate()!==b.due_day) continue;
            if(checkDate>=weekDate && checkDate<nextWed){
                const billMonth=`${checkDate.getFullYear()}-${String(checkDate.getMonth()+1).padStart(2,'0')}-01`;
                const p=payments.find(x=>x.bill_id===b.id && x.bill_month===billMonth);
                dueBills.push({bill:b, dueDate:new Date(checkDate), payment:p, billMonth});
                break;
            }
        }
    });

    dueBills.sort((a,b)=>a.dueDate-b.dueDate);

    const section=document.getElementById('weekly-bills-section');
    const list=document.getElementById('weekly-bills-list');
    const totalRow=document.getElementById('weekly-bills-total-row');
    section.style.display='';
    totalRow.style.display='flex';

    calculatedBillTotal=0;
    let html='';

    if(dueBills.length){
        html+=`<div style="display:grid;grid-template-columns:30px 1fr 110px 110px 60px;gap:8px;align-items:center;padding:8px 0;font-size:0.8rem;font-weight:600;color:var(--sage-600);text-transform:uppercase;letter-spacing:0.5px;border-bottom:2px solid var(--sage-300);">
            <div>‚úì</div><div>Bill</div><div style="text-align:center">Date</div><div style="text-align:right">Amount</div><div></div>
        </div>`;

        dueBills.forEach(({bill:b, dueDate, payment:p, billMonth})=>{
            const amt=p?.actual_amount||b.expected_amount||0;
            const paid=p?p.is_paid:true; // default to paid if no record
            const dateVal=p?.paid_date||`${dueDate.getFullYear()}-${String(dueDate.getMonth()+1).padStart(2,'0')}-${String(dueDate.getDate()).padStart(2,'0')}`;
            calculatedBillTotal+=amt;

            html+=`<div style="display:grid;grid-template-columns:30px 1fr 110px 110px 60px;gap:8px;align-items:center;padding:8px 0;border-bottom:1px solid var(--sage-100);${paid?'opacity:0.5':''}">
                <div><input type="checkbox" class="check-paid" data-bill-id="${b.id}" data-bill-month="${billMonth}" ${paid?'checked':''} onchange="toggleWeeklyBillPaid('${b.id}','${billMonth}',this.checked,this)" style="accent-color:var(--sage-500);width:18px;height:18px;cursor:pointer;"></div>
                <div>
                    <strong>${b.name}</strong>
                    ${b.is_variable_amount?'<span class="badge badge-variable" style="margin-left:4px;">~</span>':''}
                    ${b.is_auto_pay?'<span class="badge badge-auto" style="margin-left:4px;">Auto</span>':''}
                </div>
                <div><input type="date" value="${dateVal}" data-bill-id="${b.id}" data-bill-month="${billMonth}" data-field="date" style="padding:4px 6px;border:1px solid var(--sage-200);border-radius:6px;font-family:'Karla',sans-serif;font-size:0.85rem;width:100%;"></div>
                <div><input type="number" step="0.01" value="${amt.toFixed(2)}" data-bill-id="${b.id}" data-bill-month="${billMonth}" data-field="amount" onchange="recalcBillTotal()" style="padding:4px 8px;border:1px solid var(--sage-200);border-radius:6px;font-family:'Karla',sans-serif;font-size:0.9rem;text-align:right;width:100%;"></div>
                <div><button class="btn btn-small btn-secondary" onclick="saveWeeklyBill('${b.id}','${billMonth}')">‚úì</button></div>
            </div>`;
        });
    } else {
        html+='<p style="color:var(--sage-400);padding:12px 0;">No bills due before next Wednesday</p>';
    }

    // Monthly summary - household bills only
    let monthTotal=0, paidTotal=0;
    const mkCurrent=`${weekDate.getFullYear()}-${String(weekDate.getMonth()+1).padStart(2,'0')}-01`;
    householdBills.forEach(b=>{
        const p=payments.find(x=>x.bill_id===b.id && x.bill_month===mkCurrent);
        const amt=p?.actual_amount||b.expected_amount||0;
        monthTotal+=amt;
        if(p?.is_paid) paidTotal+=amt;
    });

    html+=`<div style="display:flex;justify-content:space-between;padding:8px 0;font-size:0.85rem;border-top:1px solid var(--sage-200);margin-top:8px;">
        <span>Month total: ${fmt(monthTotal)}</span>
        <span style="color:var(--green-soft);">Paid: ${fmt(paidTotal)}</span>
        <span style="color:var(--dusty-rose);">Remaining: ${fmt(monthTotal-paidTotal)}</span>
    </div>`;
    list.innerHTML=html;

    // Set the override total to calculated amount
    document.getElementById('bills-override-total').value=calculatedBillTotal.toFixed(2);
    calcWeekly();
}

function recalcBillTotal(){
    let total=0;
    document.querySelectorAll('#weekly-bills-list input[data-field="amount"]').forEach(input=>{
        total+=parseFloat(input.value)||0;
    });
    calculatedBillTotal=total;
    document.getElementById('bills-override-total').value=total.toFixed(2);
    calcWeekly();
}

function resetBillTotal(){
    document.getElementById('bills-override-total').value=calculatedBillTotal.toFixed(2);
    calcWeekly();
}

async function toggleWeeklyBillPaid(billId,billMonth,isPaid,checkbox){
    const row=checkbox.closest('div[style*="grid"]');
    const amtInput=row.querySelector('input[data-field="amount"]');
    const dateInput=row.querySelector('input[data-field="date"]');
    const amt=parseFloat(amtInput?.value)||0;
    const paidDate=dateInput?.value||null;

    try{
        const existing=await supaFetch('finance_bill_payments','GET',null,`?bill_id=eq.${billId}&bill_month=eq.${billMonth}`);
        if(existing?.length){
            await supaFetch('finance_bill_payments','PATCH',{is_paid:isPaid,actual_amount:amt,paid_date:isPaid?paidDate:null},`?id=eq.${existing[0].id}`);
        }else{
            await supaFetch('finance_bill_payments','POST',{bill_id:billId,bill_month:billMonth,actual_amount:amt,is_paid:isPaid,paid_date:isPaid?paidDate:null});
        }
        await loadWeeklyBills();
    }catch(e){alert('Error: '+e.message);}
}
async function saveWeeklyBill(billId,billMonth){
    const amtInput=document.querySelector(`input[data-bill-id="${billId}"][data-bill-month="${billMonth}"][data-field="amount"]`);
    const dateInput=document.querySelector(`input[data-bill-id="${billId}"][data-bill-month="${billMonth}"][data-field="date"]`);
    const amt=parseFloat(amtInput?.value)||0;
    const paidDate=dateInput?.value||null;

    try{
        const existing=await supaFetch('finance_bill_payments','GET',null,`?bill_id=eq.${billId}&bill_month=eq.${billMonth}`);
        if(existing?.length){
            await supaFetch('finance_bill_payments','PATCH',{actual_amount:amt,paid_date:paidDate},`?id=eq.${existing[0].id}`);
        }else{
            await supaFetch('finance_bill_payments','POST',{bill_id:billId,bill_month:billMonth,actual_amount:amt,is_paid:false,paid_date:paidDate});
        }
        await loadWeeklyBills();
    }catch(e){alert('Error: '+e.message);}
}

function buildWeeklyForm(){
    const c=document.getElementById('weekly-entries');
    if(!accounts.length){c.innerHTML='<p style="color:var(--sage-600);padding:12px 0;">Add accounts first.</p>';return;}

    const pnc=accounts.find(a=>a.name.toLowerCase().includes('pnc'));
    const rental=accounts.find(a=>a.name.toLowerCase().includes('rental'));
    const ccs=accounts.filter(a=>a.account_type==='credit_card');
    const taxes=accounts.filter(a=>a.account_type==='tax_debt');
    const loans=accounts.filter(a=>a.is_debt && a.account_type==='loan');
    const skipIds=new Set([pnc?.id,rental?.id,...ccs.map(a=>a.id),...taxes.map(a=>a.id),...loans.map(a=>a.id)].filter(Boolean));
    const recurringAcc=accounts.find(a=>a.name.toLowerCase().includes('recurring'));
    if(recurringAcc) skipIds.add(recurringAcc.id);
    const other=accounts.filter(a=>!skipIds.has(a.id));

    let h=`<div class="entry-row header"><div>Account</div><div style="text-align:right">Balance</div><div style="text-align:right">Payment</div><div style="text-align:right">Ending</div></div>`;

    if(pnc){
        h+=`<div class="section-divider">üí∞ PNC Checking</div>`;
        h+=`<div class="entry-row">
            <label>${pnc.name}</label>
            <input type="number" step="0.01" placeholder="0.00" data-id="${pnc.id}" data-f="bal" class="we-in" oninput="calcWeekly()">
            <input type="number" step="0.01" placeholder="0.00" data-id="${pnc.id}" data-f="pay" class="we-in" readonly style="background:var(--sage-100);font-weight:600;color:var(--sage-700);" title="Auto-calculated">
            <div class="calc" data-id="${pnc.id}" data-f="end">-</div>
        </div>
        <div style="font-size:0.75rem;color:var(--sage-400);padding:2px 0 6px;font-style:italic;">‚Üë Auto-totals from all payments + bills + other below</div>`;

        // Other PNC Payments (dynamic rows)
        h+=`<div class="section-divider" style="font-size:0.9rem;">üí∏ Other PNC Payments</div>`;
        h+=`<div id="other-pnc-rows"></div>`;
        h+=`<div style="display:flex;gap:8px;align-items:center;padding:4px 0 12px;">
            <button class="btn btn-small btn-secondary" onclick="addOtherPNC()">+ Add Payment</button>
            <div style="flex:1;text-align:right;font-weight:700;color:var(--sage-700);font-size:0.9rem;">Other Total: <span id="other-pnc-total">$0.00</span></div>
        </div>`;
    }

    if(ccs.length){
        h+=`<div class="section-divider">üí≥ Credit Cards</div>`;
        ccs.forEach(a=>{h+=ccEntryRow(a);});
        h+=sumRow('cc','CC Total');
    }

    if(taxes.length){
        h+=`<div class="section-divider">üèõÔ∏è Tax Debts</div>`;
        taxes.forEach(a=>{h+=entryRow(a,true);});
        h+=sumRow('tax','Tax Total');
    }

    if(loans.length){
        h+=`<div class="section-divider">üè¶ Loans</div>`;
        loans.forEach(a=>{h+=entryRow(a,true);});
        h+=sumRow('loan','Loan Total');
    }

    if(rental){
        h+=`<div class="section-divider">üè† Rental <span style="font-size:0.7rem;color:var(--sage-400);font-weight:400;margin-left:8px;">payment = income into PNC</span></div>`;
        h+=entryRow(rental,false);
    }

    // Set Aside for Bills placeholder - filled by loadWeeklyBills
    h+=`<div class="section-divider" id="weekly-bills-section" style="display:none;">üìã Set Aside for Bills</div>`;
    h+=`<div id="weekly-bills-list"></div>`;
    h+=`<div id="weekly-bills-total-row" style="display:none;display:flex;align-items:center;gap:12px;margin:8px 0 12px;padding-top:8px;border-top:2px solid var(--sage-300);">
        <label style="font-weight:700;color:var(--sage-700);white-space:nowrap;font-size:0.9rem;">Bill Total (from PNC):</label>
        <input type="number" step="0.01" id="bills-override-total" oninput="calcWeekly()" style="padding:6px 10px;border:2px solid var(--sage-400);border-radius:8px;font-family:'Karla',sans-serif;font-size:1rem;font-weight:700;text-align:right;width:140px;background:white;color:var(--charcoal);">
        <button class="btn btn-small btn-secondary" onclick="resetBillTotal()" title="Reset to calculated total">‚Üª</button>
    </div>`;

    if(other.length){
        const filtered=other.filter(a=>!a.name.toLowerCase().includes('recurring'));
        if(filtered.length){
            h+=`<div class="section-divider">Other</div>`;
            filtered.forEach(a=>{h+=entryRow(a,false);});
        }
    }

    c.innerHTML=h;
}

function entryRow(a,showRate){
    const rateStr=showRate?' <span class="rate">'+a.interest_rate+'%</span>':'';
    const dueStr=(a.account_type==='loan'||a.account_type==='tax_debt')?' <span class="rate due-date" style="color:var(--sage-500);"></span>':'';
    return`<div class="entry-row">
        <label data-acct-id="${a.id}">${a.name}${rateStr}${dueStr}</label>
        <input type="number" step="0.01" placeholder="0.00" data-id="${a.id}" data-f="bal" class="we-in" oninput="calcWeekly()">
        <input type="number" step="0.01" placeholder="0.00" data-id="${a.id}" data-f="pay" class="we-in" oninput="calcWeekly()">
        <div class="calc" data-id="${a.id}" data-f="end">-</div>
    </div>`;
}

function ccEntryRow(a){
    const isBOA=a.name.toLowerCase().includes('boa');
    return`<div class="entry-row">
        <label data-acct-id="${a.id}">${a.name} <span class="rate">${a.interest_rate}%</span> <span class="cc-spent" data-cc-id="${a.id}" style="color:var(--sage-500);font-size:0.75rem;font-weight:400;"></span></label>
        <input type="number" step="0.01" placeholder="0.00" data-id="${a.id}" data-f="bal" data-type="credit_card" data-debt="true" class="we-in" oninput="${isBOA?'autoPayBOA(this);':''}calcWeekly()">
        <input type="number" step="0.01" placeholder="0.00" data-id="${a.id}" data-f="pay" class="we-in" oninput="calcWeekly()">
        <div class="calc" data-id="${a.id}" data-f="end">-</div>
    </div>`;
}

function autoPayBOA(balInput){
    const id=balInput.dataset.id;
    const payInput=document.querySelector(`input[data-id="${id}"][data-f="pay"]`);
    if(payInput) payInput.value=balInput.value;
}

// Other PNC Payments
let otherPNCCounter=0;
function addOtherPNC(desc='',amt=''){
    otherPNCCounter++;
    const container=document.getElementById('other-pnc-rows');
    const row=document.createElement('div');
    row.id=`opnc-${otherPNCCounter}`;
    row.style.cssText='display:grid;grid-template-columns:1fr 120px 30px;gap:8px;align-items:center;padding:4px 0;';
    row.innerHTML=`
        <input type="text" placeholder="Description (e.g. Childcare)" value="${desc}" class="opnc-desc" style="padding:6px 10px;border:1px solid var(--sage-200);border-radius:6px;font-family:'Karla',sans-serif;font-size:0.9rem;">
        <input type="number" step="0.01" placeholder="0.00" value="${amt}" class="opnc-amt" oninput="calcWeekly()" style="padding:6px 10px;border:1px solid var(--sage-200);border-radius:6px;font-family:'Karla',sans-serif;font-size:0.9rem;text-align:right;">
        <button onclick="this.parentElement.remove();calcWeekly();" style="background:none;border:none;cursor:pointer;font-size:1.1rem;color:var(--sage-400);" title="Remove">‚úï</button>
    `;
    container.appendChild(row);
}

function getOtherPNCTotal(){
    let total=0;
    document.querySelectorAll('.opnc-amt').forEach(i=>{total+=parseFloat(i.value)||0;});
    const el=document.getElementById('other-pnc-total');
    if(el) el.textContent=fmt(total);
    return total;
}

function getOtherPNCData(){
    const items=[];
    document.querySelectorAll('#other-pnc-rows > div').forEach(row=>{
        const desc=row.querySelector('.opnc-desc')?.value||'';
        const amt=parseFloat(row.querySelector('.opnc-amt')?.value)||0;
        if(desc||amt) items.push({description:desc,amount:amt});
    });
    return items;
}

async function loadOtherPNC(){
    const dt=document.getElementById('entry-date').value;
    if(!dt)return;
    const container=document.getElementById('other-pnc-rows');
    if(!container)return;
    container.innerHTML='';
    otherPNCCounter=0;
    try{
        const rows=await supaFetch('finance_other_payments','GET',null,`?entry_date=eq.${dt}&order=id`);
        if(rows?.length){
            rows.forEach(r=>addOtherPNC(r.description||'',r.amount||''));
        }
        calcWeekly();
    }catch(e){console.error('Load other PNC:',e);}
}

async function saveOtherPNC(dt){
    const items=getOtherPNCData();
    try{
        await supaFetch('finance_other_payments','DELETE',null,`?entry_date=eq.${dt}`);
        if(items.length){
            const rows=items.map(i=>({entry_date:dt,description:i.description,amount:i.amount}));
            await supaFetch('finance_other_payments','POST',rows);
        }
    }catch(e){console.error('Save other PNC:',e);}
}

function sumRow(prefix,label){
    return`<div class="entry-row" style="font-weight:700;color:var(--sage-700);border-top:2px solid var(--sage-300);padding-top:10px;">
        <label>${label}</label><div class="calc" id="sum-${prefix}-bal" style="text-align:right;padding-right:12px;">-</div><div class="calc" id="sum-${prefix}-pay" style="text-align:right;padding-right:12px;">-</div><div class="calc" id="sum-${prefix}-end" style="text-align:right;padding-right:12px;">-</div>
    </div>`;
}

function calcWeekly(){
    let totalDebt=0, totalDebtPay=0, pncBal=0;
    let ccBal=0,ccPay=0,ccEnd=0, taxBal=0,taxPay=0,taxEnd=0, loanBal=0,loanPay=0,loanEnd=0;
    let pncAutoPayTotal=0;
    let rentalIncome=0;

    const pncAcc=accounts.find(a=>a.name.toLowerCase().includes('pnc'));
    const rentalAcc=accounts.find(a=>a.name.toLowerCase().includes('rental'));
    const billsTotal=parseFloat(document.getElementById('bills-override-total')?.value)||0;

    accounts.forEach(a=>{
        const bI=document.querySelector(`input[data-id="${a.id}"][data-f="bal"]`);
        const pI=document.querySelector(`input[data-id="${a.id}"][data-f="pay"]`);
        const eD=document.querySelector(`div[data-id="${a.id}"][data-f="end"]`);
        if(!bI)return;

        if(pncAcc && a.id===pncAcc.id){
            pncBal=parseFloat(bI.value)||0;
            return;
        }

        const bal=parseFloat(bI.value)||0, pay=parseFloat(pI.value)||0;

        // Rental: payment is income (bal + pay)
        if(rentalAcc && a.id===rentalAcc.id){
            const end=bal+pay;
            eD.textContent=fmt(end); eD.className=`calc ${end<0?'negative':''}`;
            rentalIncome+=pay;
            return;
        }

        const end=bal-pay;
        eD.textContent=fmt(end); eD.className=`calc ${end<0?'negative':''}`;

        if(a.is_debt){totalDebt+=bal; totalDebtPay+=pay;}

        if(a.pays_from && a.pays_from.toLowerCase().includes('pnc') && pay>0){
            pncAutoPayTotal+=pay;
        }

        if(a.account_type==='credit_card'){ccBal+=bal;ccPay+=pay;ccEnd+=end;}
        if(a.account_type==='tax_debt'){taxBal+=bal;taxPay+=pay;taxEnd+=end;}
        if(a.is_debt&&a.account_type==='loan'){loanBal+=bal;loanPay+=pay;loanEnd+=end;}
    });

    // PNC: subtract expenses, add rental income
    if(pncAcc){
        const otherPNC=getOtherPNCTotal();
        const totalOut=pncAutoPayTotal+billsTotal+otherPNC;
        const pncPayInput=document.querySelector(`input[data-id="${pncAcc.id}"][data-f="pay"]`);
        const pncEndDiv=document.querySelector(`div[data-id="${pncAcc.id}"][data-f="end"]`);
        const netOut=totalOut-rentalIncome;
        if(pncPayInput) pncPayInput.value=netOut.toFixed(2);
        const pncEnding=pncBal-netOut;
        if(pncEndDiv){pncEndDiv.textContent=fmt(pncEnding);pncEndDiv.className=`calc ${pncEnding<0?'negative':''}`;}

        const afterAll=pncEnding-500;

        document.getElementById('we-after-reserve').textContent=fmt(afterAll);
        document.getElementById('we-after-reserve').className=`value ${afterAll>=0?'positive':'negative'}`;
        document.getElementById('we-bills-total').textContent=fmt(billsTotal);
    }

    const setSum=(id,val)=>{const el=document.getElementById(id);if(el)el.textContent=fmt(val);};
    setSum('sum-cc-bal',ccBal);setSum('sum-cc-pay',ccPay);setSum('sum-cc-end',ccEnd);
    setSum('sum-tax-bal',taxBal);setSum('sum-tax-pay',taxPay);setSum('sum-tax-end',taxEnd);
    setSum('sum-loan-bal',loanBal);setSum('sum-loan-pay',loanPay);setSum('sum-loan-end',loanEnd);

    document.getElementById('we-total-debt').textContent=fmt(totalDebt);
    document.getElementById('we-total-payments').textContent=fmt(totalDebtPay);
    updateCCSpentDisplay();
}

async function loadPreviousWeek(){
    const currentDate=document.getElementById('entry-date').value;
    if(!currentDate)return;
    // Find the Wednesday before this one
    const d=new Date(currentDate+'T00:00:00');
    d.setDate(d.getDate()-7);
    const prevWed=d.toISOString().split('T')[0];
    try{
        const prevEntries=await supaFetch('finance_weekly_entries','GET',null,`?entry_date=eq.${prevWed}`);
        if(!prevEntries?.length)return alert('No data for previous week.');
        prevEntries.forEach(e=>{
            const bI=document.querySelector(`input[data-id="${e.account_id}"][data-f="bal"]`);
            if(bI) bI.value=e.ending_balance||e.starting_balance||0;
        });
        calcWeekly();
    }catch(e){alert('Error: '+e.message);}
}

async function saveWeeklyEntries(){
    const dt=document.getElementById('entry-date').value;
    if(!dt)return alert('Pick a week.');
    const entries=[];
    const rentalAcc=accounts.find(a=>a.name.toLowerCase().includes('rental'));
    accounts.forEach(a=>{
        const bI=document.querySelector(`input[data-id="${a.id}"][data-f="bal"]`);
        const pI=document.querySelector(`input[data-id="${a.id}"][data-f="pay"]`);
        if(!bI)return;
        const bal=parseFloat(bI.value)||0, pay=parseFloat(pI.value)||0;
        const isRental=rentalAcc&&a.id===rentalAcc.id;
        const ending=isRental?bal+pay:bal-pay;
        if(bal!==0||pay!==0) entries.push({entry_date:dt,account_id:a.id,starting_balance:bal,payment:isRental?pay:-pay,ending_balance:ending});
    });
    if(!entries.length)return alert('Enter at least one balance.');
    try{
        await supaFetch('finance_weekly_entries','DELETE',null,`?entry_date=eq.${dt}`);
        await supaFetch('finance_weekly_entries','POST',entries);

        // Also save all bill edits
        const billRows=document.querySelectorAll('#weekly-bills-list [data-bill-id]');
        const billPairs=new Set();
        billRows.forEach(el=>{
            const key=el.dataset.billId+'|'+el.dataset.billMonth;
            if(billPairs.has(key))return;
            billPairs.add(key);
            const billId=el.dataset.billId, billMonth=el.dataset.billMonth;
            const amtInput=document.querySelector(`input[data-bill-id="${billId}"][data-bill-month="${billMonth}"][data-field="amount"]`);
            const dateInput=document.querySelector(`input[data-bill-id="${billId}"][data-bill-month="${billMonth}"][data-field="date"]`);
            const checkbox=document.querySelector(`.check-paid[data-bill-id="${billId}"][data-bill-month="${billMonth}"]`);
            if(amtInput){
                const amt=parseFloat(amtInput.value)||0;
                const paidDate=dateInput?.value||null;
                const isPaid=checkbox?.checked||false;
                saveBillPayment(billId,billMonth,amt,paidDate,isPaid);
            }
        });

        // Save other PNC payments
        await saveOtherPNC(dt);

        alert('Week saved!');
    }catch(e){alert('Error: '+e.message);}
}

async function saveBillPayment(billId,billMonth,amt,paidDate,isPaid){
    try{
        const existing=await supaFetch('finance_bill_payments','GET',null,`?bill_id=eq.${billId}&bill_month=eq.${billMonth}`);
        if(existing?.length){
            await supaFetch('finance_bill_payments','PATCH',{actual_amount:amt,paid_date:paidDate,is_paid:isPaid},`?id=eq.${existing[0].id}`);
        }else{
            await supaFetch('finance_bill_payments','POST',{bill_id:billId,bill_month:billMonth,actual_amount:amt,is_paid:isPaid,paid_date:paidDate});
        }
    }catch(e){console.error('Bill save error:',e);}
}

// ==================== HISTORY ====================
let historyEntries=[], historyOrdered=[], historyDates=[], historyAccMap={};
let visibleCols=new Set(); // account IDs that are visible

async function loadHistory(){
    try{
        historyEntries=await supaFetch('finance_weekly_entries','GET',null,'?order=entry_date.desc');
        if(!historyEntries?.length){document.getElementById('history-empty').style.display='block';document.getElementById('history-head').innerHTML='';document.getElementById('history-body').innerHTML='';return;}
        document.getElementById('history-empty').style.display='none';

        const allAcc=[...accounts,...closedAccounts];
        historyAccMap={};
        allAcc.forEach(a=>historyAccMap[a.id]=a);

        historyDates=[...new Set(historyEntries.map(e=>e.entry_date))];
        const accIds=[...new Set(historyEntries.map(e=>e.account_id))];
        historyOrdered=accIds.map(id=>historyAccMap[id]).filter(Boolean).sort((a,b)=>{
            if(a.is_debt!==b.is_debt)return a.is_debt?-1:1;
            return(a.display_order||0)-(b.display_order||0);
        });

        // Init visible columns (all on first load)
        if(visibleCols.size===0) historyOrdered.forEach(a=>visibleCols.add(a.id));

        buildColumnPicker();
        renderHistory();
    }catch(e){console.error('History:',e);}
}

function buildColumnPicker(){
    const container=document.getElementById('column-checks');
    container.innerHTML=historyOrdered.map(a=>`
        <label style="display:flex;align-items:center;gap:4px;font-size:0.85rem;cursor:pointer;color:var(--charcoal);">
            <input type="checkbox" ${visibleCols.has(a.id)?'checked':''} onchange="toggleCol('${a.id}',this.checked)" style="accent-color:var(--sage-500);">
            ${a.name}
        </label>
    `).join('');
}

function toggleCol(id,checked){
    if(checked)visibleCols.add(id); else visibleCols.delete(id);
    renderHistory();
}
function checkAllCols(on){
    historyOrdered.forEach(a=>{if(on)visibleCols.add(a.id);else visibleCols.delete(a.id);});
    buildColumnPicker();renderHistory();
}
function showDebtOnly(){
    visibleCols.clear();
    historyOrdered.filter(a=>a.is_debt).forEach(a=>visibleCols.add(a.id));
    buildColumnPicker();renderHistory();
}
function showBanksOnly(){
    visibleCols.clear();
    historyOrdered.filter(a=>!a.is_debt).forEach(a=>visibleCols.add(a.id));
    buildColumnPicker();renderHistory();
}
function toggleColumnPicker(){
    const el=document.getElementById('column-picker');
    el.style.display=el.style.display==='none'?'block':'none';
}
function resetHistoryFilters(){
    document.getElementById('hist-from').value='';
    document.getElementById('hist-to').value='';
    renderHistory();
}

function renderHistory(){
    const fromDate=document.getElementById('hist-from').value;
    const toDate=document.getElementById('hist-to').value;

    // Filter dates
    let dates=historyDates;
    if(fromDate) dates=dates.filter(d=>d>=fromDate);
    if(toDate) dates=dates.filter(d=>d<=toDate);

    // Visible accounts
    const shown=historyOrdered.filter(a=>visibleCols.has(a.id));
    const hasDebt=shown.some(a=>a.is_debt);

    document.getElementById('history-head').innerHTML=`<tr><th>Date</th>${shown.map(a=>`<th class="amount">${a.name}</th>`).join('')}${hasDebt?'<th class="amount">Total Debt</th>':''}</tr>`;

    document.getElementById('history-body').innerHTML=dates.map((date,i)=>{
        const week=historyEntries.filter(e=>e.entry_date===date), eMap={};
        week.forEach(e=>eMap[e.account_id]=e);
        let debt=0;
        const cells=shown.map(a=>{
            const e=eMap[a.id];
            if(e){if(a.is_debt)debt+=e.ending_balance;return`<td class="amount">${fmt(e.ending_balance)}</td>`;}
            return`<td class="amount" style="color:var(--sage-300)">-</td>`;
        }).join('');

        let prevDebt=0, debtCell='';
        if(hasDebt){
            const nextIdx=historyDates.indexOf(dates[i])+1;
            if(nextIdx<historyDates.length){
                const prevDate=historyDates[nextIdx];
                historyEntries.filter(e=>e.entry_date===prevDate).forEach(e=>{const a=historyAccMap[e.account_id];if(a?.is_debt&&visibleCols.has(a.id))prevDebt+=e.ending_balance;});
            }
            const chg=nextIdx<historyDates.length?debt-prevDebt:0;
            debtCell=`<td class="amount">${fmt(debt)}${chg!==0?`<br><small class="${chg<0?'positive':'negative'}">${chg<0?'‚ñº':'‚ñ≤'} ${fmt(Math.abs(chg))}</small>`:''}</td>`;
        }

        return`<tr><td><strong>${fmtShort(date)}</strong></td>${cells}${debtCell}</tr>`;
    }).join('');
}

// ==================== INIT ====================
// ==================== DASHBOARD ====================
async function loadDashboard(){
    try{
        const allAcc=[...accounts,...closedAccounts];
        const accMap={};allAcc.forEach(a=>accMap[a.id]=a);

        // Get the 2 most recent entries PER account (for spend calc)
        let ccTotal=0, loanTotal=0, taxTotal=0, ccSpent=0, boaSpent=0;

        const ccAccs=allAcc.filter(a=>a.account_type==='credit_card');
        const boaAcc=ccAccs.find(a=>a.name?.toLowerCase().includes('boa'));
        const taxAccs=allAcc.filter(a=>a.account_type==='tax_debt');
        const loanAccs=accounts.filter(a=>a.account_type==='loan');

        // CC balances + spend
        for(const cc of ccAccs){
            const rows=await supaFetch('finance_weekly_entries','GET',null,
                `?account_id=eq.${cc.id}&order=entry_date.desc&limit=2`);
            if(rows?.length){
                const latest=rows[0];
                const bal=parseFloat(latest.ending_balance)||0;
                ccTotal+=bal;
                // Spend = this week start - last week end
                if(rows.length>=2){
                    const thisStart=parseFloat(latest.starting_balance)||0;
                    const prevEnd=parseFloat(rows[1].ending_balance)||0;
                    const spent=Math.max(0,thisStart-prevEnd);
                    if(cc.id===boaAcc?.id) boaSpent=spent;
                    else ccSpent+=spent;
                }
            }
        }

        // Tax totals
        for(const t of taxAccs){
            const rows=await supaFetch('finance_weekly_entries','GET',null,
                `?account_id=eq.${t.id}&order=entry_date.desc&limit=1`);
            if(rows?.length) taxTotal+=parseFloat(rows[0].ending_balance)||0;
        }

        // Loan totals from schedule
        let schedLoanTotal=0;
        const today=new Date().toISOString().split('T')[0];
        for(const a of loanAccs){
            const r=await supaFetch('finance_loan_schedules','GET',null,
                `?account_id=eq.${a.id}&due_date=lte.${today}&order=due_date.desc&limit=1`);
            if(r?.length) schedLoanTotal+=parseFloat(r[0].balance_after)||0;
        }
        // Fallback to saved entries if no schedule
        if(!schedLoanTotal){
            for(const a of loanAccs){
                const rows=await supaFetch('finance_weekly_entries','GET',null,
                    `?account_id=eq.${a.id}&order=entry_date.desc&limit=1`);
                if(rows?.length) loanTotal+=parseFloat(rows[0].ending_balance)||0;
            }
        }
        const loanDisplay=schedLoanTotal||loanTotal;

        // Electric bills
        let electricTotal=0;
        const elecBills=bills.filter(b=>b.name?.toLowerCase().includes('electric'));
        for(const b of elecBills){
            const payments=await supaFetch('finance_bill_payments','GET',null,
                `?bill_id=eq.${b.id}&order=bill_month.desc&limit=1`);
            if(payments?.length) electricTotal+=parseFloat(payments[0].actual_amount)||b.expected_amount||0;
            else electricTotal+=b.expected_amount||0;
        }

        // Build clickable cards
        const card=(key,label,value,icon)=>`
            <div class="dash-card" data-chart="${key}" onclick="switchChart('${key}')" 
                 style="background:white;padding:20px;border-radius:12px;text-align:center;border:2px solid var(--sage-200);cursor:pointer;transition:all 0.2s;">
                <div style="font-size:0.7rem;text-transform:uppercase;letter-spacing:1px;color:var(--sage-500);">${icon} ${label}</div>
                <div style="font-size:1.6rem;font-weight:700;font-family:'Crimson Pro',serif;margin-top:6px;color:var(--sage-700);">${fmt(value)}</div>
            </div>`;

        document.getElementById('dash-cards').innerHTML=
            card('ccspend','CC Spent This Week',ccSpent,'üí≥')+
            card('boaspend','BOA Spent This Week',boaSpent,'üí≥')+
            card('ccbal','Total CC Balance',ccTotal,'üí≥')+
            card('tax','Tax Owed',taxTotal,'üèõÔ∏è')+
            card('loans','Loan Balance',loanDisplay,'üè¶')+
            card('electric','Electric Bills',electricTotal,'‚ö°');

        // ===== BUILD ALL TREND DATA =====
        const allEntries=await supaFetch('finance_weekly_entries','GET',null,'?order=entry_date');
        const byDate={};
        allEntries.forEach(e=>{
            if(!byDate[e.entry_date])byDate[e.entry_date]=[];
            byDate[e.entry_date].push(e);
        });
        const dates=Object.keys(byDate).sort();
        const oneYearAgo=new Date();oneYearAgo.setFullYear(oneYearAgo.getFullYear()-1);
        const yearStr=oneYearAgo.toISOString().split('T')[0];
        const recentDates=dates.filter(d=>d>=yearStr);

        // Pre-fetch loan schedules
        const loanSchedules={};
        for(const a of loanAccs){
            const sched=await supaFetch('finance_loan_schedules','GET',null,
                `?account_id=eq.${a.id}&order=due_date`);
            if(sched?.length) loanSchedules[a.id]=sched;
        }

        // Compute all trends
        const tDebt=[],tCCSpend=[],tBOASpend=[],tCCBal=[],tTax=[],tLoans=[];
        for(let i=0;i<recentDates.length;i++){
            const d=recentDates[i];
            const prevD=i>0?recentDates[i-1]:null;
            let debt=0,ccB=0,taxB=0,loanB=0,ccS=0,boaS=0;

            // CC + tax from saved entries
            byDate[d].forEach(e=>{
                const a=accMap[e.account_id];if(!a)return;
                if(a.account_type==='credit_card'){
                    ccB+=parseFloat(e.ending_balance)||0;
                    // Spend calc - only if prior week exists for this account
                    if(prevD){
                        const prevEntry=byDate[prevD]?.find(p=>p.account_id===e.account_id);
                        if(prevEntry){
                            const thisStart=parseFloat(e.starting_balance)||0;
                            const prevEnd=parseFloat(prevEntry.ending_balance)||0;
                            const spent=Math.max(0,thisStart-prevEnd);
                            if(a.name?.toLowerCase().includes('boa')) boaS+=spent;
                            else ccS+=spent;
                        }
                    }
                }
                if(a.account_type==='tax_debt') taxB+=parseFloat(e.ending_balance)||0;
            });

            // Loans from schedule
            for(const a of loanAccs){
                const sched=loanSchedules[a.id];
                if(!sched)continue;
                let bal=0;
                for(let j=sched.length-1;j>=0;j--){
                    if(sched[j].due_date<=d){bal=parseFloat(sched[j].balance_after)||0;break;}
                }
                if(bal===0&&sched.length) bal=parseFloat(sched[0].balance_after)||0;
                loanB+=bal;
            }

            debt=ccB+taxB+loanB;
            tDebt.push({date:d,value:debt});
            tCCSpend.push({date:d,value:ccS});
            tBOASpend.push({date:d,value:boaS});
            tCCBal.push({date:d,value:ccB});
            tTax.push({date:d,value:taxB});
            tLoans.push({date:d,value:loanB});
        }

        // Electric trend from bill payments
        const tElectric=[];
        const elecPayments=[];
        for(const b of elecBills){
            const pays=await supaFetch('finance_bill_payments','GET',null,
                `?bill_id=eq.${b.id}&order=bill_month`);
            if(pays?.length) elecPayments.push(...pays);
        }
        // Group by month
        const elecByMonth={};
        elecPayments.forEach(p=>{
            const m=p.bill_month?.substring(0,7)||'';
            if(!elecByMonth[m]) elecByMonth[m]=0;
            elecByMonth[m]+=parseFloat(p.actual_amount)||0;
        });
        Object.keys(elecByMonth).sort().forEach(m=>{
            if(m>=yearStr.substring(0,7)) tElectric.push({date:m+'-15',value:elecByMonth[m]});
        });

        // Store all chart data
        dashCharts={
            debt:{title:'üìâ Total Debt',data:tDebt},
            ccspend:{title:'üí≥ CC Spending Per Week (excl BOA)',data:tCCSpend},
            boaspend:{title:'üí≥ BOA Spending Per Week',data:tBOASpend},
            ccbal:{title:'üí≥ CC Balance Over Time',data:tCCBal},
            tax:{title:'üèõÔ∏è Tax Balance Over Time',data:tTax},
            loans:{title:'üè¶ Loan Balance Over Time',data:tLoans},
            electric:{title:'‚ö° Electric Bills Over Time',data:tElectric}
        };

        activeChart='debt';
        switchChart('debt');

    }catch(e){console.error('Dashboard:',e);}
}

function switchChart(key){
    const chart=dashCharts[key];
    if(!chart)return;
    activeChart=key;
    document.getElementById('dash-chart-title').textContent=chart.title+' (Last Year)';
    renderLineChart('dash-debt-chart',chart.data);
    // Highlight active card (none highlighted for 'debt' default)
    document.querySelectorAll('.dash-card').forEach(c=>{
        if(c.dataset.chart===key){
            c.style.borderColor='var(--sage-500)';
            c.style.background='var(--sage-50)';
            c.style.boxShadow='0 0 0 1px var(--sage-400)';
        }else{
            c.style.borderColor='var(--sage-200)';
            c.style.background='white';
            c.style.boxShadow='none';
        }
    });
}

function monthsDiff(d1,d2){
    return Math.max(0,Math.round((d2-d1)/(1000*60*60*24*30.44)));
}

function renderLineChart(containerId,data){
    const el=document.getElementById(containerId);
    if(!data.length){el.innerHTML='<p style="color:var(--sage-400);">No data yet</p>';return;}
    const vals=data.map(d=>d.value);
    const max=Math.max(...vals);
    const min=Math.min(...vals);
    const range=max-min||1;
    const w=620,h=220,pad=55;
    const pw=w-pad-15, ph=h-40;
    const isSpend=activeChart==='ccspend'||activeChart==='boaspend';

    // Gridlines
    const gridLines=5;
    let gridSvg='';
    for(let i=0;i<=gridLines;i++){
        const y=(h-30)-((i/gridLines)*ph);
        const val=min+((i/gridLines)*range);
        const fmtV=val>=1000?'$'+(val/1000).toFixed(1)+'k':'$'+Math.round(val);
        gridSvg+=`<line x1="${pad}" y1="${y}" x2="${pad+pw}" y2="${y}" stroke="var(--sage-100)" stroke-width="1"/>`;
        gridSvg+=`<text x="${pad-6}" y="${y+4}" font-size="9" fill="var(--sage-400)" text-anchor="end" font-family="Karla,sans-serif">${fmtV}</text>`;
    }

    // Data line + fill
    let points='';
    let fillPoints=`${pad},${h-30} `;
    data.forEach((d,i)=>{
        const x=pad+(i/(data.length-1||1))*pw;
        const y=(h-30)-((d.value-min)/range)*ph;
        points+=`${x},${y} `;
        fillPoints+=`${x},${y} `;
    });
    fillPoints+=`${pad+pw},${h-30}`;

    // Date labels (~5 evenly spaced)
    const labelCount=Math.min(5,data.length);
    let dateLabelsSvg='';
    for(let i=0;i<labelCount;i++){
        const idx=Math.round(i*(data.length-1)/(labelCount-1||1));
        const d=data[idx];
        const x=pad+(idx/(data.length-1||1))*pw;
        const dt=new Date(d.date+'T12:00:00');
        const label=`${dt.getMonth()+1}/${dt.getDate()}`;
        const anchor=i===0?'start':i===labelCount-1?'end':'middle';
        dateLabelsSvg+=`<text x="${x}" y="${h-8}" font-size="9" fill="var(--sage-400)" text-anchor="${anchor}" font-family="Karla,sans-serif">${label}</text>`;
    }

    let svg=`<svg viewBox="0 0 ${w} ${h}" style="width:100%;height:100%;" preserveAspectRatio="xMidYMid meet">`;
    svg+=gridSvg;
    svg+=`<polygon points="${fillPoints}" fill="var(--sage-100)" opacity="0.5"/>`;
    svg+=`<polyline points="${points}" fill="none" stroke="var(--sage-500)" stroke-width="2.5" stroke-linejoin="round" stroke-linecap="round"/>`;

    // Dots (every nth)
    const dotEvery=Math.max(1,Math.floor(data.length/12));
    data.forEach((d,i)=>{
        if(i%dotEvery===0||i===data.length-1){
            const x=pad+(i/(data.length-1||1))*pw;
            const y=(h-30)-((d.value-min)/range)*ph;
            svg+=`<circle cx="${x}" cy="${y}" r="3" fill="var(--sage-500)" stroke="white" stroke-width="1.5"/>`;
        }
    });

    svg+=dateLabelsSvg;

    // Stats overlay
    if(isSpend){
        const avg=vals.reduce((s,v)=>s+v,0)/vals.length;
        const avgY=(h-30)-((avg-min)/range)*ph;
        svg+=`<line x1="${pad}" y1="${avgY}" x2="${pad+pw}" y2="${avgY}" stroke="var(--sage-600)" stroke-width="1.5" stroke-dasharray="6,4" opacity="0.7"/>`;
        const avgLabel=avg>=1000?'$'+(avg/1000).toFixed(1)+'k':'$'+Math.round(avg);
        svg+=`<rect x="${pad+pw-72}" y="${avgY-19}" width="74" height="17" rx="4" fill="var(--sage-600)" opacity="0.85"/>`;
        svg+=`<text x="${pad+pw-35}" y="${avgY-7}" font-size="10" fill="white" text-anchor="middle" font-weight="600" font-family="Karla,sans-serif">avg ${avgLabel}</text>`;
    } else {
        const startVal=vals[0], endVal=vals[vals.length-1];
        const diff=endVal-startVal;
        const absDiff=Math.abs(diff);
        const diffLabel=(diff<=0?'‚Üì ':'‚Üë ')+(absDiff>=1000?'$'+(absDiff/1000).toFixed(1)+'k':'$'+absDiff.toFixed(0));
        const diffColor=diff<=0?'#4a7c3f':'#c44';
        svg+=`<rect x="${pad+pw-108}" y="6" width="110" height="22" rx="6" fill="${diffColor}" opacity="0.9"/>`;
        svg+=`<text x="${pad+pw-53}" y="21" font-size="11" fill="white" text-anchor="middle" font-weight="700" font-family="Karla,sans-serif">${diffLabel}</text>`;
    }

    svg+=`</svg>`;
    el.innerHTML=svg;
}

// ==================== CSV PARSING HELPERS ====================

function detectCSVFormat(headers){
    const h=headers.map(c=>c.trim().toLowerCase());
    if(h.includes('reference number')&&h.includes('payee')) return 'boa';
    if(h.includes('category')&&h.includes('post date')) return 'chase';
    if(h.includes('transaction description')&&h.includes('balance')) return 'pnc';
    return 'unknown';
}

function parseCSVLine(line){
    const result=[];
    let current='';
    let inQuotes=false;
    for(let i=0;i<line.length;i++){
        const c=line[i];
        if(c==='"'){inQuotes=!inQuotes;}
        else if(c===','&&!inQuotes){result.push(current.trim());current='';}
        else{current+=c;}
    }
    result.push(current.trim());
    return result;
}

function parsePNCAmount(str){
    if(!str)return 0;
    const clean=str.replace(/[$,\s"]/g,'');
    if(clean.startsWith('-')) return parseFloat(clean);
    if(clean.startsWith('+')) return parseFloat(clean);
    return parseFloat(clean)||0;
}

function parseDate(str){
    if(!str)return null;
    const s=str.replace(/"/g,'').trim();
    if(s.toUpperCase().startsWith('PENDING')) return null;
    if(s.match(/^\d{4}-\d{2}-\d{2}$/)) return s;
    const m=s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if(m) return `${m[3]}-${m[1]}-${m[2]}`;
    return null;
}

function guessCategory(desc){
    if(!desc)return 'Uncategorized';
    const upper=desc.toUpperCase();
    for(const rule of categoryRules){
        if(upper.includes(rule.pattern.toUpperCase())) return rule.category;
    }
    return 'Uncategorized';
}

function hashTxn(date,desc,amount,ref){
    const key=ref?`${ref}`:`${date}|${desc}|${amount}`;
    let h=0;
    for(let i=0;i<key.length;i++){h=((h<<5)-h)+key.charCodeAt(i);h|=0;}
    return Math.abs(h).toString(36);
}

// ==================== IMPORT TAB ====================
let categoryRules=[];
let txnData=[];

function initImportTab(){
    const allAcc=[...accounts,...closedAccounts];
    const container=document.getElementById('import-zones');
    const typeIcons={credit_card:'üí≥',loan:'üè¶',bank:'üèß',tax_debt:'üèõÔ∏è',other:'üìÅ'};
    const typeLabels={credit_card:'Credit Card',loan:'Loan',bank:'Bank Account',tax_debt:'Tax Debt',other:'Other'};
    
    container.innerHTML=allAcc.map(a=>`
        <div class="drop-zone" id="dz-${a.id}" 
             ondragover="dzOver(event)" ondragleave="dzLeave(event)" ondrop="dzDrop(event,'${a.id}')">
            <div class="drop-zone-icon">${typeIcons[a.account_type]||'üìÅ'}</div>
            <div class="drop-zone-name">${a.name}</div>
            <div class="drop-zone-type">${typeLabels[a.account_type]||a.account_type}</div>
            <div class="drop-zone-hint">Drop CSV here or click to browse</div>
            <div class="drop-zone-status" id="dz-status-${a.id}"></div>
            <input type="file" accept=".csv" onchange="dzFileSelect(event,'${a.id}')">
        </div>
    `).join('');
}

function dzOver(e){e.preventDefault();e.currentTarget.classList.add('drag-over');}
function dzLeave(e){e.currentTarget.classList.remove('drag-over');}
function dzDrop(e,accountId){
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    const file=e.dataTransfer.files[0];
    if(file) importCSVForAccount(file,accountId);
}
function dzFileSelect(e,accountId){
    const file=e.target.files[0];
    if(file) importCSVForAccount(file,accountId);
    e.target.value='';
}

async function importCSVForAccount(file,accountId){
    const zone=document.getElementById(`dz-${accountId}`);
    const status=document.getElementById(`dz-status-${accountId}`);
    zone.classList.remove('success','error');
    status.style.color='var(--sage-600)';
    status.textContent='Reading...';
    
    if(!categoryRules.length){
        try{categoryRules=await supaFetch('finance_category_rules','GET',null,'?order=pattern');}catch(e){categoryRules=[];}
    }
    
    const text=await file.text();
    const lines=text.split('\n').filter(l=>l.trim());
    if(lines.length<2){status.textContent='File appears empty.';zone.classList.add('error');return;}
    
    const headers=parseCSVLine(lines[0]);
    const format=detectCSVFormat(headers);
    
    if(format==='unknown'){
        status.textContent="Can't detect format";
        status.style.color='#c44';
        zone.classList.add('error');
        return;
    }
    
    status.textContent=`${format.toUpperCase()} ¬∑ Parsing ${lines.length-1} rows...`;
    
    const txns=[];
    for(let i=1;i<lines.length;i++){
        const cols=parseCSVLine(lines[i]);
        if(cols.length<3)continue;
        let txn={account_id:accountId};
        
        if(format==='chase'){
            txn.transaction_date=parseDate(cols[0]);
            txn.post_date=parseDate(cols[1]);
            txn.description=cols[2]||'';
            txn.category=cols[3]||'Uncategorized';
            txn.amount=parseFloat(cols[5])||0;
            txn.memo=cols[6]||null;
            txn.dedup_hash=hashTxn(txn.transaction_date,txn.description,txn.amount);
        } else if(format==='boa'){
            txn.transaction_date=parseDate(cols[0]);
            txn.post_date=parseDate(cols[0]);
            txn.description=(cols[2]||'').trim();
            txn.address=(cols[3]||'').trim();
            txn.amount=parseFloat(cols[4])||0;
            txn.reference_number=cols[1]||'';
            txn.category=guessCategory(txn.description);
            txn.dedup_hash=hashTxn(null,null,null,txn.reference_number);
        } else if(format==='pnc'){
            txn.transaction_date=parseDate(cols[0]);
            if(!txn.transaction_date)continue;
            txn.description=(cols[1]||'').trim();
            txn.amount=parsePNCAmount(cols[2]);
            txn.raw_balance=cols[3]||'';
            txn.category=guessCategory(txn.description);
            txn.dedup_hash=hashTxn(txn.transaction_date,txn.description,txn.amount);
        }
        
        if(!txn.transaction_date)continue;
        if(!txn.category) txn.category=guessCategory(txn.description);
        txns.push(txn);
    }
    
    status.textContent=`Importing ${txns.length} transactions...`;
    
    let imported=0,skipped=0;
    const batchSize=50;
    for(let i=0;i<txns.length;i+=batchSize){
        const batch=txns.slice(i,i+batchSize);
        try{
            const clean=batch.map(t=>{
                const c={...t};
                Object.keys(c).forEach(k=>{if(c[k]===null||c[k]===undefined||c[k]==='')delete c[k];});
                if(!c.category)c.category='Uncategorized';
                return c;
            });
            const res=await fetch(`${SUPA_URL}/rest/v1/finance_transactions`,{
                method:'POST',
                headers:{'apikey':SUPA_KEY,'Authorization':`Bearer ${SUPA_KEY}`,
                    'Content-Type':'application/json','Prefer':'resolution=ignore-duplicates,return=representation'},
                body:JSON.stringify(clean)
            });
            const data=await res.json();
            const batchImported=Array.isArray(data)?data.length:0;
            imported+=batchImported;
            skipped+=(batch.length-batchImported);
        }catch(e){skipped+=batch.length;}
    }
    
    zone.classList.add('success');
    status.style.color='#2e7d32';
    status.innerHTML=`‚úÖ <strong>${imported}</strong> new ¬∑ <strong>${skipped}</strong> skipped`;
    setTimeout(()=>{zone.classList.remove('success');status.textContent='';},8000);
}

// ==================== TRANSACTIONS TAB ====================

async function initTransactions(){
    const allAcc=[...accounts,...closedAccounts];
    const filterSel=document.getElementById('txn-filter-account');
    filterSel.innerHTML='<option value="">All Accounts</option>'+allAcc.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
    
    if(!categoryRules.length){
        try{categoryRules=await supaFetch('finance_category_rules','GET',null,'?order=pattern');}catch(e){categoryRules=[];}
    }
    
    await loadTransactions();
    await loadCategoryFilter();
    await loadVendorFilter();
}

async function loadCategoryFilter(){
    try{
        const cats=await supaFetch('finance_transactions','GET',null,'?select=category&order=category');
        const unique=[...new Set(cats.map(c=>c.category).filter(Boolean))].sort();
        const sel=document.getElementById('txn-filter-category');
        sel.innerHTML='<option value="">All Categories</option>'+unique.map(c=>`<option value="${c}">${c}</option>`).join('');
    }catch(e){}
}

async function loadVendorFilter(){
    try{
        const txns=await supaFetch('finance_transactions','GET',null,'?select=description&order=description');
        const vendors={};
        txns.forEach(t=>{
            if(!t.description)return;
            let v=t.description.split(/\s{2,}|\d{4,}/)[0].trim();
            v=v.replace(/[#*]+.*$/,'').trim();
            if(v.length>=3) vendors[v]=(vendors[v]||0)+1;
        });
        const sorted=Object.entries(vendors).sort((a,b)=>b[1]-a[1]).slice(0,50);
        const sel=document.getElementById('txn-filter-vendor');
        sel.innerHTML='<option value="">All Vendors</option>'+sorted.map(([v,c])=>`<option value="${v}">${v} (${c})</option>`).join('');
    }catch(e){}
}

async function loadTransactions(){
    const acct=document.getElementById('txn-filter-account')?.value||'';
    const cat=document.getElementById('txn-filter-category')?.value||'';
    const vendor=document.getElementById('txn-filter-vendor')?.value||'';
    const search=document.getElementById('txn-search')?.value?.trim()||'';
    const fromDate=document.getElementById('txn-filter-from')?.value||'';
    const toDate=document.getElementById('txn-filter-to')?.value||'';
    
    let query='?order=transaction_date.desc,id.desc&limit=300';
    if(acct) query+=`&account_id=eq.${acct}`;
    if(cat) query+=`&category=eq.${encodeURIComponent(cat)}`;
    if(fromDate) query+=`&transaction_date=gte.${fromDate}`;
    if(toDate) query+=`&transaction_date=lte.${toDate}`;
    if(search) query+=`&description=ilike.*${encodeURIComponent(search)}*`;
    if(vendor) query+=`&description=ilike.*${encodeURIComponent(vendor)}*`;
    
    try{
        txnData=await supaFetch('finance_transactions','GET',null,query);
    }catch(e){txnData=[];console.error('Load txns:',e);}
    
    renderTransactions();
}

function renderTransactions(){
    const wrap=document.getElementById('txn-table-wrap');
    const allAcc=[...accounts,...closedAccounts];
    const accMap={};allAcc.forEach(a=>accMap[a.id]=a);
    
    if(!txnData.length){
        wrap.innerHTML='<p style="color:var(--sage-400);padding:16px;">No transactions found. Go to the Import tab to upload CSVs!</p>';
        document.getElementById('txn-summary').textContent='';
        return;
    }
    
    let totalSpend=0,totalIncome=0;
    txnData.forEach(t=>{
        if(t.amount<0)totalSpend+=t.amount;
        else totalIncome+=t.amount;
    });
    document.getElementById('txn-summary').innerHTML=
        `${txnData.length} txns &nbsp;|&nbsp; <span style="color:#c44">${fmt(Math.abs(totalSpend))} out</span> &nbsp;|&nbsp; <span style="color:#4a7c3f">${fmt(totalIncome)} in</span>`;
    
    let html=`<table class="data-table" style="width:100%;">
        <thead><tr>
            <th>Date</th><th>Account</th><th>Description</th>
            <th>Category</th><th style="text-align:right">Amount</th>
        </tr></thead><tbody>`;
    
    txnData.forEach(t=>{
        const acctName=accMap[t.account_id]?.name||'?';
        const shortAcct=acctName.length>12?acctName.substring(0,12)+'‚Ä¶':acctName;
        const isNeg=t.amount<0;
        const catStyle=t.category==='Uncategorized'?'background:#ffeeba;color:#856404;':'';
        html+=`<tr>
            <td style="white-space:nowrap;font-size:0.8rem;">${t.transaction_date}</td>
            <td style="font-size:0.75rem;color:var(--sage-500);" title="${acctName}">${shortAcct}</td>
            <td style="font-size:0.8rem;max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${(t.description||'').replace(/"/g,'&quot;')}">${t.description||''}</td>
            <td><span class="badge" style="cursor:pointer;${catStyle}" onclick="editCategory(${t.id},'${(t.description||'').replace(/'/g,"\\'")}','${t.category}')" title="Click to change">${t.category||'‚Äî'}</span></td>
            <td style="text-align:right;font-weight:600;color:${isNeg?'var(--sage-700)':'#4a7c3f'};white-space:nowrap;">${isNeg?'-':''}${fmt(Math.abs(t.amount))}</td>
        </tr>`;
    });
    
    html+=`</tbody></table>`;
    wrap.innerHTML=html;
}

async function editCategory(txnId,description,currentCat){
    const cats=['Groceries','Food & Drink','Gas','Home','Shopping','Health','Automotive',
        'Subscriptions','Electric','Insurance','Tax Payment','Loan Payment','CC Payment',
        'Investment','Income','Childcare','Pets','Solar','Entertainment','Travel','Uncategorized'];
    
    const newCat=prompt(`Category for "${description}":\n\nCurrent: ${currentCat}\n\nOptions: ${cats.join(', ')}\n\nType a category:`,(currentCat||''));
    if(!newCat||newCat===currentCat)return;
    
    try{
        await supaFetch('finance_transactions','PATCH',{category:newCat},`?id=eq.${txnId}`);
        
        const vendor=description.split(/\s{2,}|\d/)[0].trim().toUpperCase();
        if(vendor.length>=3){
            try{
                await fetch(`${SUPA_URL}/rest/v1/finance_category_rules`,{
                    method:'POST',
                    headers:{'apikey':SUPA_KEY,'Authorization':`Bearer ${SUPA_KEY}`,
                        'Content-Type':'application/json','Prefer':'resolution=ignore-duplicates'},
                    body:JSON.stringify({pattern:vendor,category:newCat})
                });
                categoryRules=await supaFetch('finance_category_rules','GET',null,'?order=pattern');
            }catch(e){}
        }
        
        await loadTransactions();
    }catch(e){alert('Error: '+e.message);}
}

async function init(){
    await loadAccounts(); await loadBills(); await loadBillPayments();
    loadDashboard();
}
init();
</script>
</body>
</html>
