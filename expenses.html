<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker - Homestead Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@300;400;600&family=Karla:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --sage-50: #f6f7f3;
            --sage-100: #e8ebe0;
            --sage-200: #d4dac5;
            --sage-300: #b8c5a3;
            --sage-400: #98ab7e;
            --sage-500: #7a9061;
            --sage-600: #5f734c;
            --sage-700: #4a5a3b;
            --sage-800: #3d4a32;
            --cream: #ece8dd;
            --taupe: #c4b5a4;
            --dusty-sage: #a4ac95;
            --mauve: #a88479;
            --charcoal: #4a4d47;
            --dusty-rose: #9b7269;
        }

        body {
            font-family: 'Karla', sans-serif;
            background: var(--charcoal);
            min-height: 100vh;
            color: var(--cream);
        }

        /* Top Nav */
        .top-nav {
            background: rgba(61, 74, 50, 0.95);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid var(--sage-500);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .top-nav a {
            color: var(--cream);
            text-decoration: none;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .top-nav a:hover { color: var(--sage-300); }
        .nav-title {
            font-family: 'Crimson Pro', serif;
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--cream);
        }

        .main-content {
            padding: 24px 16px;
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            font-family: 'Crimson Pro', serif;
            font-size: 2.2rem;
            font-weight: 300;
            text-align: center;
            margin-bottom: 24px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 4px;
        }
        .tab-btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: transparent;
            color: var(--taupe);
            font-family: 'Karla', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: var(--sage-600);
            color: white;
        }
        .tab-btn:hover:not(.active) {
            background: rgba(255,255,255,0.05);
        }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* Cards */
        .card {
            background: rgba(236, 232, 221, 0.95);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            color: var(--charcoal);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border: 1px solid rgba(196, 181, 164, 0.3);
        }
        .card h2 {
            font-family: 'Crimson Pro', serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--sage-700);
            margin-bottom: 16px;
        }

        /* Form */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        .form-group { display: flex; flex-direction: column; gap: 4px; }
        .form-group.full { grid-column: 1 / -1; }

        label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--sage-700);
        }
        input, select, textarea {
            padding: 10px 12px;
            border: 1px solid var(--sage-200);
            border-radius: 8px;
            font-family: 'Karla', sans-serif;
            font-size: 0.95rem;
            background: white;
            color: var(--charcoal);
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--sage-500);
            box-shadow: 0 0 0 2px rgba(122, 144, 97, 0.2);
        }
        textarea { resize: vertical; min-height: 60px; }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-family: 'Karla', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: var(--sage-600);
            color: white;
        }
        .btn-primary:hover { background: var(--sage-700); }
        .btn-danger {
            background: var(--dusty-rose);
            color: white;
            padding: 6px 12px;
            font-size: 0.8rem;
        }
        .btn-danger:hover { background: #8a6158; }
        .btn-secondary {
            background: var(--taupe);
            color: white;
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        .btn-secondary:hover { background: #b0a191; }

        .btn-row {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        /* Summary boxes */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .summary-box {
            background: rgba(0,0,0,0.15);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        .summary-box .label {
            font-size: 0.8rem;
            color: var(--taupe);
            margin-bottom: 4px;
        }
        .summary-box .value {
            font-family: 'Crimson Pro', serif;
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--cream);
        }

        /* Filter bar */
        .filter-bar {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 16px;
            align-items: flex-end;
        }
        .filter-bar .form-group { min-width: 140px; }
        .filter-bar label { color: var(--sage-200); font-size: 0.8rem; }
        .filter-bar input, .filter-bar select {
            padding: 8px 10px;
            font-size: 0.85rem;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.15);
            color: var(--cream);
            border-radius: 8px;
        }
        .filter-bar select option { color: var(--charcoal); background: white; }

        /* Table */
        .table-wrap {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            text-align: left;
            padding: 10px 12px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--sage-700);
            border-bottom: 2px solid var(--sage-200);
            white-space: nowrap;
        }
        td {
            padding: 10px 12px;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--sage-100);
            color: var(--charcoal);
        }
        tr:hover td { background: var(--sage-50); }
        .amount-col { text-align: right; font-weight: 600; }
        .actions-col { white-space: nowrap; }
        .total-row td {
            font-weight: 700;
            border-top: 2px solid var(--sage-500);
            color: var(--sage-700);
            font-size: 1rem;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--taupe);
            font-style: italic;
        }

        /* Category badges */
        .cat-badge {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
        }

        /* Edit modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 200;
            justify-content: center;
            align-items: center;
            padding: 16px;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--cream);
            border-radius: 16px;
            padding: 28px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            color: var(--charcoal);
        }
        .modal h2 {
            font-family: 'Crimson Pro', serif;
            color: var(--sage-700);
            margin-bottom: 16px;
        }

        /* CSV button */
        .export-btn {
            background: var(--sage-500);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Karla', sans-serif;
            font-weight: 600;
            font-size: 0.85rem;
        }
        .export-btn:hover { background: var(--sage-600); }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--sage-700);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 300;
            transform: translateY(80px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.error { background: var(--dusty-rose); }

        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; }
            .form-row { grid-template-columns: 1fr; }
            .card { padding: 16px; }
            .summary-grid { grid-template-columns: 1fr 1fr; }
            .filter-bar { flex-direction: column; }
            .filter-bar .form-group { min-width: 100%; }
            th, td { padding: 8px 6px; font-size: 0.8rem; }
            .btn-danger { padding: 4px 8px; font-size: 0.75rem; }
        }
    </style>
</head>
<body>

<nav class="top-nav">
    <a href="index.html">‚Üê Back to Hub</a>
    <span class="nav-title">üí∞ Expenses</span>
</nav>

<div class="main-content">
    <h1>üí∞ Expense Tracker</h1>

    <!-- Summary -->
    <div class="summary-grid" id="summaryGrid">
        <div class="summary-box">
            <div class="label">This Month</div>
            <div class="value" id="monthTotal">$0.00</div>
        </div>
        <div class="summary-box">
            <div class="label">This Year</div>
            <div class="value" id="yearTotal">$0.00</div>
        </div>
        <div class="summary-box">
            <div class="label"># Expenses</div>
            <div class="value" id="expenseCount">0</div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab-btn active" data-tab="add">Add New</button>
        <button class="tab-btn" data-tab="list">View All</button>
        <button class="tab-btn" data-tab="summary">By Category</button>
    </div>

    <!-- ADD TAB -->
    <div class="tab-panel active" id="tab-add">
        <div class="card">
            <h2>Add Expense</h2>
            <form id="expenseForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="expDate" required>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="expCategory" required>
                            <option value="">Select...</option>
                            <option value="Utilities">üîå Utilities</option>
                            <option value="Solar Project">‚òÄÔ∏è Solar Project</option>
                            <option value="Poultry">üêî Poultry</option>
                            <option value="Plantings">üå± Plantings</option>
                            <option value="Home Repairs">üîß Home Repairs</option>
                            <option value="Equipment & Tools">üõ†Ô∏è Equipment & Tools</option>
                            <option value="Feed & Supplies">üåæ Feed & Supplies</option>
                            <option value="Seeds & Soil">ü™¥ Seeds & Soil</option>
                            <option value="Groceries">üõí Groceries</option>
                            <option value="Auto & Gas">‚õΩ Auto & Gas</option>
                            <option value="Insurance">üõ°Ô∏è Insurance</option>
                            <option value="Property Tax">üè† Property Tax</option>
                            <option value="Mortgage">üè¶ Mortgage</option>
                            <option value="Other">üì¶ Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Amount ($)</label>
                        <input type="number" id="expAmount" step="0.01" min="0" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="expDescription" placeholder="What was this for?">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group full">
                        <label>Notes (optional)</label>
                        <textarea id="expNotes" placeholder="Any extra details..."></textarea>
                    </div>
                </div>
                <div class="btn-row">
                    <button type="submit" class="btn btn-primary">üíæ Save Expense</button>
                </div>
            </form>
        </div>
    </div>

    <!-- LIST TAB -->
    <div class="tab-panel" id="tab-list">
        <!-- Filters -->
        <div class="filter-bar">
            <div class="form-group">
                <label>From</label>
                <input type="date" id="filterFrom">
            </div>
            <div class="form-group">
                <label>To</label>
                <input type="date" id="filterTo">
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="filterCategory">
                    <option value="">All Categories</option>
                    <option value="Utilities">Utilities</option>
                    <option value="Solar Project">Solar Project</option>
                    <option value="Poultry">Poultry</option>
                    <option value="Plantings">Plantings</option>
                    <option value="Home Repairs">Home Repairs</option>
                    <option value="Equipment & Tools">Equipment & Tools</option>
                    <option value="Feed & Supplies">Feed & Supplies</option>
                    <option value="Seeds & Soil">Seeds & Soil</option>
                    <option value="Groceries">Groceries</option>
                    <option value="Auto & Gas">Auto & Gas</option>
                    <option value="Insurance">Insurance</option>
                    <option value="Property Tax">Property Tax</option>
                    <option value="Mortgage">Mortgage</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <button class="export-btn" onclick="exportCSV()">üì• Export CSV</button>
            </div>
        </div>

        <div class="card">
            <div class="header-row">
                <h2>All Expenses</h2>
                <span id="filteredTotal" style="font-weight:600; color:var(--sage-700);"></span>
            </div>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Category</th>
                            <th>Description</th>
                            <th class="amount-col">Amount</th>
                            <th class="actions-col"></th>
                        </tr>
                    </thead>
                    <tbody id="expenseTable"></tbody>
                </table>
            </div>
            <div class="empty-state" id="emptyState" style="display:none;">
                No expenses found. Start adding some! üåø
            </div>
        </div>
    </div>

    <!-- SUMMARY TAB -->
    <div class="tab-panel" id="tab-summary">
        <div class="filter-bar">
            <div class="form-group">
                <label>Year</label>
                <select id="summaryYear"></select>
            </div>
            <div class="form-group">
                <label>Month</label>
                <select id="summaryMonth">
                    <option value="">All Year</option>
                    <option value="0">January</option>
                    <option value="1">February</option>
                    <option value="2">March</option>
                    <option value="3">April</option>
                    <option value="4">May</option>
                    <option value="5">June</option>
                    <option value="6">July</option>
                    <option value="7">August</option>
                    <option value="8">September</option>
                    <option value="9">October</option>
                    <option value="10">November</option>
                    <option value="11">December</option>
                </select>
            </div>
        </div>

        <div class="card">
            <h2>Spending by Category</h2>
            <div id="categoryBreakdown"></div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" id="editModal">
    <div class="modal">
        <h2>Edit Expense</h2>
        <form id="editForm">
            <input type="hidden" id="editId">
            <div class="form-row">
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="editDate" required>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="editCategory" required>
                        <option value="Utilities">üîå Utilities</option>
                        <option value="Solar Project">‚òÄÔ∏è Solar Project</option>
                        <option value="Poultry">üêî Poultry</option>
                        <option value="Plantings">üå± Plantings</option>
                        <option value="Home Repairs">üîß Home Repairs</option>
                        <option value="Equipment & Tools">üõ†Ô∏è Equipment & Tools</option>
                        <option value="Feed & Supplies">üåæ Feed & Supplies</option>
                        <option value="Seeds & Soil">ü™¥ Seeds & Soil</option>
                        <option value="Groceries">üõí Groceries</option>
                        <option value="Auto & Gas">‚õΩ Auto & Gas</option>
                        <option value="Insurance">üõ°Ô∏è Insurance</option>
                        <option value="Property Tax">üè† Property Tax</option>
                        <option value="Mortgage">üè¶ Mortgage</option>
                        <option value="Other">üì¶ Other</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Amount ($)</label>
                    <input type="number" id="editAmount" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="editDescription">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group full">
                    <label>Notes</label>
                    <textarea id="editNotes"></textarea>
                </div>
            </div>
            <div class="btn-row">
                <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
    // ===================== SUPABASE CONFIG =====================
    const SUPABASE_URL = 'https://jzpipxvxrtdhmsdkveog.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp6cGlweHZ4cnRkaG1zZGt2ZW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDExMzQ0NDIsImV4cCI6MjA1NjcxMDQ0Mn0.r66fLJcqlUPc7m1wmrIksQ_rIwoTNyb-pHjBYwkGVx8';

    const headers = {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
    };

    let allExpenses = [];

    // Category colors
    const catColors = {
        'Utilities': { bg: '#e8ebe0', text: '#4a5a3b', icon: 'üîå' },
        'Solar Project': { bg: '#fff3cd', text: '#856404', icon: '‚òÄÔ∏è' },
        'Poultry': { bg: '#fce4d6', text: '#8b4513', icon: 'üêî' },
        'Plantings': { bg: '#d4edda', text: '#155724', icon: 'üå±' },
        'Home Repairs': { bg: '#d6e9f8', text: '#004085', icon: 'üîß' },
        'Equipment & Tools': { bg: '#e2d9f3', text: '#4a3070', icon: 'üõ†Ô∏è' },
        'Feed & Supplies': { bg: '#f5e6c8', text: '#6b5200', icon: 'üåæ' },
        'Seeds & Soil': { bg: '#d9f0d3', text: '#2d6a1e', icon: 'ü™¥' },
        'Groceries': { bg: '#dfe6e9', text: '#2d3436', icon: 'üõí' },
        'Auto & Gas': { bg: '#fde8e8', text: '#922b21', icon: '‚õΩ' },
        'Insurance': { bg: '#d4dac5', text: '#3d4a32', icon: 'üõ°Ô∏è' },
        'Property Tax': { bg: '#e8ddd0', text: '#5a4a3a', icon: 'üè†' },
        'Mortgage': { bg: '#d0dde8', text: '#3a4a5a', icon: 'üè¶' },
        'Other': { bg: '#ece8dd', text: '#4a4d47', icon: 'üì¶' }
    };

    // ===================== INIT =====================
    document.addEventListener('DOMContentLoaded', () => {
        // Set today as default date
        document.getElementById('expDate').value = new Date().toISOString().split('T')[0];

        // Default filter: current month
        const now = new Date();
        const y = now.getFullYear(), m = now.getMonth();
        document.getElementById('filterFrom').value = `${y}-${String(m+1).padStart(2,'0')}-01`;
        const lastDay = new Date(y, m+1, 0).getDate();
        document.getElementById('filterTo').value = `${y}-${String(m+1).padStart(2,'0')}-${lastDay}`;

        // Summary year dropdown
        const yearSel = document.getElementById('summaryYear');
        for (let yr = now.getFullYear(); yr >= now.getFullYear() - 3; yr--) {
            yearSel.innerHTML += `<option value="${yr}">${yr}</option>`;
        }

        loadExpenses();
        setupListeners();
    });

    function setupListeners() {
        // Tabs
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');

                if (btn.dataset.tab === 'list') renderTable();
                if (btn.dataset.tab === 'summary') renderCategorySummary();
            });
        });

        // Add form
        document.getElementById('expenseForm').addEventListener('submit', addExpense);

        // Edit form
        document.getElementById('editForm').addEventListener('submit', saveEdit);

        // Filters
        ['filterFrom','filterTo','filterCategory'].forEach(id => {
            document.getElementById(id).addEventListener('change', renderTable);
        });

        // Summary filters
        ['summaryYear','summaryMonth'].forEach(id => {
            document.getElementById(id).addEventListener('change', renderCategorySummary);
        });

        // Close modal on overlay click
        document.getElementById('editModal').addEventListener('click', e => {
            if (e.target === e.currentTarget) closeModal();
        });
    }

    // ===================== LOAD =====================
    async function loadExpenses() {
        try {
            const res = await fetch(
                `${SUPABASE_URL}/rest/v1/home_expenses?order=expense_date.desc,created_at.desc`,
                { headers }
            );
            if (!res.ok) throw new Error('Failed to load');
            allExpenses = await res.json();
            updateSummary();
            renderTable();
        } catch (err) {
            showToast('Error loading expenses', true);
            console.error(err);
        }
    }

    // ===================== ADD =====================
    async function addExpense(e) {
        e.preventDefault();
        const data = {
            expense_date: document.getElementById('expDate').value,
            category: document.getElementById('expCategory').value,
            amount: parseFloat(document.getElementById('expAmount').value),
            description: document.getElementById('expDescription').value || null,
            notes: document.getElementById('expNotes').value || null
        };

        try {
            const res = await fetch(`${SUPABASE_URL}/rest/v1/home_expenses`, {
                method: 'POST',
                headers,
                body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error('Failed to save');
            const [newExp] = await res.json();
            allExpenses.unshift(newExp);
            updateSummary();

            // Reset form but keep date
            document.getElementById('expCategory').value = '';
            document.getElementById('expAmount').value = '';
            document.getElementById('expDescription').value = '';
            document.getElementById('expNotes').value = '';

            showToast('Expense saved! ‚úÖ');
        } catch (err) {
            showToast('Error saving expense', true);
            console.error(err);
        }
    }

    // ===================== DELETE =====================
    async function deleteExpense(id) {
        if (!confirm('Delete this expense?')) return;
        try {
            const res = await fetch(
                `${SUPABASE_URL}/rest/v1/home_expenses?id=eq.${id}`,
                { method: 'DELETE', headers }
            );
            if (!res.ok) throw new Error('Failed to delete');
            allExpenses = allExpenses.filter(e => e.id !== id);
            updateSummary();
            renderTable();
            showToast('Deleted ‚úÖ');
        } catch (err) {
            showToast('Error deleting', true);
        }
    }

    // ===================== EDIT =====================
    function openEdit(id) {
        const exp = allExpenses.find(e => e.id === id);
        if (!exp) return;
        document.getElementById('editId').value = id;
        document.getElementById('editDate').value = exp.expense_date;
        document.getElementById('editCategory').value = exp.category;
        document.getElementById('editAmount').value = exp.amount;
        document.getElementById('editDescription').value = exp.description || '';
        document.getElementById('editNotes').value = exp.notes || '';
        document.getElementById('editModal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('editModal').classList.remove('active');
    }

    async function saveEdit(e) {
        e.preventDefault();
        const id = document.getElementById('editId').value;
        const data = {
            expense_date: document.getElementById('editDate').value,
            category: document.getElementById('editCategory').value,
            amount: parseFloat(document.getElementById('editAmount').value),
            description: document.getElementById('editDescription').value || null,
            notes: document.getElementById('editNotes').value || null
        };

        try {
            const res = await fetch(
                `${SUPABASE_URL}/rest/v1/home_expenses?id=eq.${id}`,
                { method: 'PATCH', headers, body: JSON.stringify(data) }
            );
            if (!res.ok) throw new Error('Failed to update');
            const [updated] = await res.json();
            const idx = allExpenses.findIndex(e => e.id === id);
            if (idx >= 0) allExpenses[idx] = updated;
            updateSummary();
            renderTable();
            closeModal();
            showToast('Updated ‚úÖ');
        } catch (err) {
            showToast('Error updating', true);
        }
    }

    // ===================== RENDER =====================
    function updateSummary() {
        const now = new Date();
        const thisMonth = allExpenses.filter(e => {
            const d = new Date(e.expense_date + 'T00:00:00');
            return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
        });
        const thisYear = allExpenses.filter(e => {
            const d = new Date(e.expense_date + 'T00:00:00');
            return d.getFullYear() === now.getFullYear();
        });

        document.getElementById('monthTotal').textContent = fmt(sum(thisMonth));
        document.getElementById('yearTotal').textContent = fmt(sum(thisYear));
        document.getElementById('expenseCount').textContent = allExpenses.length;
    }

    function renderTable() {
        const from = document.getElementById('filterFrom').value;
        const to = document.getElementById('filterTo').value;
        const cat = document.getElementById('filterCategory').value;

        let filtered = allExpenses.filter(e => {
            if (from && e.expense_date < from) return false;
            if (to && e.expense_date > to) return false;
            if (cat && e.category !== cat) return false;
            return true;
        });

        const tbody = document.getElementById('expenseTable');
        const emptyEl = document.getElementById('emptyState');

        if (filtered.length === 0) {
            tbody.innerHTML = '';
            emptyEl.style.display = 'block';
            document.getElementById('filteredTotal').textContent = '';
            return;
        }

        emptyEl.style.display = 'none';
        const total = sum(filtered);
        document.getElementById('filteredTotal').textContent = `Total: ${fmt(total)}`;

        tbody.innerHTML = filtered.map(e => {
            const c = catColors[e.category] || catColors['Other'];
            return `<tr>
                <td>${formatDate(e.expense_date)}</td>
                <td><span class="cat-badge" style="background:${c.bg};color:${c.text}">${c.icon} ${e.category}</span></td>
                <td>${e.description || '‚Äî'}</td>
                <td class="amount-col">${fmt(e.amount)}</td>
                <td class="actions-col">
                    <button class="btn btn-secondary" onclick="openEdit('${e.id}')">‚úèÔ∏è</button>
                    <button class="btn btn-danger" onclick="deleteExpense('${e.id}')">üóëÔ∏è</button>
                </td>
            </tr>`;
        }).join('') + `<tr class="total-row"><td colspan="3" style="text-align:right">Total</td><td class="amount-col">${fmt(total)}</td><td></td></tr>`;
    }

    function renderCategorySummary() {
        const year = parseInt(document.getElementById('summaryYear').value);
        const monthVal = document.getElementById('summaryMonth').value;

        let filtered = allExpenses.filter(e => {
            const d = new Date(e.expense_date + 'T00:00:00');
            if (d.getFullYear() !== year) return false;
            if (monthVal !== '' && d.getMonth() !== parseInt(monthVal)) return false;
            return true;
        });

        const byCategory = {};
        filtered.forEach(e => {
            if (!byCategory[e.category]) byCategory[e.category] = 0;
            byCategory[e.category] += parseFloat(e.amount);
        });

        const sorted = Object.entries(byCategory).sort((a, b) => b[1] - a[1]);
        const grandTotal = sorted.reduce((s, [, v]) => s + v, 0);

        const container = document.getElementById('categoryBreakdown');
        if (sorted.length === 0) {
            container.innerHTML = '<div class="empty-state">No expenses for this period üåø</div>';
            return;
        }

        container.innerHTML = sorted.map(([cat, total]) => {
            const c = catColors[cat] || catColors['Other'];
            const pct = grandTotal > 0 ? ((total / grandTotal) * 100).toFixed(1) : 0;
            return `<div style="display:flex; align-items:center; gap:12px; padding:12px 0; border-bottom:1px solid var(--sage-100);">
                <span style="font-size:1.5rem; min-width:36px; text-align:center;">${c.icon}</span>
                <div style="flex:1;">
                    <div style="font-weight:600; color:var(--sage-700); margin-bottom:4px;">${cat}</div>
                    <div style="background:var(--sage-100); border-radius:4px; height:8px; overflow:hidden;">
                        <div style="background:var(--sage-500); height:100%; width:${pct}%; border-radius:4px;"></div>
                    </div>
                </div>
                <div style="text-align:right; min-width:80px;">
                    <div style="font-weight:700; color:var(--sage-700);">${fmt(total)}</div>
                    <div style="font-size:0.75rem; color:var(--taupe);">${pct}%</div>
                </div>
            </div>`;
        }).join('') + `<div style="display:flex; justify-content:space-between; padding:16px 0; font-weight:700; font-size:1.1rem; color:var(--sage-700); border-top:2px solid var(--sage-500); margin-top:4px;">
            <span>Total</span><span>${fmt(grandTotal)}</span>
        </div>`;
    }

    // ===================== CSV EXPORT =====================
    function exportCSV() {
        const from = document.getElementById('filterFrom').value;
        const to = document.getElementById('filterTo').value;
        const cat = document.getElementById('filterCategory').value;

        let filtered = allExpenses.filter(e => {
            if (from && e.expense_date < from) return false;
            if (to && e.expense_date > to) return false;
            if (cat && e.category !== cat) return false;
            return true;
        });

        if (filtered.length === 0) {
            showToast('No expenses to export', true);
            return;
        }

        const rows = [['Date', 'Category', 'Description', 'Amount', 'Notes']];
        filtered.forEach(e => {
            rows.push([e.expense_date, e.category, e.description || '', e.amount, e.notes || '']);
        });

        const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `home_expenses_${from || 'all'}_to_${to || 'all'}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('CSV downloaded! üì•');
    }

    // ===================== HELPERS =====================
    function fmt(n) { return '$' + parseFloat(n).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
    function sum(arr) { return arr.reduce((s, e) => s + parseFloat(e.amount), 0); }
    function formatDate(d) {
        const [y, m, day] = d.split('-');
        return `${parseInt(m)}/${parseInt(day)}/${y}`;
    }
    function showToast(msg, isError = false) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.className = 'toast show' + (isError ? ' error' : '');
        setTimeout(() => t.className = 'toast', 2500);
    }
</script>
</body>
</html>
