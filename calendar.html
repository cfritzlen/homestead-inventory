<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homestead Calendar - Homestead Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@300;400;600&family=Karla:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --sage-50: #f6f7f3;
            --sage-100: #e8ebe0;
            --sage-200: #d4dac5;
            --sage-300: #b8c5a3;
            --sage-400: #98ab7e;
            --sage-500: #7a9061;
            --sage-600: #5f734c;
            --sage-700: #4a5a3b;
            --sage-800: #3d4a32;
            --earth-warm: #d4a373;
            --earth-cream: #faf8f3;
            --charcoal: #4a4d47;
            --warning-red: #c74440;
        }

        body {
            font-family: 'Karla', sans-serif;
            background: linear-gradient(135deg, var(--sage-50) 0%, var(--earth-cream) 100%);
            min-height: 100vh;
            padding: 0; margin: 0;
            color: var(--sage-800);
        }

        .pond-banner { width: 100%; height: 200px; object-fit: cover; object-position: center 40%; display: block; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

        nav { background: rgba(255,255,255,0.95); padding: 12px 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .nav-container { max-width: 1200px; margin: 0 auto; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .nav-link { padding: 8px 16px; background: rgba(122,144,97,0.1); border: 1px solid var(--sage-200); border-radius: 20px; color: var(--sage-700); text-decoration: none; font-size: 0.9rem; transition: all 0.3s; font-weight: 500; }
        .nav-link:hover { background: rgba(122,144,97,0.2); border-color: var(--sage-400); }
        .nav-link.active { background: var(--sage-500); color: white; border-color: var(--sage-500); }

        .main-content { padding: 20px 15px; max-width: 1000px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 20px; padding-top: 20px; }
        h1 { font-family: 'Crimson Pro', serif; font-size: 2.5rem; font-weight: 400; color: var(--sage-700); letter-spacing: 1px; margin-bottom: 10px; }

        .section-toggle { display: flex; justify-content: center; gap: 8px; margin-bottom: 24px; }
        .toggle-btn { padding: 12px 24px; border: 2px solid var(--sage-300); border-radius: 25px; background: white; color: var(--sage-700); font-family: 'Karla', sans-serif; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .toggle-btn.active { background: var(--sage-500); color: white; border-color: var(--sage-500); }
        .toggle-btn:hover:not(.active) { background: var(--sage-100); }
        .section { display: none; }
        .section.active { display: block; }

        .btn { padding: 10px 20px; border: none; border-radius: 20px; cursor: pointer; font-weight: 600; font-family: 'Karla', sans-serif; transition: all 0.3s; font-size: 0.95rem; }
        .btn-primary { background: var(--sage-500); color: white; }
        .btn-primary:hover { background: var(--sage-600); }
        .btn-secondary { background: white; color: var(--sage-700); border: 2px solid var(--sage-300); }
        .btn-secondary:hover { background: var(--sage-100); }
        .btn-danger { background: var(--warning-red); color: white; }
        .btn-small { padding: 6px 14px; font-size: 0.85rem; }

        .category-filter { display: flex; gap: 6px; flex-wrap: wrap; }
        .filter-pill { padding: 6px 14px; border-radius: 15px; border: 1px solid var(--sage-200); background: white; font-size: 0.85rem; cursor: pointer; color: var(--sage-700); font-family: 'Karla', sans-serif; }
        .filter-pill.active { background: var(--sage-500); color: white; border-color: var(--sage-500); }

        /* Chores */
        .chore-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 8px; }
        .chore-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: white; border-radius: 10px; margin-bottom: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); border: 1px solid var(--sage-100); transition: all 0.2s; }
        .chore-item.completed { opacity: 0.6; background: var(--sage-50); }
        .chore-item.completed .chore-name { text-decoration: line-through; }
        .chore-checkbox { width: 22px; height: 22px; border-radius: 50%; border: 2px solid var(--sage-400); cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .chore-checkbox.checked { background: var(--sage-500); border-color: var(--sage-500); }
        .chore-checkbox.checked::after { content: '‚úì'; color: white; font-size: 14px; font-weight: bold; }
        .chore-info { flex: 1; cursor: pointer; }
        .chore-info:hover .chore-name { color: var(--sage-500); }
        .chore-name { font-weight: 600; font-size: 0.95rem; color: var(--sage-800); transition: color 0.2s; }
        .chore-meta { font-size: 0.8rem; color: var(--sage-600); margin-top: 2px; }
        .chore-badges { display: flex; gap: 4px; flex-shrink: 0; }
        .chore-category-badge { padding: 3px 10px; border-radius: 10px; font-size: 0.75rem; font-weight: 600; background: var(--sage-100); color: var(--sage-700); }
        .chore-sub-badge { padding: 3px 10px; border-radius: 10px; font-size: 0.75rem; font-weight: 600; background: #e8d5f5; color: #6b3fa0; }
        .chore-delete { background: none; border: none; color: var(--sage-400); cursor: pointer; font-size: 1.1rem; padding: 4px; opacity: 0.5; transition: all 0.2s; }
        .chore-delete:hover { color: var(--warning-red); opacity: 1; }

        /* Plant Tracker */
        .plant-group { margin-bottom: 24px; }
        .plant-group-header { font-family: 'Crimson Pro', serif; font-size: 1.4rem; color: var(--sage-700); padding: 8px 0; border-bottom: 2px solid var(--sage-300); margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .plant-card { background: white; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid var(--sage-100); overflow: hidden; }
        .plant-card-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; cursor: pointer; transition: background 0.2s; }
        .plant-card-header:hover { background: var(--sage-50); }
        .plant-variety-name { font-weight: 700; font-size: 1rem; color: var(--sage-800); }
        .plant-method-badge { padding: 3px 10px; border-radius: 10px; font-size: 0.75rem; font-weight: 600; }
        .badge-indoor { background: #e8d5f5; color: #6b3fa0; }
        .badge-direct { background: #d5ecd4; color: #2d6a2e; }
        .plant-card-body { display: none; padding: 0 16px 16px; border-top: 1px solid var(--sage-100); }
        .plant-card-body.open { display: block; }
        .milestone-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
        .milestone-item { display: flex; flex-direction: column; gap: 4px; }
        .milestone-label { font-size: 0.8rem; color: var(--sage-600); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .milestone-input { padding: 8px 10px; border: 1px solid var(--sage-200); border-radius: 8px; font-size: 0.9rem; font-family: 'Karla', sans-serif; color: var(--sage-800); background: var(--sage-50); width: 100%; }
        .milestone-input:focus { outline: none; border-color: var(--sage-400); background: white; }
        .notes-area { width: 100%; min-height: 60px; padding: 10px; border: 1px solid var(--sage-200); border-radius: 8px; font-family: 'Karla', sans-serif; font-size: 0.9rem; resize: vertical; color: var(--sage-800); background: var(--sage-50); }
        .notes-area:focus { outline: none; border-color: var(--sage-400); background: white; }

        /* Photos */
        .photo-section { margin-top: 16px; padding-top: 12px; border-top: 1px dashed var(--sage-200); }
        .photo-stage-tabs { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px; }
        .photo-tab { padding: 5px 12px; border-radius: 12px; border: 1px solid var(--sage-200); background: white; font-size: 0.8rem; cursor: pointer; color: var(--sage-700); font-family: 'Karla', sans-serif; }
        .photo-tab.active { background: var(--earth-warm); color: white; border-color: var(--earth-warm); }
        .photo-grid { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
        .photo-thumb { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; border: 2px solid var(--sage-200); cursor: pointer; }
        .photo-upload-btn { width: 80px; height: 80px; border-radius: 8px; border: 2px dashed var(--sage-300); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.5rem; color: var(--sage-400); transition: all 0.2s; }
        .photo-upload-btn:hover { border-color: var(--sage-500); color: var(--sage-500); background: var(--sage-50); }

        /* Harvest */
        .harvest-section { margin-top: 16px; padding-top: 12px; border-top: 1px dashed var(--sage-200); }
        .harvest-entry { display: flex; gap: 8px; align-items: center; padding: 6px 0; font-size: 0.85rem; border-bottom: 1px solid var(--sage-50); }
        .harvest-add-row { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
        .harvest-add-row input, .harvest-add-row select { padding: 6px 10px; border: 1px solid var(--sage-200); border-radius: 8px; font-family: 'Karla', sans-serif; font-size: 0.85rem; }
        .plant-actions { display: flex; gap: 8px; margin-top: 16px; padding-top: 12px; border-top: 1px dashed var(--sage-200); }

        /* Modals */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.open { display: flex; }
        .modal { background: white; border-radius: 16px; padding: 24px; max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal h2 { font-family: 'Crimson Pro', serif; font-size: 1.5rem; color: var(--sage-700); margin-bottom: 16px; }
        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--sage-600); margin-bottom: 4px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--sage-200); border-radius: 8px; font-family: 'Karla', sans-serif; font-size: 0.95rem; color: var(--sage-800); }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--sage-400); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px; }

        .year-selector { display: flex; align-items: center; gap: 12px; justify-content: center; margin-bottom: 20px; }
        .year-selector button { background: white; border: 1px solid var(--sage-300); border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1rem; color: var(--sage-700); display: flex; align-items: center; justify-content: center; }
        .year-selector span { font-family: 'Crimson Pro', serif; font-size: 1.3rem; color: var(--sage-700); font-weight: 600; }

        .lightbox { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 300; align-items: center; justify-content: center; padding: 20px; }
        .lightbox.open { display: flex; }
        .lightbox img { max-width: 90%; max-height: 90%; border-radius: 8px; }
        .lightbox-close { position: absolute; top: 20px; right: 20px; background: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.2rem; cursor: pointer; }

        .empty-state { text-align: center; padding: 40px 20px; color: var(--sage-400); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 12px; }

        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .section-toggle { flex-direction: column; align-items: center; }
            .toggle-btn { width: 80%; }
            .form-row { grid-template-columns: 1fr; }
            .milestone-grid { grid-template-columns: 1fr; }
            .nav-link { font-size: 0.8rem; padding: 6px 12px; }
        }
    </style>
</head>
<body>
    <img src="pond.jpeg" alt="Pond Banner" class="pond-banner">
    <nav>
        <div class="nav-container">
            <a href="index.html" class="nav-link">üè† Home</a>
            <a href="inventory.html" class="nav-link">ü´ô Inventory</a>
            <a href="shopping.html" class="nav-link">üõí Shopping</a>
            <a href="recipes.html" class="nav-link">üç≥ Recipes</a>
            <a href="meal-plan.html" class="nav-link">üìÖ Meals</a>
            <a href="expenses.html" class="nav-link">üí∞ Expenses</a>
            <a href="calendar.html" class="nav-link active">üå± Calendar</a>
        </div>
    </nav>

    <div class="main-content">
        <header><h1>üå± Homestead Calendar</h1></header>

        <div class="year-selector">
            <button onclick="changeYear(-1)">‚óÄ</button>
            <span id="current-year">2026</span>
            <button onclick="changeYear(1)">‚ñ∂</button>
        </div>

        <div class="section-toggle">
            <button class="toggle-btn active" onclick="switchSection('chores', this)">üßπ Homestead Chores</button>
            <button class="toggle-btn" onclick="switchSection('plants', this)">üåø Plant Tracker</button>
        </div>

        <!-- CHORES -->
        <div id="chores-section" class="section active">
            <div class="chore-header">
                <div class="category-filter" id="chore-filters"></div>
                <button class="btn btn-primary btn-small" onclick="openChoreModal()">+ Add Chore</button>
            </div>
            <div id="chores-list"></div>
        </div>

        <!-- PLANTS -->
        <div id="plants-section" class="section">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px;">
                <div class="category-filter" id="plant-filters"></div>
                <button class="btn btn-primary btn-small" onclick="openPlantModal()">+ Add Plant</button>
            </div>
            <div id="plants-list"></div>
        </div>
    </div>

    <!-- Chore Modal (Add + Edit) -->
    <div class="modal-overlay" id="chore-modal">
        <div class="modal">
            <h2 id="chore-modal-title">Add Chore</h2>
            <input type="hidden" id="chore-edit-id">
            <div class="form-group">
                <label>Task</label>
                <input type="text" id="chore-task" placeholder="e.g. Set up greenhouse">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Category</label>
                    <select id="chore-category">
                        <option value="General">General</option>
                        <option value="Greenhouse">Greenhouse</option>
                        <option value="Poultry">Poultry</option>
                        <option value="Brooder">Brooder</option>
                        <option value="Garden Prep">Garden Prep</option>
                        <option value="Maintenance">Maintenance</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Subcategory (optional)</label>
                    <select id="chore-subcategory">
                        <option value="">None</option>
                        <option value="Chickens">Chickens</option>
                        <option value="Ducks">Ducks</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Due Date (optional)</label>
                    <input type="date" id="chore-due">
                </div>
                <div class="form-group">
                    <label>Completion Date</label>
                    <input type="date" id="chore-completion">
                </div>
            </div>
            <div class="form-group">
                <label>Notes (optional)</label>
                <textarea id="chore-notes" rows="2" placeholder="Your notes..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-danger btn-small" id="chore-delete-btn" style="margin-right:auto;display:none;" onclick="deleteChoreFromModal()">Delete</button>
                <button class="btn btn-secondary" onclick="closeChoreModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveChore()">Save</button>
            </div>
        </div>
    </div>

    <!-- Plant Modal -->
    <div class="modal-overlay" id="plant-modal">
        <div class="modal">
            <h2>Add Plant Entry</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Plant Type</label>
                    <input type="text" id="plant-type" list="plant-types" placeholder="e.g. Tomato">
                    <datalist id="plant-types">
                        <option value="Tomato"><option value="Pepper"><option value="Eggplant">
                        <option value="Cucumber"><option value="Bean"><option value="Potato">
                        <option value="Sweet Potato"><option value="Herb"><option value="Broccoli">
                        <option value="Brussels Sprouts"><option value="Onion"><option value="Carrot">
                        <option value="Corn"><option value="Watermelon"><option value="Pumpkin">
                        <option value="Strawberry"><option value="Tomatillo">
                    </datalist>
                </div>
                <div class="form-group">
                    <label>Variety</label>
                    <input type="text" id="plant-variety" placeholder="e.g. San Marzano II">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Grow Method</label>
                    <select id="plant-method">
                        <option value="indoor_start">üè† Indoor Start</option>
                        <option value="direct_sow">üåæ Direct Sow</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Planned Plant Count</label>
                    <input type="number" id="plant-planned" placeholder="How many you want">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closePlantModal()">Cancel</button>
                <button class="btn btn-primary" onclick="savePlant()">Add Plant</button>
            </div>
        </div>
    </div>

    <!-- Lightbox -->
    <div class="lightbox" id="lightbox" onclick="closeLightbox()">
        <button class="lightbox-close" onclick="closeLightbox()">‚úï</button>
        <img id="lightbox-img" src="">
    </div>

    <script>
        const SUPABASE_URL = 'https://jzpipxvxrtdhmsdkveog.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp6cGlweHZ4cnRkaG1zZGt2ZW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NTE1MjUsImV4cCI6MjA4NTMyNzUyNX0.7mm0ts91y0leGKLFCgRk6KJitah3V5WJZdiD_gHL57o';
        const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentYear = new Date().getFullYear();
        let choreFilter = 'All';
        let plantFilter = 'All';
        let allChores = [];
        let allPlants = [];
        let allPhotos = {};
        let allHarvests = {};

        // === SECTION SWITCHING ===
        function switchSection(section, btn) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(section + '-section').classList.add('active');
            btn.classList.add('active');
        }

        function changeYear(delta) {
            currentYear += delta;
            document.getElementById('current-year').textContent = currentYear;
            loadChores();
            loadPlants();
        }

        // === CHORES ===
        async function loadChores() {
            const { data } = await db.from('homestead_chores').select('*')
                .eq('year', currentYear)
                .order('completed').order('due_date', { ascending: true, nullsFirst: false }).order('sort_order');
            allChores = data || [];
            renderChoreFilters();
            renderChores();
        }

        function renderChoreFilters() {
            const cats = ['All', ...new Set(allChores.map(c => c.category))];
            document.getElementById('chore-filters').innerHTML = cats.map(c =>
                `<button class="filter-pill ${c === choreFilter ? 'active' : ''}" onclick="choreFilter='${c}';renderChoreFilters();renderChores();">${c}</button>`
            ).join('');
        }

        function renderChores() {
            const filtered = choreFilter === 'All' ? allChores : allChores.filter(c => c.category === choreFilter);
            if (!filtered.length) {
                document.getElementById('chores-list').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üßπ</div><div>No chores yet. Add your first task!</div></div>';
                return;
            }
            document.getElementById('chores-list').innerHTML = filtered.map(c => `
                <div class="chore-item ${c.completed ? 'completed' : ''}">
                    <div class="chore-checkbox ${c.completed ? 'checked' : ''}" onclick="toggleChore('${c.id}',${!c.completed})"></div>
                    <div class="chore-info" onclick="editChore('${c.id}')">
                        <div class="chore-name">${c.task}</div>
                        <div class="chore-meta">
                            ${c.due_date ? 'üìÖ ' + formatDate(c.due_date) : ''}
                            ${c.completion_date ? ' ‚úÖ ' + formatDate(c.completion_date) : ''}
                            ${c.notes ? ' ¬∑ ' + c.notes : ''}
                        </div>
                    </div>
                    <div class="chore-badges">
                        <span class="chore-category-badge">${c.category}</span>
                        ${c.subcategory ? `<span class="chore-sub-badge">${c.subcategory}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function toggleChore(id, completed) {
            const updates = { completed };
            updates.completion_date = completed ? new Date().toISOString().split('T')[0] : null;
            await db.from('homestead_chores').update(updates).eq('id', id);
            loadChores();
        }

        function openChoreModal(chore = null) {
            document.getElementById('chore-modal').classList.add('open');
            document.getElementById('chore-edit-id').value = chore ? chore.id : '';
            document.getElementById('chore-modal-title').textContent = chore ? 'Edit Chore' : 'Add Chore';
            document.getElementById('chore-task').value = chore ? chore.task : '';
            document.getElementById('chore-category').value = chore ? chore.category : 'General';
            document.getElementById('chore-subcategory').value = chore ? (chore.subcategory || '') : '';
            document.getElementById('chore-due').value = chore ? (chore.due_date || '') : '';
            document.getElementById('chore-completion').value = chore ? (chore.completion_date || '') : '';
            document.getElementById('chore-notes').value = chore ? (chore.notes || '') : '';
            document.getElementById('chore-delete-btn').style.display = chore ? 'block' : 'none';
            document.getElementById('chore-task').focus();
        }

        function editChore(id) {
            const chore = allChores.find(c => c.id === id);
            if (chore) openChoreModal(chore);
        }

        function closeChoreModal() { document.getElementById('chore-modal').classList.remove('open'); }

        async function saveChore() {
            const task = document.getElementById('chore-task').value.trim();
            if (!task) { alert('Please enter a task'); return; }
            const editId = document.getElementById('chore-edit-id').value;
            const chore = {
                task,
                category: document.getElementById('chore-category').value,
                subcategory: document.getElementById('chore-subcategory').value || null,
                due_date: document.getElementById('chore-due').value || null,
                completion_date: document.getElementById('chore-completion').value || null,
                completed: !!document.getElementById('chore-completion').value,
                notes: document.getElementById('chore-notes').value.trim() || null,
                year: currentYear
            };
            if (editId) {
                await db.from('homestead_chores').update(chore).eq('id', editId);
            } else {
                await db.from('homestead_chores').insert(chore);
            }
            closeChoreModal();
            loadChores();
        }

        async function deleteChoreFromModal() {
            const id = document.getElementById('chore-edit-id').value;
            if (!id || !confirm('Delete this chore?')) return;
            await db.from('homestead_chores').delete().eq('id', id);
            closeChoreModal();
            loadChores();
        }

        // === PLANTS ===
        async function loadPlants() {
            const { data } = await db.from('plant_entries').select('*')
                .eq('year', currentYear).order('plant_type').order('variety');
            allPlants = data || [];
            const ids = allPlants.map(p => p.id);
            allPhotos = {}; allHarvests = {};
            if (ids.length) {
                const { data: photos } = await db.from('plant_photos').select('*').in('plant_entry_id', ids).order('taken_date', { ascending: false });
                (photos || []).forEach(p => { if (!allPhotos[p.plant_entry_id]) allPhotos[p.plant_entry_id] = []; allPhotos[p.plant_entry_id].push(p); });
                const { data: harvests } = await db.from('harvest_log').select('*').in('plant_entry_id', ids).order('harvest_date', { ascending: false });
                (harvests || []).forEach(h => { if (!allHarvests[h.plant_entry_id]) allHarvests[h.plant_entry_id] = []; allHarvests[h.plant_entry_id].push(h); });
            }
            renderPlantFilters();
            renderPlants();
        }

        function renderPlantFilters() {
            const types = ['All', ...new Set(allPlants.map(p => p.plant_type))];
            document.getElementById('plant-filters').innerHTML = types.map(t =>
                `<button class="filter-pill ${t === plantFilter ? 'active' : ''}" onclick="plantFilter='${t}';renderPlantFilters();renderPlants();">${t}</button>`
            ).join('');
        }

        function renderPlants() {
            const filtered = plantFilter === 'All' ? allPlants : allPlants.filter(p => p.plant_type === plantFilter);
            if (!filtered.length) {
                document.getElementById('plants-list').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üåø</div><div>No plants tracked yet!</div></div>';
                return;
            }
            const grouped = {};
            filtered.forEach(p => { if (!grouped[p.plant_type]) grouped[p.plant_type] = []; grouped[p.plant_type].push(p); });
            let html = '';
            Object.entries(grouped).forEach(([type, plants]) => {
                html += `<div class="plant-group"><div class="plant-group-header"><span>${getEmoji(type)} ${type}</span><span style="font-size:0.85rem;color:var(--sage-500);">${plants.length} ${plants.length === 1 ? 'variety' : 'varieties'}</span></div>`;
                plants.forEach(p => { html += renderPlantCard(p); });
                html += '</div>';
            });
            document.getElementById('plants-list').innerHTML = html;
        }

        function renderPlantCard(p) {
            const indoor = p.grow_method === 'indoor_start';
            const photos = allPhotos[p.id] || [];
            const harvests = allHarvests[p.id] || [];
            return `
            <div class="plant-card">
                <div class="plant-card-header" onclick="document.getElementById('body-${p.id}').classList.toggle('open')">
                    <div><span class="plant-variety-name">${p.variety}</span>
                    <span class="plant-method-badge ${indoor ? 'badge-indoor' : 'badge-direct'}">${indoor ? 'üè† Indoor' : 'üåæ Direct Sow'}</span></div>
                    <span style="color:var(--sage-400)">‚ñº</span>
                </div>
                <div class="plant-card-body" id="body-${p.id}">
                    <div class="milestone-grid" style="margin-top:12px">
                        <div class="milestone-item"><span class="milestone-label">Seeds Sowed</span>
                            <input type="number" class="milestone-input" value="${p.seeds_sowed||''}" placeholder="‚Äî" onchange="up('${p.id}','seeds_sowed',this.value?parseInt(this.value):null)"></div>
                        <div class="milestone-item"><span class="milestone-label">Plant Count</span>
                            <input type="number" class="milestone-input" value="${p.plant_count||''}" placeholder="‚Äî" onchange="up('${p.id}','plant_count',this.value?parseInt(this.value):null)"></div>
                        <div class="milestone-item"><span class="milestone-label">Planned Count</span>
                            <input type="number" class="milestone-input" value="${p.planned_count||''}" placeholder="‚Äî" onchange="up('${p.id}','planned_count',this.value?parseInt(this.value):null)"></div>
                        <div class="milestone-item"><span class="milestone-label">Survival Count</span>
                            <input type="number" class="milestone-input" value="${p.survival_count||''}" placeholder="‚Äî" onchange="up('${p.id}','survival_count',this.value?parseInt(this.value):null)"></div>
                    </div>
                    <div style="margin-top:16px"><div class="milestone-label" style="margin-bottom:8px;font-size:0.9rem">üìÖ Milestone Dates</div>
                        <div class="milestone-grid">
                            ${indoor ? indoorMilestones(p) : directMilestones(p)}
                            <div class="milestone-item"><span class="milestone-label">Germination</span>
                                <input type="date" class="milestone-input" value="${p.germination_date||''}" onchange="up('${p.id}','germination_date',this.value||null)"></div>
                        </div>
                    </div>
                    <div style="margin-top:16px"><div class="milestone-label" style="margin-bottom:6px">General Notes</div>
                        <textarea class="notes-area" placeholder="Notes..." onchange="up('${p.id}','general_notes',this.value||null)">${p.general_notes||''}</textarea></div>
                    <div style="margin-top:10px"><div class="milestone-label" style="margin-bottom:6px">üêõ Pest / Disease Notes</div>
                        <textarea class="notes-area" placeholder="Pest issues..." onchange="up('${p.id}','pest_notes',this.value||null)">${p.pest_notes||''}</textarea></div>
                    <div class="photo-section">
                        <div class="milestone-label" style="margin-bottom:8px">üì∑ Photos</div>
                        <div class="photo-stage-tabs">${['germination','potup','growing','harvest','pest_disease'].map(s =>
                            `<button class="photo-tab" onclick="selStage('${p.id}','${s}',this)">${stageLabel(s)} ${photos.filter(x=>x.stage===s).length>0?'('+photos.filter(x=>x.stage===s).length+')':''}</button>`).join('')}</div>
                        <div class="photo-grid" id="photos-${p.id}"><div class="photo-upload-btn" onclick="upPhoto('${p.id}')">+</div></div>
                        <input type="file" id="file-${p.id}" accept="image/*" style="display:none" onchange="handleUpload('${p.id}',this)">
                    </div>
                    <div class="harvest-section">
                        <div class="milestone-label" style="margin-bottom:8px">ü•ï Harvest Log</div>
                        ${harvests.map(h=>`<div class="harvest-entry"><span>${formatDate(h.harvest_date)}</span><strong>${h.amount} ${h.unit}</strong><span style="color:var(--sage-500)">${h.notes||''}</span><button class="chore-delete" onclick="delHarvest('${h.id}')" style="margin-left:auto">üóë</button></div>`).join('')}
                        <div class="harvest-add-row">
                            <input type="date" id="hd-${p.id}" value="${new Date().toISOString().split('T')[0]}">
                            <input type="number" id="ha-${p.id}" placeholder="Amt" style="width:70px" step="0.1">
                            <select id="hu-${p.id}"><option value="lbs">lbs</option><option value="oz">oz</option><option value="count">count</option></select>
                            <input type="text" id="hn-${p.id}" placeholder="Notes" style="flex:1;min-width:60px">
                            <button class="btn btn-primary btn-small" onclick="addHarvest('${p.id}')">+</button>
                        </div>
                    </div>
                    <div class="plant-actions"><button class="btn btn-danger btn-small" onclick="delPlant('${p.id}')">Delete Plant</button></div>
                </div>
            </div>`;
        }

        function indoorMilestones(p) {
            return `
                <div class="milestone-item"><span class="milestone-label">Suggested Sow Date</span><input type="date" class="milestone-input" value="${p.suggested_sow_date||''}" onchange="up('${p.id}','suggested_sow_date',this.value||null)"></div>
                <div class="milestone-item"><span class="milestone-label">Actual Sow Date</span><input type="date" class="milestone-input" value="${p.actual_sow_date||''}" onchange="up('${p.id}','actual_sow_date',this.value||null)"></div>
                <div class="milestone-item"><span class="milestone-label">Pot-up Date</span><input type="date" class="milestone-input" value="${p.potup_date||''}" onchange="up('${p.id}','potup_date',this.value||null)"></div>
                <div class="milestone-item"><span class="milestone-label">Greenhouse Start</span><input type="date" class="milestone-input" value="${p.greenhouse_window_start||''}" onchange="up('${p.id}','greenhouse_window_start',this.value||null)"></div>
                <div class="milestone-item"><span class="milestone-label">Greenhouse End</span><input type="date" class="milestone-input" value="${p.greenhouse_window_end||''}" onchange="up('${p.id}','greenhouse_window_end',this.value||null)"></div>
                <div class="milestone-item"><span class="milestone-label">Hardening Date</span><input type="date" class="milestone-input" value="${p.hardening_date||''}" onchange="up('${p.id}','hardening_date',this.value||null)"></div>
                <div class="milestone-item"><span class="milestone-label">Transplant Outdoors</span><input type="date" class="milestone-input" value="${p.transplant_outdoor_date||''}" onchange="up('${p.id}','transplant_outdoor_date',this.value||null)"></div>`;
        }

        function directMilestones(p) {
            return `
                <div class="milestone-item"><span class="milestone-label">Suggested Sow Date</span><input type="date" class="milestone-input" value="${p.suggested_direct_sow_date||''}" onchange="up('${p.id}','suggested_direct_sow_date',this.value||null)"></div>
                <div class="milestone-item"><span class="milestone-label">Actual Sow Date</span><input type="date" class="milestone-input" value="${p.sow_date||''}" onchange="up('${p.id}','sow_date',this.value||null)"></div>
                <div class="milestone-item"><span class="milestone-label">Thinning Date</span><input type="date" class="milestone-input" value="${p.thinning_date||''}" onchange="up('${p.id}','thinning_date',this.value||null)"></div>
                <div class="milestone-item"><span class="milestone-label">Garden Location</span><input type="text" class="milestone-input" value="${p.garden_location||''}" placeholder="e.g. Bed 3" onchange="up('${p.id}','garden_location',this.value||null)"></div>`;
        }

        // === CRUD helpers ===
        async function up(id, field, val) { await db.from('plant_entries').update({[field]:val}).eq('id',id); }

        function openPlantModal() {
            document.getElementById('plant-modal').classList.add('open');
            document.getElementById('plant-type').value = '';
            document.getElementById('plant-variety').value = '';
            document.getElementById('plant-method').value = 'indoor_start';
            document.getElementById('plant-planned').value = '';
            document.getElementById('plant-type').focus();
        }
        function closePlantModal() { document.getElementById('plant-modal').classList.remove('open'); }

        async function savePlant() {
            const t = document.getElementById('plant-type').value.trim();
            const v = document.getElementById('plant-variety').value.trim();
            if (!t||!v) { alert('Please enter type and variety'); return; }
            await db.from('plant_entries').insert({ plant_type:t, variety:v, grow_method:document.getElementById('plant-method').value, planned_count:document.getElementById('plant-planned').value?parseInt(document.getElementById('plant-planned').value):null, year:currentYear });
            closePlantModal();
            loadPlants();
        }

        async function delPlant(id) { if(confirm('Delete this plant and all photos/harvests?')){await db.from('plant_entries').delete().eq('id',id);loadPlants();}}

        // === Photos ===
        let photoStage = {};
        function selStage(pid,stage,btn) {
            photoStage[pid]=stage;
            btn.parentElement.querySelectorAll('.photo-tab').forEach(t=>t.classList.remove('active'));
            btn.classList.add('active');
            const photos=(allPhotos[pid]||[]).filter(p=>p.stage===stage);
            document.getElementById('photos-'+pid).innerHTML = photos.map(p=>`<img src="${p.photo_url}" class="photo-thumb" onclick="openLB('${p.photo_url}')">`).join('') + `<div class="photo-upload-btn" onclick="upPhoto('${pid}')">+</div>`;
        }
        function upPhoto(pid) { if(!photoStage[pid]){alert('Select a photo stage first');return;} document.getElementById('file-'+pid).click(); }
        async function handleUpload(pid,input) {
            const file=input.files[0]; if(!file)return;
            const stage=photoStage[pid];
            const name=`${pid}/${stage}/${Date.now()}_${file.name}`;
            const {error}=await db.storage.from('plant-photos').upload(name,file);
            if(error){alert('Upload failed. Check storage bucket setup.');return;}
            const {data:u}=db.storage.from('plant-photos').getPublicUrl(name);
            await db.from('plant_photos').insert({plant_entry_id:pid,stage,photo_url:u.publicUrl,taken_date:new Date().toISOString().split('T')[0]});
            input.value='';loadPlants();
        }
        function openLB(url){document.getElementById('lightbox-img').src=url;document.getElementById('lightbox').classList.add('open');}
        function closeLightbox(){document.getElementById('lightbox').classList.remove('open');}

        // === Harvest ===
        async function addHarvest(pid) {
            const amt=document.getElementById('ha-'+pid).value; if(!amt){alert('Enter amount');return;}
            await db.from('harvest_log').insert({plant_entry_id:pid,harvest_date:document.getElementById('hd-'+pid).value,amount:parseFloat(amt),unit:document.getElementById('hu-'+pid).value,notes:document.getElementById('hn-'+pid).value||null});
            loadPlants();
        }
        async function delHarvest(id){await db.from('harvest_log').delete().eq('id',id);loadPlants();}

        // === Helpers ===
        function formatDate(d){if(!d)return '';const dt=new Date(d+'T12:00:00');return dt.toLocaleDateString('en-US',{month:'short',day:'numeric'});}
        function getEmoji(t){return{'Tomato':'üçÖ','Pepper':'üå∂Ô∏è','Eggplant':'üçÜ','Cucumber':'ü•í','Bean':'ü´ò','Potato':'ü•î','Sweet Potato':'üç†','Herb':'üåø','Broccoli':'ü•¶','Brussels Sprouts':'ü•¨','Onion':'üßÖ','Carrot':'ü•ï','Corn':'üåΩ','Watermelon':'üçâ','Pumpkin':'üéÉ','Strawberry':'üçì','Tomatillo':'üü¢'}[t]||'üå±';}
        function stageLabel(s){return{'germination':'üå± Sprout','potup':'ü™¥ Pot-up','growing':'üåø Growing','harvest':'ü•ï Harvest','pest_disease':'üêõ Pests'}[s]||s;}

        document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeChoreModal();closePlantModal();closeLightbox();}});
        document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));

        loadChores();
        loadPlants();
    </script>
</body>
</html>
